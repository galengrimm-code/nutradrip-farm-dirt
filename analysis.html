<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soil Sample Analysis - Analysis</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; }
    .app-container { display: flex; flex-direction: column; min-height: 100vh; }
    .top-bar { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .top-bar h1 { font-size: 1.5rem; font-weight: 700; }
    .top-bar p { font-size: 0.875rem; opacity: 0.8; margin-top: 0.25rem; }
    .nav-links { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .nav-link { padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; }
    .nav-link:hover { background: rgba(255,255,255,0.2); }
    .nav-link.active { background: #3b82f6; }
    .auth-section { display: flex; align-items: center; gap: 1rem; }
    .user-info { font-size: 0.875rem; color: rgba(255,255,255,0.9); }
    .sign-in-btn { padding: 0.5rem 1rem; background: #4285f4; color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; }
    .sign-in-btn.signed-in { background: #22c55e; }
    
    .analysis-container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
    
    .controls-bar { background: white; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: flex-end; }
    .control-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .control-group label { font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; }
    .control-group select { padding: 0.5rem 0.75rem; font-size: 0.875rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; min-width: 140px; }
    
    .nutrient-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; }
    
    .nutrient-card { background: white; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #94a3b8; }
    .nutrient-card.positive { border-left-color: #22c55e; background: linear-gradient(to right, #f0fdf4, white); }
    .nutrient-card.negative { border-left-color: #ef4444; background: linear-gradient(to right, #fef2f2, white); }
    .nutrient-card.neutral { border-left-color: #94a3b8; }
    
    .nutrient-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .nutrient-name { font-size: 1rem; font-weight: 700; color: #1e293b; }
    .nutrient-change { font-size: 1.125rem; font-weight: 700; }
    .nutrient-change.positive { color: #22c55e; }
    .nutrient-change.negative { color: #ef4444; }
    .nutrient-change.neutral { color: #64748b; }
    
    .nutrient-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 0.75rem; }
    .stat-box { background: #f8fafc; border-radius: 0.375rem; padding: 0.5rem; text-align: center; }
    .stat-box .label { font-size: 0.625rem; font-weight: 600; color: #64748b; text-transform: uppercase; margin-bottom: 0.125rem; }
    .stat-box .value { font-size: 1rem; font-weight: 700; color: #1e293b; }
    
    .year-comparison { display: flex; justify-content: space-between; align-items: center; background: #f1f5f9; border-radius: 0.375rem; padding: 0.5rem 0.75rem; }
    .year-value { text-align: center; }
    .year-value .year { font-size: 0.625rem; font-weight: 600; color: #64748b; text-transform: uppercase; }
    .year-value .val { font-size: 1.125rem; font-weight: 700; color: #1e293b; }
    .year-arrow { font-size: 1.25rem; color: #94a3b8; }
    .year-arrow.positive { color: #22c55e; }
    .year-arrow.negative { color: #ef4444; }
    
    .change-details { display: flex; justify-content: center; gap: 1.5rem; margin-top: 0.5rem; font-size: 0.75rem; color: #64748b; }
    .change-details span { display: flex; align-items: center; gap: 0.25rem; }
    .change-details .change-value { font-weight: 600; }
    .change-details .change-value.positive { color: #22c55e; }
    .change-details .change-value.negative { color: #ef4444; }
    
    .no-data { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 0.5rem; padding: 2rem; text-align: center; color: #92400e; }
    #statusMessage { display: none; position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 0.75rem 1rem; border-radius: 0.375rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    
    @media (max-width: 639px) {
      .nutrient-grid { grid-template-columns: 1fr; }
      .controls-bar { flex-direction: column; align-items: stretch; }
      .control-group select { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="top-bar">
      <div>
        <h1>üìä Year Comparison</h1>
        <p>Compare soil nutrients across years</p>
      </div>
      <nav class="nav-links">
        <a href="index.html" class="nav-link">üìç Map</a>
        <a href="analysis.html" class="nav-link active">üìä Analysis</a>
        <a href="import.html" class="nav-link">üìÅ Import</a>
        <a href="settings.html" class="nav-link">‚öôÔ∏è Settings</a>
      </nav>
      <div class="auth-section">
        <span class="user-info" id="userInfo"></span>
        <button class="sign-in-btn" id="authBtn" onclick="handleAuth()">Sign In with Google</button>
      </div>
    </div>
    
    <div class="analysis-container">
      <div class="controls-bar">
        <div class="control-group">
          <label>Field</label>
          <select id="fieldSelect">
            <option value="all">All Fields (Operation Average)</option>
          </select>
        </div>
        <div class="control-group">
          <label>Compare Year</label>
          <select id="year1Select"></select>
        </div>
        <div class="control-group">
          <label>To Year</label>
          <select id="year2Select"></select>
        </div>
      </div>
      
      <div id="nutrientGrid" class="nutrient-grid">
        <div class="no-data">Loading data...</div>
      </div>
    </div>
  </div>
  
  <div id="statusMessage"></div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script>
    const CONFIG = {
      CLIENT_ID: '714780458094-9rde31taeottmavhl5t0uo8b9kfpergc.apps.googleusercontent.com',
      API_KEY: 'AIzaSyCOSDbrAlc3ct2-lRvJv1y7V0nV7haWc9E',
      SHEET_ID: '1buu-8KXoM1kRJSOAWtHaAk40seQT5kqGFY9RICYwdRY',
      
      NUTRIENTS: ['pH', 'P', 'K', 'OM', 'CEC', 'Ca_sat', 'Mg_sat', 'K_Sat', 'H_Sat', 'Zn', 'Cu', 'Mn', 'Fe', 'Boron', 'S', 'Buffer_pH'],
      
      NUTRIENT_NAMES: {
        pH: 'pH', P: 'Phosphorus (P)', K: 'Potassium (K)', OM: 'Organic Matter',
        CEC: 'CEC', Ca_sat: 'Calcium Sat %', Mg_sat: 'Magnesium Sat %',
        K_Sat: 'K Base Sat %', H_Sat: 'H Base Sat %', Zn: 'Zinc', Cu: 'Copper',
        Mn: 'Manganese', Fe: 'Iron', Boron: 'Boron', S: 'Sulfur', Buffer_pH: 'Buffer pH'
      },
      
      NUTRIENT_UNITS: {
        pH: '', P: 'ppm', K: 'ppm', OM: '%', CEC: 'meq/100g',
        Ca_sat: '%', Mg_sat: '%', K_Sat: '%', H_Sat: '%',
        Zn: 'ppm', Cu: 'ppm', Mn: 'ppm', Fe: 'ppm', Boron: 'ppm', S: 'ppm', Buffer_pH: ''
      },
      
      // Nutrients where lower values are better
      LOWER_IS_BETTER: ['Mg_sat', 'H_Sat']
    };

    let tokenClient, accessToken = null, tokenExpiry = null;
    let sampleData = [], selectedField = 'all', year1 = null, year2 = null;
    
    const SheetsAPI = {
      isSignedIn: false,
      async init() {
        return new Promise((resolve, reject) => {
          gapi.load('client', async () => {
            try {
              await gapi.client.init({ apiKey: CONFIG.API_KEY, discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
              tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (response) => {
                  if (response.error) return;
                  accessToken = response.access_token;
                  tokenExpiry = Date.now() + (response.expires_in * 1000) - 60000;
                  localStorage.setItem('googleAccessToken', accessToken);
                  localStorage.setItem('googleTokenExpiry', tokenExpiry.toString());
                  this.isSignedIn = true;
                  this.onSignInChange(true);
                },
              });
              const savedToken = localStorage.getItem('googleAccessToken');
              const savedExpiry = localStorage.getItem('googleTokenExpiry');
              if (savedToken && savedExpiry && Date.now() < parseInt(savedExpiry)) {
                accessToken = savedToken;
                tokenExpiry = parseInt(savedExpiry);
                gapi.client.setToken({ access_token: accessToken });
                this.isSignedIn = true;
                this.onSignInChange(true);
              }
              resolve(true);
            } catch (e) { reject(e); }
          });
        });
      },
      async signIn() { tokenClient.requestAccessToken({ prompt: 'consent' }); },
      async signOut() { 
        if (accessToken) google.accounts.oauth2.revoke(accessToken);
        accessToken = null; tokenExpiry = null;
        localStorage.removeItem('googleAccessToken');
        localStorage.removeItem('googleTokenExpiry');
        this.isSignedIn = false;
        this.onSignInChange(false);
      },
      onSignInChange(s) {}
    };

    document.addEventListener('DOMContentLoaded', async () => {
      try { await SheetsAPI.init(); SheetsAPI.onSignInChange = handleSignInChange; handleSignInChange(SheetsAPI.isSignedIn); } catch (e) {}
      loadLocalData();
      setupEventListeners();
    });

    async function handleAuth() { if (SheetsAPI.isSignedIn) await SheetsAPI.signOut(); else await SheetsAPI.signIn(); }
    
    function handleSignInChange(isSignedIn) {
      const authBtn = document.getElementById('authBtn'), userInfo = document.getElementById('userInfo');
      if (isSignedIn) { userInfo.textContent = 'Connected'; authBtn.textContent = '‚úì Signed In'; authBtn.classList.add('signed-in'); }
      else { userInfo.textContent = ''; authBtn.textContent = 'Sign In with Google'; authBtn.classList.remove('signed-in'); }
    }

    function loadLocalData() {
      try {
        const saved = localStorage.getItem('soilSamples');
        if (saved) sampleData = JSON.parse(saved);
      } catch (e) {}
      populateSelectors();
      updateDisplay();
    }

    function populateSelectors() {
      // Fields
      const fieldSelect = document.getElementById('fieldSelect');
      const fields = [...new Set(sampleData.map(s => s.field).filter(f => f && f !== 'Unknown'))].sort();
      fieldSelect.innerHTML = '<option value="all">All Fields (Operation Average)</option>';
      fields.forEach(f => { fieldSelect.innerHTML += `<option value="${f}">${f}</option>`; });
      
      // Years
      const years = [...new Set(sampleData.map(s => s.year).filter(y => y))].sort((a, b) => b - a);
      const year1Select = document.getElementById('year1Select');
      const year2Select = document.getElementById('year2Select');
      
      year1Select.innerHTML = '';
      year2Select.innerHTML = '';
      
      years.forEach((y, i) => {
        year1Select.innerHTML += `<option value="${y}" ${i === 0 ? 'selected' : ''}>${y}</option>`;
        year2Select.innerHTML += `<option value="${y}" ${i === 1 ? 'selected' : ''}>${y}</option>`;
      });
      
      year1 = years[0] || null;
      year2 = years[1] || years[0] || null;
    }

    function setupEventListeners() {
      document.getElementById('fieldSelect').addEventListener('change', (e) => { selectedField = e.target.value; updateDisplay(); });
      document.getElementById('year1Select').addEventListener('change', (e) => { year1 = e.target.value; updateDisplay(); });
      document.getElementById('year2Select').addEventListener('change', (e) => { year2 = e.target.value; updateDisplay(); });
    }

    function getStats(samples, attr) {
      const values = samples.map(s => s[attr]).filter(v => v !== undefined && v !== null && !isNaN(v));
      if (values.length === 0) return null;
      const sum = values.reduce((a, b) => a + b, 0);
      return {
        avg: sum / values.length,
        high: Math.max(...values),
        low: Math.min(...values),
        count: values.length
      };
    }

    function updateDisplay() {
      const grid = document.getElementById('nutrientGrid');
      
      if (!year1 || sampleData.length === 0) {
        grid.innerHTML = '<div class="no-data">No data available. Import soil samples to see analysis.</div>';
        return;
      }
      
      // Filter samples by field
      let samples = sampleData;
      if (selectedField !== 'all') {
        samples = samples.filter(s => s.field === selectedField);
      }
      
      // Get samples for each year
      const samples1 = samples.filter(s => String(s.year) === String(year1));
      const samples2 = year2 ? samples.filter(s => String(s.year) === String(year2)) : [];
      
      if (samples1.length === 0) {
        grid.innerHTML = `<div class="no-data">No samples found for ${year1}</div>`;
        return;
      }
      
      let html = '';
      
      CONFIG.NUTRIENTS.forEach(attr => {
        const stats1 = getStats(samples1, attr);
        const stats2 = year2 ? getStats(samples2, attr) : null;
        
        if (!stats1) return; // Skip if no data for this nutrient
        
        const name = CONFIG.NUTRIENT_NAMES[attr] || attr;
        const unit = CONFIG.NUTRIENT_UNITS[attr] || '';
        const decimals = (attr === 'pH' || attr === 'Buffer_pH') ? 2 : 1;
        const isLowerBetter = CONFIG.LOWER_IS_BETTER.includes(attr);
        
        // Calculate change
        let pointChange = 0, pctChange = 0, cardClass = 'neutral', changeClass = 'neutral', arrowClass = '';
        
        if (stats2 && stats2.avg) {
          pointChange = stats1.avg - stats2.avg;
          pctChange = stats2.avg !== 0 ? (pointChange / stats2.avg) * 100 : 0;
          
          // Determine if change is good or bad
          const isPositive = isLowerBetter ? pointChange < 0 : pointChange > 0;
          const isSignificant = Math.abs(pctChange) > 2;
          
          if (isSignificant) {
            cardClass = isPositive ? 'positive' : 'negative';
            changeClass = isPositive ? 'positive' : 'negative';
            arrowClass = isPositive ? 'positive' : 'negative';
          }
        }
        
        html += `
          <div class="nutrient-card ${cardClass}">
            <div class="nutrient-header">
              <span class="nutrient-name">${name}</span>
              ${stats2 ? `<span class="nutrient-change ${changeClass}">${pctChange >= 0 ? '+' : ''}${pctChange.toFixed(1)}%</span>` : ''}
            </div>
            
            <div class="nutrient-stats">
              <div class="stat-box">
                <div class="label">Average</div>
                <div class="value">${stats1.avg.toFixed(decimals)}${unit ? ' ' + unit : ''}</div>
              </div>
              <div class="stat-box">
                <div class="label">High</div>
                <div class="value">${stats1.high.toFixed(decimals)}</div>
              </div>
              <div class="stat-box">
                <div class="label">Low</div>
                <div class="value">${stats1.low.toFixed(decimals)}</div>
              </div>
            </div>
            
            ${stats2 ? `
              <div class="year-comparison">
                <div class="year-value">
                  <div class="year">${year2}</div>
                  <div class="val">${stats2.avg.toFixed(decimals)}</div>
                </div>
                <div class="year-arrow ${arrowClass}">${pointChange >= 0 ? '‚Üí' : '‚Üí'}</div>
                <div class="year-value">
                  <div class="year">${year1}</div>
                  <div class="val">${stats1.avg.toFixed(decimals)}</div>
                </div>
              </div>
              <div class="change-details">
                <span>Point Change: <span class="change-value ${changeClass}">${pointChange >= 0 ? '+' : ''}${pointChange.toFixed(decimals)}</span></span>
                <span>% Change: <span class="change-value ${changeClass}">${pctChange >= 0 ? '+' : ''}${pctChange.toFixed(1)}%</span></span>
              </div>
            ` : `
              <div class="year-comparison" style="justify-content: center;">
                <div class="year-value">
                  <div class="year">${year1}</div>
                  <div class="val">${stats1.avg.toFixed(decimals)}${unit ? ' ' + unit : ''}</div>
                </div>
              </div>
              <div class="change-details" style="color: #94a3b8;">
                Select a second year to see comparison
              </div>
            `}
          </div>
        `;
      });
      
      grid.innerHTML = html || '<div class="no-data">No nutrient data available</div>';
    }

    function showStatus(msg, ok) {
      const el = document.getElementById('statusMessage');
      el.textContent = msg;
      el.style.display = 'block';
      el.style.background = ok ? '#dcfce7' : '#fee2e2';
      el.style.color = ok ? '#166534' : '#991b1b';
      setTimeout(() => el.style.display = 'none', 4000);
    }
  </script>
</body>
</html>
