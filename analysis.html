<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soil Sample Analysis - Analysis</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; }
    .top-bar { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .top-bar h1 { font-size: 1.5rem; font-weight: 700; }
    .top-bar p { font-size: 0.875rem; opacity: 0.8; margin-top: 0.25rem; }
    .nav-links { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .nav-link { padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; }
    .nav-link:hover { background: rgba(255,255,255,0.2); }
    .nav-link.active { background: #3b82f6; }
    .auth-section { display: flex; align-items: center; gap: 1rem; }
    .user-info { font-size: 0.875rem; color: rgba(255,255,255,0.9); }
    .sign-in-btn { padding: 0.5rem 1rem; background: #4285f4; color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; }
    .sign-in-btn.signed-in { background: #22c55e; }
    
    .analysis-container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
    
    /* Tabs */
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .tab { padding: 0.75rem 1.25rem; background: white; border: 1px solid #cbd5e1; border-radius: 0.5rem; cursor: pointer; font-weight: 500; font-size: 0.875rem; }
    .tab:hover { background: #f1f5f9; }
    .tab.active { background: #3b82f6; color: white; border-color: #3b82f6; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Controls */
    .controls-bar { background: white; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: flex-end; }
    .control-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .control-group label { font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; }
    .control-group select { padding: 0.5rem 0.75rem; font-size: 0.875rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; min-width: 160px; }
    
    /* Nutrient Grid for Year Comparison */
    .nutrient-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
    
    .nutrient-card { background: white; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #94a3b8; }
    .nutrient-card.positive { border-left-color: #22c55e; background: linear-gradient(to right, #f0fdf4, white); }
    .nutrient-card.negative { border-left-color: #ef4444; background: linear-gradient(to right, #fef2f2, white); }
    
    .nutrient-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .nutrient-name { font-size: 1rem; font-weight: 700; color: #1e293b; }
    .nutrient-pct { font-size: 1.125rem; font-weight: 700; }
    .nutrient-pct.positive { color: #22c55e; }
    .nutrient-pct.negative { color: #ef4444; }
    .nutrient-pct.neutral { color: #64748b; }
    
    .nutrient-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 0.75rem; }
    .stat-box { background: #f8fafc; border-radius: 0.375rem; padding: 0.5rem; text-align: center; }
    .stat-box .label { font-size: 0.625rem; font-weight: 600; color: #64748b; text-transform: uppercase; }
    .stat-box .value { font-size: 0.9375rem; font-weight: 700; color: #1e293b; }
    
    .year-comparison { display: flex; justify-content: space-between; align-items: center; background: #f1f5f9; border-radius: 0.375rem; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; }
    .year-val { text-align: center; }
    .year-val .yr { font-size: 0.625rem; font-weight: 600; color: #64748b; }
    .year-val .num { font-size: 1.125rem; font-weight: 700; color: #1e293b; }
    .year-arrow { font-size: 1.25rem; color: #94a3b8; }
    
    .change-row { display: flex; justify-content: center; gap: 1.5rem; font-size: 0.75rem; color: #64748b; }
    .change-row .val { font-weight: 600; }
    .change-row .val.positive { color: #22c55e; }
    .change-row .val.negative { color: #ef4444; }
    
    /* Historical Trends */
    .trend-card { background: white; border: 2px solid; border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 1rem; }
    .trend-card.positive { background: #f0fdf4; border-color: #22c55e; }
    .trend-card.negative { background: #fef2f2; border-color: #ef4444; }
    .trend-card.neutral { background: #f8fafc; border-color: #94a3b8; }
    .trend-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
    .trend-title { font-size: 1.125rem; font-weight: 600; }
    .trend-pct { font-size: 1.5rem; font-weight: 700; text-align: right; }
    .trend-sub { font-size: 0.75rem; color: #64748b; }
    .trend-content { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .trend-values { min-width: 140px; }
    .trend-row { display: flex; justify-content: space-between; padding: 0.375rem 0; border-bottom: 1px solid #e2e8f0; font-size: 0.875rem; }
    .trend-graph { flex: 1; min-width: 300px; }
    
    /* Field Rankings */
    .rankings-table { width: 100%; border-collapse: collapse; background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .rankings-table th, .rankings-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
    .rankings-table th { background: #f8fafc; font-weight: 600; color: #475569; font-size: 0.75rem; text-transform: uppercase; }
    .rankings-table tr:hover { background: #f8fafc; }
    .rankings-table .rank { font-weight: 700; color: #64748b; width: 60px; }
    .rankings-table .field { font-weight: 500; }
    .rankings-table .value { font-weight: 700; }
    .rankings-table .high { color: #22c55e; }
    .rankings-table .low { color: #ef4444; }
    
    .no-data { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 0.5rem; padding: 2rem; text-align: center; color: #92400e; }
    #statusMessage { display: none; position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 0.75rem 1rem; border-radius: 0.375rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    
    @media (max-width: 639px) {
      .nutrient-grid { grid-template-columns: 1fr; }
      .controls-bar { flex-direction: column; align-items: stretch; }
      .tabs { flex-direction: column; }
      .tab { text-align: center; }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div>
      <h1>üìä Soil Analysis</h1>
      <p>Trends, Comparisons & Rankings</p>
    </div>
    <nav class="nav-links">
      <a href="index.html" class="nav-link">üìç Map</a>
      <a href="analysis.html" class="nav-link active">üìä Analysis</a>
      <a href="import.html" class="nav-link">üìÅ Import</a>
      <a href="settings.html" class="nav-link">‚öôÔ∏è Settings</a>
    </nav>
    <div class="auth-section">
      <span class="user-info" id="userInfo"></span>
      <button class="sign-in-btn" id="authBtn" onclick="handleAuth()">Sign In with Google</button>
    </div>
  </div>
  
  <div class="analysis-container">
    <div class="tabs">
      <div class="tab active" data-tab="comparison">üìä Operation Year-Over-Year</div>
      <div class="tab" data-tab="history">üìà Field Trends</div>
      <div class="tab" data-tab="rankings">üèÜ Field Rankings</div>
      <div class="tab" data-tab="yield">üåæ Yield Correlation</div>
    </div>
    
    <!-- Tab 1: Year Comparison (Operation-wide) -->
    <div id="comparison" class="tab-content active">
      <div class="controls-bar">
        <div class="control-group">
          <label>From Year</label>
          <select id="year1Select"></select>
        </div>
        <div class="control-group">
          <label>To Year</label>
          <select id="year2Select"></select>
        </div>
      </div>
      
      <!-- Year Stats Section -->
      <div id="yearStats" style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <div id="fromYearStats" style="flex: 1; min-width: 250px; background: #f8fafc; border: 2px solid #cbd5e1; border-radius: 0.5rem; padding: 1rem;">
          <h4 style="margin: 0 0 0.5rem 0; color: #64748b; font-size: 0.875rem;">From Year Stats</h4>
          <div id="fromYearInfo"></div>
        </div>
        <div id="toYearStats" style="flex: 1; min-width: 250px; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 0.5rem; padding: 1rem;">
          <h4 style="margin: 0 0 0.5rem 0; color: #166534; font-size: 0.875rem;">To Year Stats</h4>
          <div id="toYearInfo"></div>
        </div>
      </div>
      
      <!-- Field Selection & Mismatch Warning -->
      <div id="fieldSelectionSection" style="background: white; border: 2px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <h4 style="margin: 0; color: #475569; font-size: 0.875rem;">üìã Fields Included in Comparison</h4>
          <div>
            <button onclick="selectAllComparisonFields()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.25rem; background: white; cursor: pointer; margin-right: 0.25rem;">Select All</button>
            <button onclick="selectNoneComparisonFields()" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.25rem; background: white; cursor: pointer;">Select None</button>
          </div>
        </div>
        <div id="fieldCheckboxes" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
        <div id="fieldMismatchWarning" style="margin-top: 0.75rem;"></div>
      </div>
      
      <div id="comparisonGrid" class="nutrient-grid"></div>
    </div>
    
    <!-- Tab 2: Historical Field Trends -->
    <div id="history" class="tab-content">
      <div class="controls-bar">
        <div class="control-group">
          <label>Select Field</label>
          <select id="historyFieldSelect"><option value="">Select a field...</option></select>
        </div>
      </div>
      <div id="historyContent"></div>
    </div>
    
    <!-- Tab 3: Field Rankings -->
    <div id="rankings" class="tab-content">
      <div class="controls-bar">
        <div class="control-group">
          <label>Nutrient</label>
          <select id="rankingAttrSelect"></select>
        </div>
        <div class="control-group">
          <label>Year</label>
          <select id="rankingYearSelect"></select>
        </div>
      </div>
      <div id="rankingsContent"></div>
    </div>
    
    <!-- Tab 4: Yield Correlation -->
    <div id="yield" class="tab-content">
      <div class="controls-bar">
        <div class="control-group">
          <label>Crop</label>
          <select id="yieldCropSelect">
            <option value="all">All Crops</option>
            <option value="corn">üåΩ Corn</option>
            <option value="soybeans">ü´ò Soybeans</option>
          </select>
        </div>
        <div class="control-group">
          <label>Year</label>
          <select id="yieldYearSelect"></select>
        </div>
        <div class="control-group">
          <label>Field</label>
          <select id="yieldFieldSelect">
            <option value="all">All Fields</option>
          </select>
        </div>
      </div>
      <div id="yieldContent">
        <div class="no-data">No yield data available. Import yield maps on the Import page to see correlations.</div>
      </div>
    </div>
  </div>
  
  <div id="statusMessage"></div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script>
    const CONFIG = {
      CLIENT_ID: '714780458094-9rde31taeottmavhl5t0uo8b9kfpergc.apps.googleusercontent.com',
      API_KEY: 'AIzaSyCOSDbrAlc3ct2-lRvJv1y7V0nV7haWc9E',
      get SHEET_ID() { return localStorage.getItem('googleSheetId') || '1buu-8KXoM1kRJSOAWtHaAk40seQT5kqGFY9RICYwdRY'; },
      
      NUTRIENTS: ['pH', 'P', 'P2', 'K', 'OM', 'CEC', 'Ca_sat', 'Mg_sat', 'K_Sat', 'H_Sat', 'Na_Sat', 'Zn', 'Cu', 'Mn', 'Fe', 'Boron', 'S', 'Buffer_pH', 'Na', 'Ca', 'Mg', 'NO3', 'NH4', 'Soluble_Salts', 'EC'],
      
      NUTRIENT_NAMES: {
        pH: 'pH', P: 'Phosphorus (P)', P2: 'Phosphorus P2', K: 'Potassium (K)', OM: 'Organic Matter',
        CEC: 'CEC', Ca_sat: 'Calcium Sat %', Mg_sat: 'Magnesium Sat %',
        K_Sat: 'K Base Sat %', H_Sat: 'H Base Sat %', Na_Sat: 'Na Base Sat %', Zn: 'Zinc', Cu: 'Copper',
        Mn: 'Manganese', Fe: 'Iron', Boron: 'Boron', S: 'Sulfur', Buffer_pH: 'Buffer pH',
        Na: 'Sodium', Ca: 'Calcium', Mg: 'Magnesium', NO3: 'Nitrate', NH4: 'Ammonium', Soluble_Salts: 'Soluble Salts', EC: 'EC'
      },
      
      NUTRIENT_UNITS: {
        pH: '', P: 'ppm', P2: 'ppm', K: 'ppm', OM: '%', CEC: 'meq/100g',
        Ca_sat: '%', Mg_sat: '%', K_Sat: '%', H_Sat: '%', Na_Sat: '%',
        Zn: 'ppm', Cu: 'ppm', Mn: 'ppm', Fe: 'ppm', Boron: 'ppm', S: 'ppm', Buffer_pH: '',
        Na: 'ppm', Ca: 'ppm', Mg: 'ppm', NO3: 'ppm', NH4: 'ppm', Soluble_Salts: 'mmhos/cm', EC: 'dS/m'
      },
      
      LOWER_IS_BETTER: ['Mg_sat', 'H_Sat', 'Na_Sat', 'Soluble_Salts'],
      
      // Default visibility for nutrients (used if no settings saved)
      DEFAULT_VISIBLE: ['pH', 'P', 'K', 'OM', 'CEC', 'Ca_sat', 'Mg_sat', 'K_Sat', 'H_Sat', 'Zn', 'Cu', 'Mn', 'Fe', 'Boron', 'S', 'Buffer_pH']
    };
    
    // Get visible nutrients based on settings
    function getVisibleNutrients() {
      const saved = JSON.parse(localStorage.getItem('nutrientVisibility') || '{}');
      return CONFIG.NUTRIENTS.filter(n => {
        if (saved[n] !== undefined) return saved[n];
        return CONFIG.DEFAULT_VISIBLE.includes(n);
      });
    }

    let tokenClient, accessToken = null;
    let sampleData = [];
    let year1 = null, year2 = null;
    let selectedComparisonFields = new Set(); // Track which fields are included in comparison
    
    const SheetsAPI = {
      isSignedIn: false,
      async init() {
        return new Promise((resolve, reject) => {
          gapi.load('client', async () => {
            try {
              await gapi.client.init({ apiKey: CONFIG.API_KEY, discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
              tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (response) => {
                  if (response.error) return;
                  accessToken = response.access_token;
                  localStorage.setItem('googleAccessToken', accessToken);
                  this.isSignedIn = true;
                  this.onSignInChange(true);
                },
              });
              const savedToken = localStorage.getItem('googleAccessToken');
              const savedExpiry = localStorage.getItem('googleTokenExpiry');
              if (savedToken && savedExpiry && Date.now() < parseInt(savedExpiry)) {
                accessToken = savedToken;
                gapi.client.setToken({ access_token: accessToken });
                this.isSignedIn = true;
                this.onSignInChange(true);
              }
              resolve(true);
            } catch (e) { reject(e); }
          });
        });
      },
      async signIn() { tokenClient.requestAccessToken({ prompt: 'consent' }); },
      async signOut() { 
        if (accessToken) google.accounts.oauth2.revoke(accessToken);
        accessToken = null;
        localStorage.removeItem('googleAccessToken');
        this.isSignedIn = false;
        this.onSignInChange(false);
      },
      onSignInChange(s) {}
    };

    document.addEventListener('DOMContentLoaded', async () => {
      try { await SheetsAPI.init(); SheetsAPI.onSignInChange = handleSignInChange; handleSignInChange(SheetsAPI.isSignedIn); } catch (e) {}
      loadLocalData();
      setupTabs();
      setupEventListeners();
    });

    async function handleAuth() { if (SheetsAPI.isSignedIn) await SheetsAPI.signOut(); else await SheetsAPI.signIn(); }
    
    function handleSignInChange(isSignedIn) {
      const authBtn = document.getElementById('authBtn'), userInfo = document.getElementById('userInfo');
      if (isSignedIn) { userInfo.textContent = 'Connected'; authBtn.textContent = '‚úì Signed In'; authBtn.classList.add('signed-in'); }
      else { userInfo.textContent = ''; authBtn.textContent = 'Sign In with Google'; authBtn.classList.remove('signed-in'); }
    }

    function loadLocalData() {
      try {
        const saved = localStorage.getItem('soilSamples');
        if (saved) sampleData = JSON.parse(saved);
      } catch (e) {}
      populateSelectors();
      updateComparison();
    }

    function populateSelectors() {
      const years = [...new Set(sampleData.map(s => s.year).filter(y => y))].sort((a, b) => b - a);
      const fields = [...new Set(sampleData.map(s => s.field).filter(f => f && f !== 'Unknown'))].sort();
      
      // Year comparison selectors - year1 is earlier (FROM), year2 is later (TO)
      const year1Sel = document.getElementById('year1Select');
      const year2Sel = document.getElementById('year2Select');
      year1Sel.innerHTML = ''; year2Sel.innerHTML = '';
      years.forEach((y, i) => {
        year1Sel.innerHTML += `<option value="${y}" ${i === 1 ? 'selected' : ''}>${y}</option>`;
        year2Sel.innerHTML += `<option value="${y}" ${i === 0 ? 'selected' : ''}>${y}</option>`;
      });
      year1 = years[1] || years[0] || null;  // Earlier year (second most recent)
      year2 = years[0] || null;               // Later year (most recent)
      
      // History field selector
      const historyFieldSel = document.getElementById('historyFieldSelect');
      historyFieldSel.innerHTML = '<option value="">Select a field...</option>';
      fields.forEach(f => { historyFieldSel.innerHTML += `<option value="${f}">${f}</option>`; });
      
      // Rankings selectors
      const rankAttrSel = document.getElementById('rankingAttrSelect');
      rankAttrSel.innerHTML = '';
      const visibleNutrients = getVisibleNutrients();
      visibleNutrients.forEach(n => { rankAttrSel.innerHTML += `<option value="${n}">${CONFIG.NUTRIENT_NAMES[n] || n}</option>`; });
      
      const rankYearSel = document.getElementById('rankingYearSelect');
      rankYearSel.innerHTML = '<option value="most_recent" selected>Most Recent</option>';
      years.forEach(y => { rankYearSel.innerHTML += `<option value="${y}">${y}</option>`; });
      
      // Yield selectors
      const yieldYearSel = document.getElementById('yieldYearSelect');
      const yieldYears = getYieldYears();
      yieldYearSel.innerHTML = '<option value="all">All Years</option>';
      yieldYears.forEach(y => { yieldYearSel.innerHTML += `<option value="${y}">${y}</option>`; });
      
      const yieldFieldSel = document.getElementById('yieldFieldSelect');
      yieldFieldSel.innerHTML = '<option value="all">All Fields</option>';
      fields.forEach(f => { yieldFieldSel.innerHTML += `<option value="${f}">${f}</option>`; });
    }
    
    function getYieldYears() {
      const years = new Set();
      sampleData.forEach(s => {
        if (s.yieldCorrelations) {
          Object.keys(s.yieldCorrelations).forEach(y => years.add(parseInt(y)));
        }
      });
      return [...years].sort((a, b) => b - a);
    }

    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });
    }

    function setupEventListeners() {
      document.getElementById('year1Select').addEventListener('change', (e) => { year1 = e.target.value; selectedComparisonFields.clear(); updateComparison(); });
      document.getElementById('year2Select').addEventListener('change', (e) => { year2 = e.target.value; selectedComparisonFields.clear(); updateComparison(); });
      document.getElementById('historyFieldSelect').addEventListener('change', (e) => { updateHistory(e.target.value); });
      document.getElementById('rankingAttrSelect').addEventListener('change', updateRankings);
      document.getElementById('rankingYearSelect').addEventListener('change', updateRankings);
      document.getElementById('yieldCropSelect').addEventListener('change', updateYieldAnalysis);
      document.getElementById('yieldYearSelect').addEventListener('change', updateYieldAnalysis);
      document.getElementById('yieldFieldSelect').addEventListener('change', updateYieldAnalysis);
    }

    function getStats(samples, attr) {
      const values = samples.map(s => s[attr]).filter(v => v !== undefined && v !== null && !isNaN(v));
      if (values.length === 0) return null;
      return {
        avg: values.reduce((a, b) => a + b, 0) / values.length,
        high: Math.max(...values),
        low: Math.min(...values),
        count: values.length
      };
    }
    
    function updateYearStatsBox(container, year, samples) {
      if (!year || samples.length === 0) {
        container.innerHTML = '<p style="color: #94a3b8; font-style: italic;">No data</p>';
        return;
      }
      
      // Get unique fields
      const fields = [...new Set(samples.map(s => s.field).filter(f => f && f !== 'Unknown'))].sort();
      
      let html = `
        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: flex-start;">
          <div>
            <div style="font-size: 1.5rem; font-weight: 700; color: #1e293b;">${year}</div>
            <div style="font-size: 0.875rem; color: #64748b;">${samples.length} samples</div>
          </div>
          <div style="flex: 1; min-width: 150px;">
            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">Fields Sampled (${fields.length}):</div>
            <select style="width: 100%; padding: 0.375rem; border: 1px solid #cbd5e1; border-radius: 0.25rem; font-size: 0.8125rem; background: white;">
              ${fields.map(f => `<option>${f}</option>`).join('')}
            </select>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    function toggleComparisonField(field) {
      if (selectedComparisonFields.has(field)) {
        selectedComparisonFields.delete(field);
      } else {
        selectedComparisonFields.add(field);
      }
      updateComparison();
    }
    
    function selectAllComparisonFields() {
      const allSamplesFrom = year1 ? sampleData.filter(s => String(s.year) === String(year1)) : [];
      const allSamplesTo = sampleData.filter(s => String(s.year) === String(year2));
      const fieldsFrom = new Set(allSamplesFrom.map(s => s.field).filter(f => f && f !== 'Unknown'));
      const fieldsTo = new Set(allSamplesTo.map(s => s.field).filter(f => f && f !== 'Unknown'));
      const allFields = [...new Set([...fieldsFrom, ...fieldsTo])];
      allFields.forEach(f => selectedComparisonFields.add(f));
      updateComparison();
    }
    
    function selectNoneComparisonFields() {
      selectedComparisonFields.clear();
      updateComparison();
    }

    // ========== TAB 1: Year Comparison ==========
    // year1 = FROM (earlier year), year2 = TO (later year)
    // Stats shown are for year2, change = year2 - year1
    function updateComparison() {
      const grid = document.getElementById('comparisonGrid');
      const fromYearInfo = document.getElementById('fromYearInfo');
      const toYearInfo = document.getElementById('toYearInfo');
      const fieldCheckboxes = document.getElementById('fieldCheckboxes');
      const mismatchWarning = document.getElementById('fieldMismatchWarning');
      
      if (!year2 || sampleData.length === 0) {
        grid.innerHTML = '<div class="no-data">No data available. Import soil samples to see analysis.</div>';
        fromYearInfo.innerHTML = '';
        toYearInfo.innerHTML = '';
        fieldCheckboxes.innerHTML = '';
        mismatchWarning.innerHTML = '';
        return;
      }
      
      const allSamplesFrom = year1 ? sampleData.filter(s => String(s.year) === String(year1)) : [];
      const allSamplesTo = sampleData.filter(s => String(s.year) === String(year2));
      
      // Get all fields from both years
      const fieldsFrom = new Set(allSamplesFrom.map(s => s.field).filter(f => f && f !== 'Unknown'));
      const fieldsTo = new Set(allSamplesTo.map(s => s.field).filter(f => f && f !== 'Unknown'));
      const allFields = [...new Set([...fieldsFrom, ...fieldsTo])].sort();
      
      // Initialize selectedComparisonFields if empty
      if (selectedComparisonFields.size === 0) {
        allFields.forEach(f => selectedComparisonFields.add(f));
      }
      
      // Update field checkboxes
      fieldCheckboxes.innerHTML = allFields.map(field => {
        const inFrom = fieldsFrom.has(field);
        const inTo = fieldsTo.has(field);
        const checked = selectedComparisonFields.has(field);
        const mismatch = (inFrom && !inTo) || (!inFrom && inTo);
        const bgColor = mismatch ? '#fef3c7' : (checked ? '#dcfce7' : '#f8fafc');
        const borderColor = mismatch ? '#f59e0b' : (checked ? '#22c55e' : '#cbd5e1');
        
        return `
          <label style="display: flex; align-items: center; gap: 0.375rem; padding: 0.375rem 0.625rem; background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 0.375rem; cursor: pointer; font-size: 0.8125rem;">
            <input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleComparisonField('${field}')" style="cursor: pointer;">
            <span>${field}</span>
            ${mismatch ? '<span style="color: #f59e0b;" title="Not in both years">‚ö†Ô∏è</span>' : ''}
          </label>
        `;
      }).join('');
      
      // Check for mismatches
      const onlyInFrom = [...fieldsFrom].filter(f => !fieldsTo.has(f));
      const onlyInTo = [...fieldsTo].filter(f => !fieldsFrom.has(f));
      
      if (onlyInFrom.length > 0 || onlyInTo.length > 0) {
        let warningHtml = '<div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 0.375rem; padding: 0.75rem; font-size: 0.8125rem;">';
        warningHtml += '<strong style="color: #92400e;">‚ö†Ô∏è Field Mismatch Detected</strong><br>';
        if (onlyInFrom.length > 0) {
          warningHtml += `<span style="color: #92400e;">Only in ${year1}: ${onlyInFrom.join(', ')}</span><br>`;
        }
        if (onlyInTo.length > 0) {
          warningHtml += `<span style="color: #92400e;">Only in ${year2}: ${onlyInTo.join(', ')}</span>`;
        }
        warningHtml += '</div>';
        mismatchWarning.innerHTML = warningHtml;
      } else {
        mismatchWarning.innerHTML = '';
      }
      
      // Filter samples by selected fields
      const samplesFrom = allSamplesFrom.filter(s => selectedComparisonFields.has(s.field));
      const samplesTo = allSamplesTo.filter(s => selectedComparisonFields.has(s.field));
      
      // Update year stats boxes
      updateYearStatsBox(fromYearInfo, year1, samplesFrom);
      updateYearStatsBox(toYearInfo, year2, samplesTo);
      
      if (samplesTo.length === 0) {
        grid.innerHTML = `<div class="no-data">No samples found for ${year2} with selected fields</div>`;
        return;
      }
      
      let html = '';
      
      const visibleNutrients = getVisibleNutrients();
      visibleNutrients.forEach(attr => {
        const statsTo = getStats(samplesTo, attr);
        const statsFrom = year1 ? getStats(samplesFrom, attr) : null;
        
        if (!statsTo) return;
        
        const name = CONFIG.NUTRIENT_NAMES[attr] || attr;
        const unit = CONFIG.NUTRIENT_UNITS[attr] || '';
        const decimals = (attr === 'pH' || attr === 'Buffer_pH') ? 2 : 1;
        const isLowerBetter = CONFIG.LOWER_IS_BETTER.includes(attr);
        
        let pointChange = 0, pctChange = 0, cardClass = '', pctClass = 'neutral';
        
        if (statsFrom && statsFrom.avg) {
          pointChange = statsTo.avg - statsFrom.avg;
          pctChange = statsFrom.avg !== 0 ? (pointChange / statsFrom.avg) * 100 : 0;
          const isPositive = isLowerBetter ? pointChange < 0 : pointChange > 0;
          const isSignificant = Math.abs(pctChange) > 2;
          if (isSignificant) {
            cardClass = isPositive ? 'positive' : 'negative';
            pctClass = isPositive ? 'positive' : 'negative';
          }
        }
        
        html += `
          <div class="nutrient-card ${cardClass}">
            <div class="nutrient-header">
              <span class="nutrient-name">${name}</span>
              ${statsFrom ? `<span class="nutrient-pct ${pctClass}">${pctChange >= 0 ? '+' : ''}${pctChange.toFixed(1)}%</span>` : ''}
            </div>
            <div class="nutrient-stats">
              <div class="stat-box"><div class="label">Average</div><div class="value">${statsTo.avg.toFixed(decimals)}</div></div>
              <div class="stat-box"><div class="label">High</div><div class="value">${statsTo.high.toFixed(decimals)}</div></div>
              <div class="stat-box"><div class="label">Low</div><div class="value">${statsTo.low.toFixed(decimals)}</div></div>
            </div>
            ${statsFrom ? `
              <div class="year-comparison">
                <div class="year-val"><div class="yr">${year1}</div><div class="num">${statsFrom.avg.toFixed(decimals)}</div></div>
                <div class="year-arrow">‚Üí</div>
                <div class="year-val"><div class="yr">${year2}</div><div class="num">${statsTo.avg.toFixed(decimals)}</div></div>
              </div>
              <div class="change-row">
                <span>Point: <span class="val ${pctClass}">${pointChange >= 0 ? '+' : ''}${pointChange.toFixed(decimals)}</span></span>
                <span>%: <span class="val ${pctClass}">${pctChange >= 0 ? '+' : ''}${pctChange.toFixed(1)}%</span></span>
              </div>
            ` : `<div class="year-comparison" style="justify-content:center;"><div class="year-val"><div class="yr">${year2}</div><div class="num">${statsTo.avg.toFixed(decimals)} ${unit}</div></div></div>`}
          </div>
        `;
      });
      
      grid.innerHTML = html || '<div class="no-data">No nutrient data available</div>';
    }

    // ========== TAB 2: Historical Field Trends ==========
    function updateHistory(fieldName) {
      const container = document.getElementById('historyContent');
      
      if (!fieldName) {
        container.innerHTML = '<div class="no-data">Select a field to view nutrient trends over time</div>';
        return;
      }
      
      const fieldSamples = sampleData.filter(s => s.field === fieldName);
      const years = [...new Set(fieldSamples.map(s => s.year).filter(y => y))].sort();
      
      if (years.length < 1) {
        container.innerHTML = '<div class="no-data">No data available for this field</div>';
        return;
      }
      
      let html = `<div style="background:#f8fafc;border:2px solid #cbd5e1;border-radius:0.5rem;padding:1rem;margin-bottom:1rem;"><h3 style="margin:0 0 0.25rem 0;">${fieldName}</h3><p style="margin:0;color:#64748b;">Years: ${years.join(', ')}</p></div>`;
      
      const visibleNutrients = getVisibleNutrients();
      visibleNutrients.forEach(attr => {
        const yearData = [];
        let hasData = false;
        
        years.forEach(year => {
          const yearSamples = fieldSamples.filter(s => String(s.year) === String(year));
          const stats = getStats(yearSamples, attr);
          if (stats) { yearData.push({ year, avg: stats.avg }); hasData = true; }
        });
        
        if (!hasData || yearData.length < 1) return;
        
        const first = yearData[0], last = yearData[yearData.length - 1];
        const change = last.avg - first.avg;
        const pctChange = first.avg !== 0 ? (change / first.avg) * 100 : 0;
        const isLowerBetter = CONFIG.LOWER_IS_BETTER.includes(attr);
        const isPositive = isLowerBetter ? change < 0 : change > 0;
        const decimals = (attr === 'pH' || attr === 'Buffer_pH') ? 2 : 1;
        const unit = CONFIG.NUTRIENT_UNITS[attr] || '';
        const name = CONFIG.NUTRIENT_NAMES[attr] || attr;
        
        let cardClass = 'neutral', color = '#64748b';
        if (yearData.length > 1) {
          cardClass = isPositive ? 'positive' : 'negative';
          color = isPositive ? '#22c55e' : '#ef4444';
        }
        
        const graph = createLineGraph(yearData, color);
        
        html += `
          <div class="trend-card ${cardClass}">
            <div class="trend-header">
              <h4 class="trend-title">${name}</h4>
              ${yearData.length > 1 ? `<div class="trend-pct" style="color:${color};">${pctChange >= 0 ? '+' : ''}${pctChange.toFixed(1)}%<div class="trend-sub">${first.year} ‚Üí ${last.year}</div></div>` : ''}
            </div>
            <div class="trend-content">
              <div class="trend-values">
                ${yearData.map(d => `<div class="trend-row"><span>${d.year}</span><span style="font-weight:600;">${d.avg.toFixed(decimals)} ${unit}</span></div>`).join('')}
                ${yearData.length > 1 ? `<div class="trend-row" style="margin-top:0.5rem;border-top:2px solid ${color};padding-top:0.5rem;"><span>Change:</span><span style="color:${color};font-weight:700;">${change >= 0 ? '+' : ''}${change.toFixed(decimals)}</span></div>` : ''}
              </div>
              <div class="trend-graph">${graph}</div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html || '<div class="no-data">No nutrient data available</div>';
    }

    function createLineGraph(yearData, color) {
      if (yearData.length < 1) return '';
      const values = yearData.map(d => d.avg);
      const minVal = Math.min(...values) * 0.9, maxVal = Math.max(...values) * 1.1;
      const range = maxVal - minVal || 1;
      const width = 400, height = 140, pad = 20;
      const gw = width - pad * 2, gh = height - pad * 2 - 20;
      
      const pts = yearData.map((d, i) => {
        const x = pad + (yearData.length > 1 ? (i / (yearData.length - 1)) * gw : gw / 2);
        const y = pad + gh - ((d.avg - minVal) / range) * gh;
        return { x, y, year: d.year, val: d.avg };
      });
      
      const line = pts.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x},${p.y}`).join(' ');
      const dots = pts.map(p => `<circle cx="${p.x}" cy="${p.y}" r="6" fill="${color}" stroke="white" stroke-width="2"/><text x="${p.x}" y="${height - 5}" text-anchor="middle" font-size="11" fill="#64748b">${p.year}</text><text x="${p.x}" y="${p.y - 12}" text-anchor="middle" font-size="12" font-weight="700" fill="#1e293b">${p.val.toFixed(1)}</text>`).join('');
      
      return `<svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet"><path d="${line}" fill="none" stroke="${color}" stroke-width="3" stroke-linecap="round"/>${dots}</svg>`;
    }

    // ========== TAB 3: Field Rankings ==========
    function updateRankings() {
      const container = document.getElementById('rankingsContent');
      const attr = document.getElementById('rankingAttrSelect').value;
      const yearOption = document.getElementById('rankingYearSelect').value;
      
      if (!attr) {
        container.innerHTML = '<div class="no-data">Select nutrient</div>';
        return;
      }
      
      // Get all unique fields
      const allFields = [...new Set(sampleData.map(s => s.field).filter(f => f && f !== 'Unknown'))];
      
      const fieldStats = allFields.map(field => {
        // Get samples for this field
        let fieldSamples = sampleData.filter(s => s.field === field);
        
        if (yearOption === 'most_recent') {
          // Find most recent year for this field
          const fieldYears = [...new Set(fieldSamples.map(s => s.year).filter(y => y))].sort((a, b) => b - a);
          if (fieldYears.length === 0) return null;
          const mostRecentYear = fieldYears[0];
          fieldSamples = fieldSamples.filter(s => String(s.year) === String(mostRecentYear));
          const stats = getStats(fieldSamples, attr);
          return stats ? { field, avg: stats.avg, high: stats.high, low: stats.low, count: stats.count, year: mostRecentYear } : null;
        } else {
          // Filter by selected year
          fieldSamples = fieldSamples.filter(s => String(s.year) === String(yearOption));
          const stats = getStats(fieldSamples, attr);
          return stats ? { field, avg: stats.avg, high: stats.high, low: stats.low, count: stats.count, year: yearOption } : null;
        }
      }).filter(f => f);
      
      const isLowerBetter = CONFIG.LOWER_IS_BETTER.includes(attr);
      fieldStats.sort((a, b) => isLowerBetter ? a.avg - b.avg : b.avg - a.avg);
      
      const name = CONFIG.NUTRIENT_NAMES[attr] || attr;
      const unit = CONFIG.NUTRIENT_UNITS[attr] || '';
      const decimals = (attr === 'pH' || attr === 'Buffer_pH') ? 2 : 1;
      const maxAvg = Math.max(...fieldStats.map(f => f.avg));
      const minAvg = Math.min(...fieldStats.map(f => f.avg));
      
      // Add Year column if using Most Recent
      const showYearCol = yearOption === 'most_recent';
      
      let html = `<table class="rankings-table"><thead><tr><th>Rank</th><th>Field</th>${showYearCol ? '<th>Year</th>' : ''}<th>Average</th><th>High</th><th>Low</th><th>Samples</th></tr></thead><tbody>`;
      
      fieldStats.forEach((f, i) => {
        const isTop = f.avg === (isLowerBetter ? minAvg : maxAvg);
        const isBottom = f.avg === (isLowerBetter ? maxAvg : minAvg);
        html += `<tr><td class="rank">#${i + 1}</td><td class="field">${f.field}</td>${showYearCol ? `<td>${f.year}</td>` : ''}<td class="value ${isTop ? 'high' : isBottom ? 'low' : ''}">${f.avg.toFixed(decimals)} ${unit}</td><td>${f.high.toFixed(decimals)}</td><td>${f.low.toFixed(decimals)}</td><td>${f.count}</td></tr>`;
      });
      
      html += '</tbody></table>';
      container.innerHTML = fieldStats.length > 0 ? html : '<div class="no-data">No data available</div>';
    }
    
    // ========== TAB 4: Yield Correlation ==========
    function updateYieldAnalysis() {
      const container = document.getElementById('yieldContent');
      const cropFilter = document.getElementById('yieldCropSelect').value;
      const yearFilter = document.getElementById('yieldYearSelect').value;
      const fieldFilter = document.getElementById('yieldFieldSelect').value;
      
      // Get samples with yield correlations
      let samplesWithYield = sampleData.filter(s => s.yieldCorrelations && Object.keys(s.yieldCorrelations).length > 0);
      
      if (samplesWithYield.length === 0) {
        container.innerHTML = '<div class="no-data">No yield data available. Import yield maps on the Import page to see correlations.</div>';
        return;
      }
      
      // Filter by field
      if (fieldFilter !== 'all') {
        samplesWithYield = samplesWithYield.filter(s => s.field === fieldFilter);
      }
      
      // Build correlation data points
      const dataPoints = [];
      samplesWithYield.forEach(sample => {
        Object.entries(sample.yieldCorrelations).forEach(([year, yieldInfo]) => {
          if (yearFilter !== 'all' && String(year) !== String(yearFilter)) return;
          if (cropFilter !== 'all' && yieldInfo.crop !== cropFilter) return;
          
          dataPoints.push({
            ...sample,
            yieldYear: parseInt(year),
            avgYield: yieldInfo.avgYield,
            crop: yieldInfo.crop,
            yieldPointCount: yieldInfo.pointCount
          });
        });
      });
      
      if (dataPoints.length === 0) {
        container.innerHTML = '<div class="no-data">No matching yield data for selected filters.</div>';
        return;
      }
      
      // Calculate correlations for each nutrient
      const visibleNutrients = getVisibleNutrients();
      const correlations = [];
      
      visibleNutrients.forEach(nutrient => {
        const pairs = dataPoints.filter(d => d[nutrient] !== undefined && d[nutrient] !== null && !isNaN(d[nutrient]));
        if (pairs.length < 5) return; // Need at least 5 points
        
        const correlation = calculateCorrelation(
          pairs.map(p => p[nutrient]),
          pairs.map(p => p.avgYield)
        );
        
        if (correlation !== null && !isNaN(correlation.r)) {
          correlations.push({
            nutrient,
            name: CONFIG.NUTRIENT_NAMES[nutrient] || nutrient,
            r: correlation.r,
            r2: correlation.r2,
            n: pairs.length,
            significance: getSignificance(correlation.r, pairs.length)
          });
        }
      });
      
      // Sort by absolute correlation value
      correlations.sort((a, b) => Math.abs(b.r) - Math.abs(a.r));
      
      // Get summary stats
      const avgYield = dataPoints.reduce((sum, d) => sum + d.avgYield, 0) / dataPoints.length;
      const crops = [...new Set(dataPoints.map(d => d.crop))];
      const years = [...new Set(dataPoints.map(d => d.yieldYear))].sort();
      
      let html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
          <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 0.5rem; padding: 1rem; text-align: center;">
            <div style="font-size: 2rem; font-weight: 700; color: #92400e;">${dataPoints.length}</div>
            <div style="color: #92400e; font-size: 0.875rem;">Sample-Yield Pairs</div>
          </div>
          <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 0.5rem; padding: 1rem; text-align: center;">
            <div style="font-size: 2rem; font-weight: 700; color: #166534;">${avgYield.toFixed(1)}</div>
            <div style="color: #166534; font-size: 0.875rem;">Avg Yield (bu/ac)</div>
          </div>
          <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 0.5rem; padding: 1rem; text-align: center;">
            <div style="font-size: 1.25rem; font-weight: 600; color: #1e40af;">${crops.map(c => c === 'corn' ? 'üåΩ' : 'ü´ò').join(' ')}</div>
            <div style="color: #1e40af; font-size: 0.875rem;">Years: ${years.join(', ')}</div>
          </div>
        </div>
        
        <h3 style="margin: 0 0 1rem 0; color: #1e293b;">Nutrient-Yield Correlations</h3>
        <p style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">Shows how each nutrient relates to yield. Higher |r| = stronger relationship.</p>
        
        <table class="rankings-table">
          <thead>
            <tr>
              <th>Nutrient</th>
              <th>Correlation (r)</th>
              <th>R¬≤</th>
              <th>Significance</th>
              <th>Samples</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      correlations.forEach(c => {
        const color = c.r > 0 ? '#22c55e' : '#ef4444';
        const barWidth = Math.abs(c.r) * 100;
        const significance = c.significance === 'high' ? '‚≠ê‚≠ê‚≠ê' : c.significance === 'medium' ? '‚≠ê‚≠ê' : c.significance === 'low' ? '‚≠ê' : '‚Äî';
        const sigColor = c.significance === 'high' ? '#22c55e' : c.significance === 'medium' ? '#f59e0b' : '#94a3b8';
        
        html += `
          <tr>
            <td class="field">${c.name}</td>
            <td>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="width: 80px; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden;">
                  <div style="width: ${barWidth}%; height: 100%; background: ${color}; ${c.r < 0 ? 'margin-left: auto;' : ''}"></div>
                </div>
                <span style="font-weight: 600; color: ${color};">${c.r > 0 ? '+' : ''}${c.r.toFixed(3)}</span>
              </div>
            </td>
            <td>${(c.r2 * 100).toFixed(1)}%</td>
            <td style="color: ${sigColor};">${significance}</td>
            <td>${c.n}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      
      if (correlations.length === 0) {
        html = '<div class="no-data">Not enough data points to calculate correlations. Need at least 5 samples with yield data.</div>';
      }
      
      container.innerHTML = html;
    }
    
    function calculateCorrelation(x, y) {
      const n = x.length;
      if (n < 3) return null;
      
      const sumX = x.reduce((a, b) => a + b, 0);
      const sumY = y.reduce((a, b) => a + b, 0);
      const sumXY = x.reduce((total, xi, i) => total + xi * y[i], 0);
      const sumX2 = x.reduce((total, xi) => total + xi * xi, 0);
      const sumY2 = y.reduce((total, yi) => total + yi * yi, 0);
      
      const numerator = n * sumXY - sumX * sumY;
      const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
      
      if (denominator === 0) return null;
      
      const r = numerator / denominator;
      return { r, r2: r * r };
    }
    
    function getSignificance(r, n) {
      // Simplified significance based on r value and sample size
      const absR = Math.abs(r);
      if (n < 10) return 'insufficient';
      if (absR > 0.7) return 'high';
      if (absR > 0.4) return 'medium';
      if (absR > 0.2) return 'low';
      return 'none';
    }

    function showStatus(msg, ok) {
      const el = document.getElementById('statusMessage');
      el.textContent = msg;
      el.style.display = 'block';
      el.style.background = ok ? '#dcfce7' : '#fee2e2';
      el.style.color = ok ? '#166534' : '#991b1b';
      setTimeout(() => el.style.display = 'none', 4000);
    }
  </script>
</body>
</html>
