<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soil Sample Analysis - Analysis</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; }
    .app-container { display: flex; flex-direction: column; min-height: 100vh; }
    .top-bar { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .top-bar h1 { font-size: 1.5rem; font-weight: 700; }
    .top-bar p { font-size: 0.875rem; opacity: 0.8; margin-top: 0.25rem; }
    .nav-links { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .nav-link { padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; }
    .nav-link:hover { background: rgba(255,255,255,0.2); }
    .nav-link.active { background: #3b82f6; }
    .auth-section { display: flex; align-items: center; gap: 1rem; }
    .user-info { font-size: 0.875rem; color: rgba(255,255,255,0.9); }
    .sign-in-btn { padding: 0.5rem 1rem; background: #4285f4; color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; }
    .sign-in-btn.signed-in { background: #22c55e; }
    .analysis-container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
    
    .controls-bar { background: white; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 1.5rem; flex-wrap: wrap; align-items: flex-end; }
    .control-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .control-group label { font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; }
    .control-group select { padding: 0.5rem 0.75rem; font-size: 0.875rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; min-width: 140px; }
    
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
    .tab { padding: 0.75rem 1.5rem; background: white; border: 1px solid #cbd5e1; border-radius: 0.375rem; cursor: pointer; font-weight: 500; }
    .tab:hover { background: #f1f5f9; }
    .tab.active { background: #3b82f6; color: white; border-color: #3b82f6; }
    
    .section { background: white; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .section h2 { font-size: 1.25rem; margin-bottom: 1rem; color: #1e293b; }
    
    .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
    .comparison-card { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; }
    .comparison-card.positive { background: #f0fdf4; border-color: #22c55e; }
    .comparison-card.negative { background: #fef2f2; border-color: #ef4444; }
    .comparison-card .nutrient { font-weight: 600; color: #475569; margin-bottom: 0.5rem; }
    .comparison-card .values { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; }
    .comparison-card .change { font-size: 1.25rem; font-weight: 700; }
    .comparison-card .change.positive { color: #22c55e; }
    .comparison-card .change.negative { color: #ef4444; }
    
    .field-table { width: 100%; border-collapse: collapse; }
    .field-table th, .field-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
    .field-table th { background: #f8fafc; font-weight: 600; color: #475569; cursor: pointer; user-select: none; }
    .field-table th:hover { background: #f1f5f9; }
    .field-table th.sorted { color: #3b82f6; }
    .field-table th .sort-icon { margin-left: 0.5rem; }
    .field-table tr:hover { background: #f8fafc; }
    .field-table .rank { font-weight: 600; color: #64748b; width: 50px; }
    .field-table .field-name { font-weight: 500; }
    .field-table .value { font-weight: 600; }
    .field-table .value.high { color: #22c55e; }
    .field-table .value.low { color: #ef4444; }
    
    .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: #f8fafc; border-radius: 0.5rem; padding: 1rem; text-align: center; }
    .stat-card .label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem; }
    .stat-card .value { font-size: 1.5rem; font-weight: 700; color: #1e293b; }
    .stat-card .change { font-size: 0.875rem; margin-top: 0.25rem; }
    .stat-card .change.positive { color: #22c55e; }
    .stat-card .change.negative { color: #ef4444; }
    
    .no-data { background: #fef3c7; border: 2px solid #f59e0b; border-radius: 0.5rem; padding: 2rem; text-align: center; color: #92400e; }
    #statusMessage { display: none; position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 0.75rem 1rem; border-radius: 0.375rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="top-bar">
      <div>
        <h1>üìä Soil Analysis</h1>
        <p>Operation Comparison & Field Rankings</p>
      </div>
      <nav class="nav-links">
        <a href="index.html" class="nav-link">üìç Map</a>
        <a href="analysis.html" class="nav-link active">üìä Analysis</a>
        <a href="import.html" class="nav-link">üìÅ Import</a>
        <a href="settings.html" class="nav-link">‚öôÔ∏è Settings</a>
      </nav>
      <div class="auth-section">
        <span class="user-info" id="userInfo"></span>
        <button class="sign-in-btn" id="authBtn" onclick="handleAuth()">Sign In with Google</button>
      </div>
    </div>
    
    <div class="analysis-container">
      <div class="controls-bar">
        <div class="control-group">
          <label>Attribute</label>
          <select id="attributeSelect">
            <option value="P">Phosphorus (P)</option>
            <option value="pH">pH</option>
            <option value="K">Potassium (K)</option>
            <option value="OM">Organic Matter</option>
            <option value="CEC">CEC</option>
            <option value="Ca_sat">Calcium %</option>
            <option value="Mg_sat">Magnesium %</option>
            <option value="K_Sat">K Base Sat %</option>
            <option value="H_Sat">H Base Sat %</option>
            <option value="Zn">Zinc</option>
            <option value="Cu">Copper</option>
            <option value="Mn">Manganese</option>
            <option value="Fe">Iron</option>
            <option value="Boron">Boron</option>
            <option value="S">Sulfur</option>
          </select>
        </div>
        <div class="control-group">
          <label>Year</label>
          <select id="yearSelect"><option value="">All Years</option></select>
        </div>
        <div class="control-group">
          <label>Compare To</label>
          <select id="compareYearSelect"><option value="">Select Year</option></select>
        </div>
      </div>
      
      <div class="tabs">
        <div class="tab active" data-tab="comparison">Year Comparison</div>
        <div class="tab" data-tab="ranking">Field Rankings</div>
      </div>
      
      <div id="comparisonTab">
        <div class="section">
          <h2>Operation Summary</h2>
          <div class="summary-stats" id="summaryStats"></div>
        </div>
        
        <div class="section">
          <h2>All Nutrients Comparison</h2>
          <div class="comparison-grid" id="comparisonGrid"></div>
        </div>
      </div>
      
      <div id="rankingTab" style="display: none;">
        <div class="section">
          <h2>Field Rankings by <span id="rankingAttrName">Phosphorus</span></h2>
          <table class="field-table">
            <thead>
              <tr>
                <th class="rank">#</th>
                <th data-sort="field">Field</th>
                <th data-sort="avg" class="sorted">Average ‚Üì</th>
                <th data-sort="high">High</th>
                <th data-sort="low">Low</th>
                <th data-sort="samples">Samples</th>
              </tr>
            </thead>
            <tbody id="fieldTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="statusMessage"></div>
  </div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script>
    const CONFIG = {
      CLIENT_ID: '714780458094-9rde31taeottmavhl5t0uo8b9kfpergc.apps.googleusercontent.com',
      API_KEY: 'AIzaSyCOSDbrAlc3ct2-lRvJv1y7V0nV7haWc9E',
      SHEET_ID: '1buu-8KXoM1kRJSOAWtHaAk40seQT5kqGFY9RICYwdRY',
      NUTRIENT_ORDER: ['pH', 'OM', 'P', 'K', 'CEC', 'Ca_sat', 'Mg_sat', 'K_Sat', 'H_Sat', 'Zn', 'Cu', 'Mn', 'Fe', 'Boron', 'S'],
      LOWER_IS_BETTER: ['Mg_sat', 'H_Sat'],
      NUTRIENT_NAMES: { pH: 'pH', OM: 'Organic Matter', P: 'Phosphorus', K: 'Potassium', CEC: 'CEC', Ca_sat: 'Calcium %', Mg_sat: 'Magnesium %', K_Sat: 'K Base Sat', H_Sat: 'H Base Sat', Zn: 'Zinc', Cu: 'Copper', Mn: 'Manganese', Fe: 'Iron', Boron: 'Boron', S: 'Sulfur' },
      NUTRIENT_UNITS: { pH: '', OM: '%', P: 'ppm', K: 'ppm', CEC: 'meq/100g', Ca_sat: '%', Mg_sat: '%', K_Sat: '%', H_Sat: '%', Zn: 'ppm', Cu: 'ppm', Mn: 'ppm', Fe: 'ppm', Boron: 'ppm', S: 'ppm' }
    };

    let tokenClient, accessToken = null;
    let sampleData = [];
    let selectedAttribute = 'P';
    let selectedYear = '';
    let compareYear = '';
    let currentSort = { field: 'avg', direction: 'desc' };
    
    const SheetsAPI = {
      isSignedIn: false,
      async init() {
        return new Promise((resolve, reject) => {
          gapi.load('client', async () => {
            try {
              await gapi.client.init({ apiKey: CONFIG.API_KEY, discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
              tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (response) => {
                  if (response.error) return;
                  accessToken = response.access_token;
                  localStorage.setItem('googleAccessToken', accessToken);
                  localStorage.setItem('googleTokenExpiry', (Date.now() + 3600000).toString());
                  this.isSignedIn = true;
                  this.onSignInChange(true);
                },
              });
              // Check saved token
              const savedToken = localStorage.getItem('googleAccessToken');
              const savedExpiry = localStorage.getItem('googleTokenExpiry');
              if (savedToken && savedExpiry && Date.now() < parseInt(savedExpiry)) {
                accessToken = savedToken;
                this.isSignedIn = true;
                this.onSignInChange(true);
              }
              resolve(true);
            } catch (e) { reject(e); }
          });
        });
      },
      async signIn() { tokenClient.requestAccessToken({ prompt: 'consent' }); },
      async signOut() { 
        if (accessToken) google.accounts.oauth2.revoke(accessToken);
        accessToken = null;
        localStorage.removeItem('googleAccessToken');
        localStorage.removeItem('googleTokenExpiry');
        this.isSignedIn = false;
        this.onSignInChange(false);
      },
      onSignInChange(s) {}
    };

    document.addEventListener('DOMContentLoaded', async () => {
      loadLocalData();
      try {
        await SheetsAPI.init();
        SheetsAPI.onSignInChange = handleSignInChange;
        handleSignInChange(SheetsAPI.isSignedIn);
      } catch (e) { console.warn(e); }
      
      document.getElementById('attributeSelect').addEventListener('change', (e) => { selectedAttribute = e.target.value; updateAnalysis(); });
      document.getElementById('yearSelect').addEventListener('change', (e) => { selectedYear = e.target.value; updateCompareYearOptions(); updateAnalysis(); });
      document.getElementById('compareYearSelect').addEventListener('change', (e) => { compareYear = e.target.value; updateAnalysis(); });
      
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const tabName = tab.dataset.tab;
          document.getElementById('comparisonTab').style.display = tabName === 'comparison' ? 'block' : 'none';
          document.getElementById('rankingTab').style.display = tabName === 'ranking' ? 'block' : 'none';
        });
      });
      
      document.querySelectorAll('.field-table th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          const sortField = th.dataset.sort;
          if (currentSort.field === sortField) {
            currentSort.direction = currentSort.direction === 'desc' ? 'asc' : 'desc';
          } else {
            currentSort.field = sortField;
            currentSort.direction = 'desc';
          }
          updateFieldRanking();
        });
      });
      
      updateYearSelectors();
      updateAnalysis();
    });

    function loadLocalData() {
      try {
        const s = localStorage.getItem('soilSamples');
        if (s) sampleData = JSON.parse(s);
      } catch (e) {}
    }

    async function handleAuth() { if (SheetsAPI.isSignedIn) await SheetsAPI.signOut(); else await SheetsAPI.signIn(); }
    
    function handleSignInChange(isSignedIn) {
      const authBtn = document.getElementById('authBtn'), userInfo = document.getElementById('userInfo');
      if (isSignedIn) {
        userInfo.textContent = 'Connected';
        authBtn.textContent = '‚úì Signed In';
        authBtn.classList.add('signed-in');
      } else {
        userInfo.textContent = '';
        authBtn.textContent = 'Sign In with Google';
        authBtn.classList.remove('signed-in');
      }
    }

    function getUniqueYears() {
      return [...new Set(sampleData.map(s => s.year).filter(y => y))].sort((a, b) => b - a);
    }

    function updateYearSelectors() {
      const years = getUniqueYears();
      const yearSel = document.getElementById('yearSelect');
      const compareSel = document.getElementById('compareYearSelect');
      
      yearSel.innerHTML = '<option value="">All Years</option>';
      years.forEach(y => { yearSel.innerHTML += `<option value="${y}">${y}</option>`; });
      
      if (years.length > 0) {
        selectedYear = years[0].toString();
        yearSel.value = selectedYear;
      }
      
      updateCompareYearOptions();
    }

    function updateCompareYearOptions() {
      const years = getUniqueYears().filter(y => String(y) !== String(selectedYear));
      const compareSel = document.getElementById('compareYearSelect');
      compareSel.innerHTML = '<option value="">Select Year</option>';
      years.forEach(y => { compareSel.innerHTML += `<option value="${y}">${y}</option>`; });
      
      if (years.length > 0) {
        compareYear = years[0].toString();
        compareSel.value = compareYear;
      }
    }

    function updateAnalysis() {
      updateSummaryStats();
      updateComparisonGrid();
      updateFieldRanking();
    }

    function getFilteredSamples(year) {
      if (!year) return sampleData;
      return sampleData.filter(s => String(s.year) === String(year));
    }

    function calculateStats(samples, attr) {
      const values = samples.map(s => s[attr]).filter(v => v !== undefined && v !== null && !isNaN(v));
      if (values.length === 0) return null;
      return {
        avg: values.reduce((a, b) => a + b, 0) / values.length,
        high: Math.max(...values),
        low: Math.min(...values),
        count: values.length
      };
    }

    function updateSummaryStats() {
      const container = document.getElementById('summaryStats');
      const currentSamples = getFilteredSamples(selectedYear);
      const compareSamples = compareYear ? getFilteredSamples(compareYear) : null;
      
      const currentStats = calculateStats(currentSamples, selectedAttribute);
      const compareStats = compareSamples ? calculateStats(compareSamples, selectedAttribute) : null;
      
      if (!currentStats) {
        container.innerHTML = '<div class="no-data">No data for selected year</div>';
        return;
      }
      
      const unit = CONFIG.NUTRIENT_UNITS[selectedAttribute] || '';
      const decimals = selectedAttribute === 'pH' ? 2 : 1;
      
      let html = `
        <div class="stat-card">
          <div class="label">Average ${CONFIG.NUTRIENT_NAMES[selectedAttribute]}</div>
          <div class="value">${currentStats.avg.toFixed(decimals)} ${unit}</div>
          ${compareStats ? `<div class="change ${currentStats.avg >= compareStats.avg ? 'positive' : 'negative'}">${currentStats.avg >= compareStats.avg ? '‚Üë' : '‚Üì'} ${Math.abs(currentStats.avg - compareStats.avg).toFixed(decimals)} from ${compareYear}</div>` : ''}
        </div>
        <div class="stat-card">
          <div class="label">High</div>
          <div class="value">${currentStats.high.toFixed(decimals)} ${unit}</div>
        </div>
        <div class="stat-card">
          <div class="label">Low</div>
          <div class="value">${currentStats.low.toFixed(decimals)} ${unit}</div>
        </div>
        <div class="stat-card">
          <div class="label">Sample Count</div>
          <div class="value">${currentStats.count}</div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    function updateComparisonGrid() {
      const container = document.getElementById('comparisonGrid');
      
      if (!selectedYear || !compareYear) {
        container.innerHTML = '<div class="no-data">Select two years to compare</div>';
        return;
      }
      
      const currentSamples = getFilteredSamples(selectedYear);
      const compareSamples = getFilteredSamples(compareYear);
      
      let html = '';
      
      CONFIG.NUTRIENT_ORDER.forEach(attr => {
        const currentStats = calculateStats(currentSamples, attr);
        const compareStats = calculateStats(compareSamples, attr);
        
        if (!currentStats || !compareStats) return;
        
        const change = currentStats.avg - compareStats.avg;
        const pctChange = compareStats.avg !== 0 ? (change / compareStats.avg) * 100 : 0;
        const isLowerBetter = CONFIG.LOWER_IS_BETTER.includes(attr);
        const isPositive = isLowerBetter ? change < 0 : change > 0;
        const decimals = attr === 'pH' ? 2 : 1;
        const unit = CONFIG.NUTRIENT_UNITS[attr] || '';
        
        html += `
          <div class="comparison-card ${isPositive ? 'positive' : Math.abs(pctChange) > 5 ? 'negative' : ''}">
            <div class="nutrient">${CONFIG.NUTRIENT_NAMES[attr]}</div>
            <div class="values">
              <span>${compareYear}: ${compareStats.avg.toFixed(decimals)} ${unit}</span>
              <span>${selectedYear}: ${currentStats.avg.toFixed(decimals)} ${unit}</span>
            </div>
            <div class="change ${isPositive ? 'positive' : 'negative'}">
              ${change >= 0 ? '+' : ''}${change.toFixed(decimals)} (${pctChange >= 0 ? '+' : ''}${pctChange.toFixed(1)}%)
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html || '<div class="no-data">No comparison data available</div>';
    }

    function updateFieldRanking() {
      document.getElementById('rankingAttrName').textContent = CONFIG.NUTRIENT_NAMES[selectedAttribute] || selectedAttribute;
      
      const samples = getFilteredSamples(selectedYear);
      
      // Group by field
      const fieldGroups = {};
      samples.forEach(s => {
        const field = s.field || 'Unknown';
        if (!fieldGroups[field]) fieldGroups[field] = [];
        fieldGroups[field].push(s);
      });
      
      // Calculate stats per field
      const fieldStats = [];
      Object.entries(fieldGroups).forEach(([field, samples]) => {
        const stats = calculateStats(samples, selectedAttribute);
        if (stats) {
          fieldStats.push({ field, ...stats });
        }
      });
      
      // Sort
      fieldStats.sort((a, b) => {
        let valA = a[currentSort.field];
        let valB = b[currentSort.field];
        if (currentSort.field === 'field') {
          return currentSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }
        return currentSort.direction === 'asc' ? valA - valB : valB - valA;
      });
      
      // Update table headers
      document.querySelectorAll('.field-table th[data-sort]').forEach(th => {
        th.classList.remove('sorted');
        th.querySelector('.sort-icon')?.remove();
        if (th.dataset.sort === currentSort.field) {
          th.classList.add('sorted');
          th.innerHTML += `<span class="sort-icon">${currentSort.direction === 'desc' ? '‚Üì' : '‚Üë'}</span>`;
        }
      });
      
      // Render table
      const tbody = document.getElementById('fieldTableBody');
      const unit = CONFIG.NUTRIENT_UNITS[selectedAttribute] || '';
      const decimals = selectedAttribute === 'pH' ? 2 : 1;
      
      const maxVal = Math.max(...fieldStats.map(f => f.avg));
      const minVal = Math.min(...fieldStats.map(f => f.avg));
      
      let html = '';
      fieldStats.forEach((f, idx) => {
        const isHigh = f.avg === maxVal;
        const isLow = f.avg === minVal;
        html += `
          <tr>
            <td class="rank">${idx + 1}</td>
            <td class="field-name">${f.field}</td>
            <td class="value ${isHigh ? 'high' : isLow ? 'low' : ''}">${f.avg.toFixed(decimals)} ${unit}</td>
            <td>${f.high.toFixed(decimals)} ${unit}</td>
            <td>${f.low.toFixed(decimals)} ${unit}</td>
            <td>${f.count}</td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center;">No data</td></tr>';
    }
  </script>
</body>
</html>
