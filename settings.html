<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soil Sample Analysis - Settings</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; }
    .top-bar { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .top-bar h1 { font-size: 1.5rem; font-weight: 700; }
    .top-bar p { font-size: 0.875rem; opacity: 0.8; margin-top: 0.25rem; }
    .nav-links { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .nav-link { padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; }
    .nav-link:hover { background: rgba(255,255,255,0.2); }
    .nav-link.active { background: #3b82f6; }
    .auth-section { display: flex; align-items: center; gap: 1rem; }
    .user-info { font-size: 0.875rem; color: rgba(255,255,255,0.9); }
    .sign-in-btn { padding: 0.5rem 1rem; background: #4285f4; color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; }
    .sign-in-btn.signed-in { background: #22c55e; }
    .sign-in-btn.signed-in:hover { background: #16a34a; }
    .settings-container { max-width: 800px; margin: 0 auto; padding: 1.5rem; }
    .settings-card { background: white; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .settings-card h3 { margin: 0 0 1rem 0; padding-bottom: 0.75rem; border-bottom: 2px solid #e2e8f0; }
    .threshold-grid { display: grid; gap: 1rem; }
    .threshold-row { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 0.375rem; }
    .threshold-row .name { min-width: 150px; font-weight: 600; color: #374151; }
    .threshold-row .note { flex: 1; font-size: 0.75rem; color: #64748b; font-style: italic; text-align: center; }
    .threshold-row .inputs { display: flex; align-items: center; gap: 0.5rem; margin-left: auto; }
    .threshold-row input { width: 70px; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.25rem; text-align: center; }
    .threshold-row .unit { color: #64748b; font-size: 0.875rem; min-width: 30px; }
    .button { padding: 0.75rem 1.5rem; border: none; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; }
    .nutrient-toggle { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f8fafc; border-radius: 0.375rem; cursor: pointer; }
    .nutrient-toggle:hover { background: #e2e8f0; }
    .nutrient-toggle input { width: 18px; height: 18px; cursor: pointer; }
    .nutrient-toggle label { cursor: pointer; font-weight: 500; }
    .nutrient-grid-vis { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; }
    .button.primary { background: #3b82f6; color: white; }
    .button.secondary { background: white; color: #374151; border: 1px solid #cbd5e1; }
    .btn-row { display: flex; gap: 1rem; flex-wrap: wrap; }
    .btn-row .button { flex: 1; }
    #statusMessage { display: none; position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 0.75rem 1rem; border-radius: 0.375rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .backup-footer { position: fixed; bottom: 0; left: 0; right: 0; background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 0.25rem 1rem; font-size: 0.7rem; color: #64748b; text-align: center; z-index: 900; }
  </style>
</head>
<body>
  <div class="top-bar">
    <div><h1>‚öôÔ∏è Settings</h1><p>Configure thresholds and preferences</p></div>
    <nav class="nav-links">
      <a href="index.html" class="nav-link">üìç Map</a>
      <a href="analysis.html" class="nav-link">üìä Analysis</a>
      <a href="import.html" class="nav-link">üìÅ Import</a>
      <a href="settings.html" class="nav-link active">‚öôÔ∏è Settings</a>
    </nav>
    <div class="auth-section">
      <span class="user-info" id="userInfo"></span>
      <button class="sign-in-btn" id="authBtn" onclick="handleAuth()">Sign In to Edit</button>
    </div>
  </div>

  <div class="settings-container">
    <div class="settings-card" style="border: 2px solid #3b82f6; background: linear-gradient(to right, #eff6ff, white);">
      <h3>‚òÅÔ∏è Google Sheets Connection</h3>
      <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.875rem;">Connect to a Google Sheet to sync your data across devices and share with your team.</p>
      
      <div class="threshold-grid">
        <div class="threshold-row" style="flex-direction: column; align-items: stretch; gap: 0.5rem;">
          <label style="font-weight: 600; color: #374151;">Google Sheet ID</label>
          <input type="text" id="sheetId" placeholder="Enter your Google Sheet ID" style="width: 100%; font-family: monospace;">
          <small style="color: #64748b;">Find this in your Google Sheet URL: docs.google.com/spreadsheets/d/<strong>[SHEET_ID]</strong>/edit</small>
        </div>
        <div class="threshold-row" style="flex-direction: column; align-items: stretch; gap: 0.5rem;">
          <label style="font-weight: 600; color: #374151;">Operation Name</label>
          <input type="text" id="operationName" placeholder="e.g., Smith Family Farms" style="width: 100%;">
        </div>
      </div>
      
      <div style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.875rem; color: #374151;">üìã Setup Instructions for New Users:</h4>
        <ol style="margin: 0; padding-left: 1.25rem; color: #64748b; font-size: 0.8125rem; line-height: 1.6;">
          <li>Create a new Google Sheet</li>
          <li>Create 3 tabs named exactly: <strong>Samples</strong>, <strong>Fields</strong>, <strong>Settings</strong></li>
          <li>Copy the Sheet ID from the URL and paste above</li>
          <li>Share the sheet with anyone who needs access</li>
          <li>Click "Save Settings" below</li>
        </ol>
        <button class="button" style="margin-top: 1rem; background: #3b82f6; color: white;" onclick="window.open('https://docs.google.com/spreadsheets/create', '_blank')">
          üìÑ Create New Google Sheet
        </button>
      </div>
      
      <div class="btn-row" style="margin-top: 1rem;">
        <button class="button primary" onclick="saveSheetConfig()">üíæ Save Sheet Configuration</button>
        <button class="button secondary" onclick="testSheetConnection()">üîó Test Connection</button>
      </div>
      <div id="connectionStatus" style="margin-top: 0.75rem;"></div>
    </div>

    <div class="settings-card" style="border: 2px solid #3b82f6; background: linear-gradient(to right, #eff6ff, white);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
        <h3 style="margin: 0;">üÜï What's New</h3>
        <span id="currentVersion" style="font-size: 0.8rem; color: #3b82f6; font-weight: 600;"></span>
      </div>
      <div id="whatsNewContent" style="font-size: 0.85rem; color: #475569;"></div>
      <div style="margin-top: 0.75rem;">
        <a href="CHANGELOG.md" target="_blank" style="color: #3b82f6; font-size: 0.8rem; text-decoration: none;">View full changelog ‚Üí</a>
      </div>
    </div>

    <div class="settings-card" style="border: 2px solid #059669; background: linear-gradient(to right, #ecfdf5, white);">
      <h3>üíæ Data Backup</h3>
      <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.875rem;">Automatic backups keep your data safe. Backups are stored locally and can be downloaded as JSON files.</p>

      <div class="threshold-grid">
        <div class="threshold-row" style="flex-direction: column; align-items: stretch; gap: 0.5rem;">
          <label style="font-weight: 600; color: #374151;">Auto-backup Frequency</label>
          <select id="autoBackupFrequency" style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem;">
            <option value="never">Never</option>
            <option value="weekly" selected>Weekly (recommended)</option>
            <option value="after-import">After each import</option>
          </select>
          <small style="color: #64748b;">Weekly: prompts to download backup every 7 days. After import: auto-downloads after each data import.</small>
        </div>
      </div>

      <div id="backupStatusSettings" style="margin-top: 1rem; padding: 0.75rem; border-radius: 0.375rem; font-size: 0.8125rem;"></div>

      <div class="btn-row" style="margin-top: 1rem;">
        <button class="button" style="background: #059669; color: white;" onclick="downloadBackupNow()">üíæ Download Backup Now</button>
      </div>
    </div>

    <div class="settings-card">
      <h3>üß™ pH</h3>
      <div class="threshold-grid">
        <div class="threshold-row"><span class="name">Optimal Range</span><span class="note"></span><div class="inputs"><input type="number" id="pH_min" step="0.1" value="6.3"><span>to</span><input type="number" id="pH_max" step="0.1" value="6.9"></div></div>
      </div>
    </div>
    <div class="settings-card">
      <h3>üåø Macronutrients</h3>
      <div class="threshold-grid">
        <div class="threshold-row"><span class="name">Phosphorus (P)</span><span class="note"></span><div class="inputs"><span>Min:</span><input type="number" id="P_min" value="20"><span class="unit">ppm</span></div></div>
        <div class="threshold-row"><span class="name">Potassium (K)</span><span class="note"></span><div class="inputs"><span>Min:</span><input type="number" id="K_min" value="150"><span class="unit">ppm</span></div></div>
        <div class="threshold-row"><span class="name">Organic Matter (OM)</span><span class="note"></span><div class="inputs"><span>Min:</span><input type="number" id="OM_min" step="0.1" value="3.0"><span class="unit">%</span></div></div>
      </div>
    </div>
    <div class="settings-card">
      <h3>‚öñÔ∏è Base Saturation</h3>
      <div class="threshold-grid">
        <div class="threshold-row"><span class="name">Calcium (Ca)</span><span class="note"></span><div class="inputs"><input type="number" id="Ca_sat_min" value="65"><span>to</span><input type="number" id="Ca_sat_max" value="75"><span class="unit">%</span></div></div>
        <div class="threshold-row"><span class="name">Magnesium (Mg)</span><span class="note">* Lower is better</span><div class="inputs"><input type="number" id="Mg_sat_min" step="0.1" value="12"><span>to</span><input type="number" id="Mg_sat_max" step="0.1" value="15"><span class="unit">%</span></div></div>
        <div class="threshold-row"><span class="name">Potassium (K)</span><span class="note"></span><div class="inputs"><span>Min:</span><input type="number" id="K_sat_min" step="0.1" value="3.0"><span class="unit">%</span></div></div>
        <div class="threshold-row"><span class="name">Hydrogen (H)</span><span class="note">* Lower is better</span><div class="inputs"><span>Max:</span><input type="number" id="H_sat_max" step="0.1" value="5.0"><span class="unit">%</span></div></div>
      </div>
    </div>
    <div class="settings-card">
      <h3>üé® Display</h3>
      <div class="threshold-grid">
        <div class="threshold-row"><span class="name">Buffer Zone</span><span class="note">Yellow warning zone width</span><div class="inputs"><input type="number" id="bufferPercent" value="25"><span class="unit">%</span></div></div>
      </div>
    </div>

    <div class="settings-card">
      <h3>üî¢ Decimal Places</h3>
      <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.875rem;">Configure decimal precision for each attribute. Changes apply to map markers, analysis tables, charts, and exports.</p>
      <div id="decimalPlacesGrid" class="nutrient-grid-vis" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));"></div>
    </div>

    <div class="settings-card">
      <h3>üìã Column Mapping</h3>
      <p style="color: #64748b; margin-bottom: 0.5rem; font-size: 0.875rem;">Map column names from your lab files to standard soil attributes. Add aliases so the app recognizes your lab's column headers.</p>
      <div style="display: flex; gap: 1rem; margin-bottom: 1rem; font-size: 0.75rem;">
        <span><span style="background: #e2e8f0; padding: 0.15rem 0.4rem; border-radius: 0.25rem; color: #475569;">gray</span> = built-in</span>
        <span><span style="background: #dbeafe; padding: 0.15rem 0.4rem; border-radius: 0.25rem; color: #1e40af;">blue</span> = custom (removable)</span>
      </div>
      <div id="columnMappingGrid" style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 500px; overflow-y: auto;"></div>
    </div>

    <div class="settings-card">
      <h3>üëÅÔ∏è Nutrient Visibility</h3>
      <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.875rem;">Choose which nutrients to show in dropdowns and analysis.</p>
      <div id="nutrientVisibility" class="nutrient-grid-vis"></div>
    </div>
    
    <div class="btn-row">
      <button class="button primary" id="saveBtn">üíæ Save Settings</button>
      <button class="button secondary" id="resetBtn">üîÑ Reset to Defaults</button>
    </div>
  </div>
  <div id="statusMessage"></div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script>
    // ========== APP VERSION ==========
    const APP_VERSION = "v1.0.7";
    const BUILD_DATE = "2026-01-14T16:24:35";

    const CONFIG = {
      CLIENT_ID: '714780458094-9rde31taeottmavhl5t0uo8b9kfpergc.apps.googleusercontent.com', 
      API_KEY: 'AIzaSyCOSDbrAlc3ct2-lRvJv1y7V0nV7haWc9E', 
      get SHEET_ID() { return localStorage.getItem('googleSheetId') || '1buu-8KXoM1kRJSOAWtHaAk40seQT5kqGFY9RICYwdRY'; }
    };
    const defaults = { pH_min: 6.3, pH_max: 6.9, P_min: 20, K_min: 150, OM_min: 3.0, Ca_sat_min: 65, Ca_sat_max: 75, Mg_sat_min: 12, Mg_sat_max: 15, K_sat_min: 3.0, H_sat_max: 5.0, bufferPercent: 25 };
    
    // All nutrients with display names and default visibility
    const ALL_NUTRIENTS = {
      sampleId: { name: 'Sample ID', defaultVisible: true },
      pH: { name: 'pH', defaultVisible: true },
      P: { name: 'Phosphorus (P)', defaultVisible: true },
      K: { name: 'Potassium (K)', defaultVisible: true },
      OM: { name: 'Organic Matter', defaultVisible: true },
      CEC: { name: 'CEC', defaultVisible: true },
      Ca_sat: { name: 'Calcium %', defaultVisible: true },
      Mg_sat: { name: 'Magnesium %', defaultVisible: true },
      K_Sat: { name: 'K Base Sat %', defaultVisible: true },
      H_Sat: { name: 'H Base Sat %', defaultVisible: true },
      Zn: { name: 'Zinc', defaultVisible: true },
      Cu: { name: 'Copper', defaultVisible: true },
      Mn: { name: 'Manganese', defaultVisible: true },
      Fe: { name: 'Iron', defaultVisible: true },
      Boron: { name: 'Boron', defaultVisible: true },
      S: { name: 'Sulfur', defaultVisible: true },
      Buffer_pH: { name: 'Buffer pH', defaultVisible: true },
      // Hidden by default
      P2: { name: 'Phosphorus P2', defaultVisible: false },
      Na_Sat: { name: 'Na Base Sat %', defaultVisible: false },
      Na: { name: 'Sodium', defaultVisible: false },
      Ca: { name: 'Calcium (ppm)', defaultVisible: false },
      Mg: { name: 'Magnesium (ppm)', defaultVisible: false },
      NO3: { name: 'Nitrate', defaultVisible: false },
      NH4: { name: 'Ammonium', defaultVisible: false },
      Soluble_Salts: { name: 'Soluble Salts', defaultVisible: false },
      EC: { name: 'EC', defaultVisible: false }
    };

    // Default decimal places for each attribute
    const DEFAULT_DECIMAL_PLACES = {
      pH: 2,
      Buffer_pH: 2,
      OM: 2,
      P: 0,
      P2: 0,
      K: 0,
      CEC: 1,
      Ca_sat: 1,
      Mg_sat: 1,
      K_Sat: 1,
      H_Sat: 1,
      Na_Sat: 1,
      Zn: 2,
      Cu: 2,
      Mn: 1,
      Fe: 1,
      Boron: 2,
      S: 1,
      Ca: 0,
      Mg: 0,
      Na: 0,
      NO3: 1,
      NH4: 1,
      Soluble_Salts: 2,
      EC: 2
    };

    // Default column aliases (must match import.html)
    const DEFAULT_ALIASES = {
      'P': ['P', 'P (M3)', 'P_M3', 'Phosphorus', 'Bray_P1', 'Bray P1', 'Mehlich2_P', 'Mehlich P', 'M3P', 'Olsen P', 'P1', 'P ppm'],
      'P2': ['P2', 'Bray_P2', 'Bray P2', 'P2 ppm'],
      'pH': ['pH', 'pH (1_1)', 'pH_1_1', 'ph', 'Soil_pH', 'pH 1:1', 'pH_s', 'soil pH'],
      'K': ['K', 'K (M3)', 'K_M3', 'Potassium', 'ExchK', 'Exch K', 'Mehlich K', 'M3K', 'K ppm'],
      'OM': ['OM', 'OM (LOI)', 'OM_LOI', 'Organic_Matter', 'Organic Matter', 'O.M.', 'OM %', 'SOM'],
      'CEC': ['CEC', 'CEC (Calc)', 'CEC_Calc', 'CEC (Cal_1', 'CEC meq'],
      'Ca_sat': ['Ca_sat', 'BS-Ca', 'BS_Ca', 'Ca_Base_Sat', 'Ca_Sat', 'Ca %', 'Ca Sat', '% Ca'],
      'Mg_sat': ['Mg_sat', 'BS-Mg', 'BS_Mg', 'Mg_Base_Sat', 'Mg_Sat', 'Mg %', 'Mg Sat', '% Mg'],
      'K_Sat': ['K_Sat', 'BS-K', 'BS_K', 'K_Base_Sat', 'K %', 'K Sat', '% K'],
      'H_Sat': ['H_Sat', 'BS-H', 'BS_H', 'H_Base_Sat', 'H %', 'H Sat', '% H'],
      'Na_Sat': ['Na_Sat', 'BS-Na', 'BS_Na', 'Na_Base_Sat', 'Na %', 'Na Sat', '% Na'],
      'Zn': ['Zn', 'Zn (M3)', 'Zn_M3', 'Zinc', 'Mehlich Zn'],
      'Cu': ['Cu', 'Cu (M3)', 'Cu_M3', 'Copper', 'Mehlich Cu'],
      'Mn': ['Mn', 'Mn (M3)', 'Mn_M3', 'Manganese', 'Mehlich Mn'],
      'Fe': ['Fe', 'Fe (M3)', 'Fe_M3', 'Iron', 'Mehlich Fe'],
      'Boron': ['Boron', 'B (M3)', 'B_M3', 'B'],
      'S': ['S', 'S (M3)', 'S_M3', 'Sulfur', 'SO4', 'SO4-S'],
      'Buffer_pH': ['Buffer_pH', 'BpH', 'Buffer pH', 'SMP', 'SMP pH', 'Buffer'],
      'Na': ['Na', 'Sodium', 'Na (M3)', 'ExchNa', 'Exch Na'],
      'Ca': ['Ca', 'Calcium', 'Ca (M3)', 'ExchCa', 'Exch Ca'],
      'Mg': ['Mg', 'Magnesium', 'Mg (M3)', 'ExchMg', 'Exch Mg'],
      'NO3': ['NO3', 'NO3-N', 'Nitrate', 'Nitrate-N', 'N03'],
      'NH4': ['NH4', 'NH4-N', 'Ammonium', 'Ammonium-N'],
      'Soluble_Salts': ['Soluble_Salts', 'Soluble_Sal', 'Sol_Salts', 'Salts', 'SS'],
      'EC': ['EC', 'EC (1:1)', 'Electrical Conductivity']
    };

    let tokenClient;
    let accessToken = null;
    let tokenExpiry = null;
    
    const SheetsAPI = {
      isSignedIn: false,
      async init() {
        return new Promise((resolve, reject) => {
          gapi.load('client', async () => {
            try {
              await gapi.client.init({ apiKey: CONFIG.API_KEY, discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'] });
              tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (response) => {
                  if (response.error) return;
                  accessToken = response.access_token;
                  tokenExpiry = Date.now() + (response.expires_in * 1000) - 60000;
                  localStorage.setItem('googleAccessToken', accessToken);
                  localStorage.setItem('googleTokenExpiry', tokenExpiry.toString());
                  gapi.client.setToken({ access_token: accessToken });
                  this.isSignedIn = true;
                  this.onSignInChange(true);
                },
              });
              // Check for saved token
              const savedToken = localStorage.getItem('googleAccessToken');
              const savedExpiry = localStorage.getItem('googleTokenExpiry');
              if (savedToken && savedExpiry && Date.now() < parseInt(savedExpiry)) {
                accessToken = savedToken;
                tokenExpiry = parseInt(savedExpiry);
                gapi.client.setToken({ access_token: accessToken });
                this.isSignedIn = true;
                this.onSignInChange(true);
              }
              resolve(true);
            } catch (e) { reject(e); }
          });
        });
      },
      async signIn() { tokenClient.requestAccessToken({ prompt: 'consent' }); },
      async signOut() { 
        if (accessToken) google.accounts.oauth2.revoke(accessToken);
        accessToken = null;
        tokenExpiry = null;
        localStorage.removeItem('googleAccessToken');
        localStorage.removeItem('googleTokenExpiry');
        this.isSignedIn = false;
        this.onSignInChange(false);
      },
      onSignInChange(s) {}
    };

    document.addEventListener('DOMContentLoaded', async () => {
      loadSettings();
      updateBackupFooter();
      initWhatsNew();
      try { await SheetsAPI.init(); SheetsAPI.onSignInChange = handleSignInChange; handleSignInChange(SheetsAPI.isSignedIn); } catch (e) {}
      document.getElementById('saveBtn').addEventListener('click', saveSettings);
      document.getElementById('resetBtn').addEventListener('click', resetSettings);
    });

    function initWhatsNew() {
      // Display current version
      const buildDate = new Date(BUILD_DATE);
      const buildStr = buildDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      document.getElementById('currentVersion').textContent = `${APP_VERSION} ‚Ä¢ ${buildStr}`;

      // Show recent changes
      const whatsNew = document.getElementById('whatsNewContent');
      whatsNew.innerHTML = `
        <ul style="margin: 0; padding-left: 1.25rem; line-height: 1.6;">
          <li><strong>Version tracking</strong> - See app version and build date in footer</li>
          <li><strong>Data verification</strong> - Check yield correlation calculations</li>
          <li><strong>Yield search radius</strong> - Shows import distance setting</li>
          <li><strong>Multi-year yield modes</strong> - Average, Combined, or specific year</li>
          <li><strong>Enhanced scatter plots</strong> - Trend lines, R¬≤, threshold analysis</li>
        </ul>
      `;
    }

    async function handleAuth() { if (SheetsAPI.isSignedIn) await SheetsAPI.signOut(); else await SheetsAPI.signIn(); }
    function handleSignInChange(isSignedIn) {
      const authBtn = document.getElementById('authBtn'), userInfo = document.getElementById('userInfo');
      if (isSignedIn) { userInfo.textContent = 'Connected'; authBtn.textContent = '‚úì Signed In'; authBtn.classList.add('signed-in'); }
      else { userInfo.textContent = ''; authBtn.textContent = 'Sign In to Edit'; authBtn.classList.remove('signed-in'); }
    }
    function loadSettings() { try { const saved = localStorage.getItem('soilSettings'), settings = saved ? JSON.parse(saved) : defaults; Object.entries(settings).forEach(([k, v]) => { const i = document.getElementById(k); if (i) i.value = v; }); loadColumnMapping(); loadNutrientVisibility(); loadDecimalPlaces(); loadSheetConfig(); loadBackupSettings(); } catch (e) {} }

    // ========== BACKUP SETTINGS ==========
    function loadBackupSettings() {
      const frequency = localStorage.getItem('autoBackupFrequency') || 'weekly';
      document.getElementById('autoBackupFrequency').value = frequency;
      document.getElementById('autoBackupFrequency').addEventListener('change', saveBackupFrequency);
      updateBackupStatusDisplay();
    }

    function saveBackupFrequency() {
      const frequency = document.getElementById('autoBackupFrequency').value;
      localStorage.setItem('autoBackupFrequency', frequency);
      showStatus('Backup frequency saved', true);
    }

    function updateBackupStatusDisplay() {
      const container = document.getElementById('backupStatusSettings');
      const lastDownload = localStorage.getItem('lastBackupDownload');
      const sampleData = JSON.parse(localStorage.getItem('soilSamples') || '[]');

      if (sampleData.length === 0) {
        container.style.background = '#f8fafc';
        container.style.border = '1px solid #e2e8f0';
        container.innerHTML = '<span style="color: #64748b;">No data to backup yet</span>';
        return;
      }

      const now = Date.now();
      const daysSince = lastDownload ? Math.floor((now - parseInt(lastDownload)) / (1000 * 60 * 60 * 24)) : null;

      let statusBg, statusBorder, statusColor, statusIcon, statusText;

      if (!lastDownload) {
        statusIcon = '‚ö†Ô∏è';
        statusText = `No backup file downloaded yet (${sampleData.length} samples at risk)`;
        statusBg = '#fef2f2';
        statusBorder = '#fca5a5';
        statusColor = '#991b1b';
      } else if (daysSince > 30) {
        statusIcon = '‚ö†Ô∏è';
        statusText = `Last backup: ${formatDate(parseInt(lastDownload))} (${daysSince} days ago)`;
        statusBg = '#fffbeb';
        statusBorder = '#fcd34d';
        statusColor = '#92400e';
      } else {
        statusIcon = '‚úì';
        statusText = `Last backup: ${formatDate(parseInt(lastDownload))} (${sampleData.length} samples)`;
        statusBg = '#f0fdf4';
        statusBorder = '#86efac';
        statusColor = '#166534';
      }

      container.style.background = statusBg;
      container.style.border = `1px solid ${statusBorder}`;
      container.innerHTML = `<span style="color: ${statusColor};">${statusIcon} ${statusText}</span>`;
    }

    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function downloadBackupNow() {
      const sampleData = JSON.parse(localStorage.getItem('soilSamples') || '[]');
      const fieldBoundaries = JSON.parse(localStorage.getItem('fieldBoundaries') || '{}');

      if (sampleData.length === 0 && Object.keys(fieldBoundaries).length === 0) {
        showStatus('No data to backup', false);
        return;
      }

      const backup = {
        version: 1,
        exportDate: new Date().toISOString(),
        operationName: localStorage.getItem('operationName') || 'SoilData',
        sampleData: sampleData,
        fieldBoundaries: fieldBoundaries,
        settings: JSON.parse(localStorage.getItem('soilSettings') || '{}'),
        columnAliases: JSON.parse(localStorage.getItem('columnAliases') || '{}'),
        nutrientVisibility: JSON.parse(localStorage.getItem('nutrientVisibility') || '{}'),
        decimalPlaces: JSON.parse(localStorage.getItem('decimalPlaces') || '{}')
      };

      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      const opName = (backup.operationName || 'SoilData').replace(/[^a-zA-Z0-9]/g, '_');
      link.download = `${opName}_backup_${new Date().toISOString().split('T')[0]}.json`;
      link.click();

      localStorage.setItem('lastBackupDownload', Date.now().toString());
      updateBackupStatusDisplay();
      showStatus(`‚úì Backup downloaded (${sampleData.length} samples, ${Object.keys(fieldBoundaries).length} fields)`, true);
    }

    // Column Mapping - editable aliases for all soil attributes
    function loadColumnMapping() {
      const customAliases = JSON.parse(localStorage.getItem('columnAliases') || '{}');
      const hiddenAliases = JSON.parse(localStorage.getItem('hiddenBuiltInAliases') || '{}');
      const container = document.getElementById('columnMappingGrid');

      let html = '';
      for (const [key, info] of Object.entries(ALL_NUTRIENTS)) {
        const defaultAliases = DEFAULT_ALIASES[key] || [];
        const hiddenForKey = hiddenAliases[key] || [];
        const visibleDefaultAliases = defaultAliases.filter(a => !hiddenForKey.includes(a));
        const userAliases = customAliases[key] || [];

        html += `
          <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div style="min-width: 140px;">
                <div style="font-weight: 600; color: #1e293b;">${info.name}</div>
                <div style="font-size: 0.7rem; color: #64748b; font-family: monospace;">${key}</div>
              </div>
              <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 0.25rem; align-items: center;">
                <input type="text" id="alias_input_${key}" placeholder="+ add alias"
                  style="width: 100px; padding: 0.2rem 0.5rem; border: 1px dashed #cbd5e1; border-radius: 0.25rem; font-size: 0.8rem; background: white;"
                  onkeypress="if(event.key==='Enter'){addAlias('${key}');event.preventDefault();}">
                <button onclick="addAlias('${key}')" style="background: #3b82f6; color: white; border: none; padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">Add</button>
              </div>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; padding-left: 0.5rem;">
              ${visibleDefaultAliases.map(a => {
                const escapedAlias = a.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                return `
                <span style="background: #e2e8f0; padding: 0.15rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-flex; align-items: center; color: #475569;" title="Built-in alias - click √ó to hide">
                  ${a}<button onclick="hideBuiltInAlias('${key}', '${escapedAlias}')" style="background: #cbd5e1; border: none; cursor: pointer; color: #64748b; font-weight: bold; padding: 0 4px; line-height: 1; font-size: 1rem; border-radius: 3px; margin-left: 3px;" title="Hide this alias" onmouseover="this.style.background='#94a3b8';this.style.color='#dc2626'" onmouseout="this.style.background='#cbd5e1';this.style.color='#64748b'">√ó</button>
                </span>`;
              }).join('')}
              ${userAliases.map(a => {
                const escapedAlias = a.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                return `
                <span style="background: #dbeafe; padding: 0.15rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.25rem; color: #1e40af;" title="Custom alias - click √ó to remove">
                  ${a}<button onclick="removeAlias('${key}', '${escapedAlias}')" style="background: #bfdbfe; border: none; cursor: pointer; color: #dc2626; font-weight: bold; padding: 0 4px; line-height: 1; font-size: 1rem; border-radius: 3px; margin-left: 3px;" title="Remove this alias" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#bfdbfe'">√ó</button>
                </span>`;
              }).join('')}
              ${hiddenForKey.length > 0 ? `<button onclick="restoreHiddenAliases('${key}')" style="background: #fef3c7; border: 1px solid #fcd34d; color: #92400e; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; cursor: pointer; margin-left: 0.25rem;" title="Restore ${hiddenForKey.length} hidden alias(es)">+${hiddenForKey.length} hidden</button>` : ''}
            </div>
          </div>
        `;
      }
      container.innerHTML = html;
    }

    function addAlias(standardField) {
      const input = document.getElementById('alias_input_' + standardField);
      const newAlias = input.value.trim();
      if (!newAlias) return;

      const customAliases = JSON.parse(localStorage.getItem('columnAliases') || '{}');
      if (!customAliases[standardField]) customAliases[standardField] = [];

      // Check if alias already exists in custom aliases
      if (customAliases[standardField].map(a => a.toLowerCase()).includes(newAlias.toLowerCase())) {
        showStatus('Custom alias already exists', false);
        return;
      }

      // Check if alias already exists in default aliases
      const defaultAliases = DEFAULT_ALIASES[standardField] || [];
      if (defaultAliases.map(a => a.toLowerCase()).includes(newAlias.toLowerCase())) {
        showStatus('This is already a built-in alias', false);
        return;
      }

      customAliases[standardField].push(newAlias);
      localStorage.setItem('columnAliases', JSON.stringify(customAliases));
      input.value = '';
      loadColumnMapping();
      showStatus('Alias added: ' + newAlias + ' ‚Üí ' + standardField, true);
    }

    // Nutrient Visibility - simple checkbox grid
    function loadNutrientVisibility() {
      const saved = JSON.parse(localStorage.getItem('nutrientVisibility') || '{}');
      const container = document.getElementById('nutrientVisibility');

      let html = '';
      for (const [key, info] of Object.entries(ALL_NUTRIENTS)) {
        const isVisible = saved[key] !== undefined ? saved[key] : info.defaultVisible;
        html += `
          <div class="nutrient-toggle">
            <input type="checkbox" id="vis_${key}" ${isVisible ? 'checked' : ''} onchange="saveNutrientVisibility()">
            <label for="vis_${key}">${info.name}</label>
          </div>
        `;
      }
      container.innerHTML = html;
    }

    function saveNutrientVisibility() {
      const visibility = {};
      for (const key of Object.keys(ALL_NUTRIENTS)) {
        const checkbox = document.getElementById('vis_' + key);
        if (checkbox) visibility[key] = checkbox.checked;
      }
      localStorage.setItem('nutrientVisibility', JSON.stringify(visibility));
    }

    // Decimal Places - number input grid
    function loadDecimalPlaces() {
      const saved = JSON.parse(localStorage.getItem('decimalPlaces') || '{}');
      const container = document.getElementById('decimalPlacesGrid');

      // Order: most commonly used attributes first
      const orderedKeys = ['pH', 'Buffer_pH', 'P', 'K', 'OM', 'CEC', 'Ca_sat', 'Mg_sat', 'K_Sat', 'H_Sat', 'Zn', 'Cu', 'Mn', 'Fe', 'Boron', 'S', 'P2', 'Na_Sat', 'Na', 'Ca', 'Mg', 'NO3', 'NH4', 'Soluble_Salts', 'EC'];

      let html = '';
      for (const key of orderedKeys) {
        const info = ALL_NUTRIENTS[key];
        if (!info) continue;
        const decimals = saved[key] !== undefined ? saved[key] : (DEFAULT_DECIMAL_PLACES[key] ?? 1);
        html += `
          <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f8fafc; border-radius: 0.375rem;">
            <label for="dec_${key}" style="flex: 1; font-weight: 500; font-size: 0.875rem;">${info.name}</label>
            <select id="dec_${key}" onchange="saveDecimalPlaces()" style="padding: 0.35rem 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.25rem; font-size: 0.875rem;">
              <option value="0" ${decimals === 0 ? 'selected' : ''}>0</option>
              <option value="1" ${decimals === 1 ? 'selected' : ''}>1</option>
              <option value="2" ${decimals === 2 ? 'selected' : ''}>2</option>
              <option value="3" ${decimals === 3 ? 'selected' : ''}>3</option>
            </select>
          </div>
        `;
      }
      container.innerHTML = html;
    }

    function saveDecimalPlaces() {
      const decimals = {};
      const orderedKeys = ['pH', 'Buffer_pH', 'P', 'K', 'OM', 'CEC', 'Ca_sat', 'Mg_sat', 'K_Sat', 'H_Sat', 'Zn', 'Cu', 'Mn', 'Fe', 'Boron', 'S', 'P2', 'Na_Sat', 'Na', 'Ca', 'Mg', 'NO3', 'NH4', 'Soluble_Salts', 'EC'];
      for (const key of orderedKeys) {
        const select = document.getElementById('dec_' + key);
        if (select) decimals[key] = parseInt(select.value, 10);
      }
      localStorage.setItem('decimalPlaces', JSON.stringify(decimals));
    }

    function removeAlias(standard, alias) {
      // Unescape the alias (in case it was escaped for the onclick handler)
      const unescapedAlias = alias.replace(/\\'/g, "'");
      const nutrientName = ALL_NUTRIENTS[standard]?.name || standard;
      if (!confirm(`Remove alias '${unescapedAlias}' from ${nutrientName}?`)) {
        return;
      }

      const aliases = JSON.parse(localStorage.getItem('columnAliases') || '{}');
      if (aliases[standard]) {
        aliases[standard] = aliases[standard].filter(a => a !== unescapedAlias);
        if (aliases[standard].length === 0) delete aliases[standard];
        localStorage.setItem('columnAliases', JSON.stringify(aliases));
        loadColumnMapping();
        showStatus(`Alias '${unescapedAlias}' removed from ${nutrientName}`, true);
      }
    }

    function hideBuiltInAlias(standard, alias) {
      const unescapedAlias = alias.replace(/\\'/g, "'");
      const nutrientName = ALL_NUTRIENTS[standard]?.name || standard;
      if (!confirm(`Hide built-in alias '${unescapedAlias}' from ${nutrientName}?\n\nYou can restore it later.`)) {
        return;
      }

      const hidden = JSON.parse(localStorage.getItem('hiddenBuiltInAliases') || '{}');
      if (!hidden[standard]) hidden[standard] = [];
      if (!hidden[standard].includes(unescapedAlias)) {
        hidden[standard].push(unescapedAlias);
        localStorage.setItem('hiddenBuiltInAliases', JSON.stringify(hidden));
        loadColumnMapping();
        showStatus(`Alias '${unescapedAlias}' hidden (click +hidden to restore)`, true);
      }
    }

    function restoreHiddenAliases(standard) {
      const nutrientName = ALL_NUTRIENTS[standard]?.name || standard;
      const hidden = JSON.parse(localStorage.getItem('hiddenBuiltInAliases') || '{}');
      const count = hidden[standard]?.length || 0;

      if (!confirm(`Restore ${count} hidden built-in alias(es) for ${nutrientName}?`)) {
        return;
      }

      delete hidden[standard];
      localStorage.setItem('hiddenBuiltInAliases', JSON.stringify(hidden));
      loadColumnMapping();
      showStatus(`${count} hidden alias(es) restored for ${nutrientName}`, true);
    }

    // Sheet Configuration Functions
    function loadSheetConfig() {
      const sheetId = localStorage.getItem('googleSheetId') || '';
      const operationName = localStorage.getItem('operationName') || '';
      document.getElementById('sheetId').value = sheetId;
      document.getElementById('operationName').value = operationName;
      
      // Update app title if operation name is set
      if (operationName) {
        const subtitle = document.querySelector('.top-bar p');
        if (subtitle) subtitle.textContent = operationName;
      }
    }
    
    function saveSheetConfig() {
      const sheetId = document.getElementById('sheetId').value.trim();
      const operationName = document.getElementById('operationName').value.trim();
      
      if (sheetId) {
        localStorage.setItem('googleSheetId', sheetId);
      } else {
        localStorage.removeItem('googleSheetId');
      }
      
      if (operationName) {
        localStorage.setItem('operationName', operationName);
      } else {
        localStorage.removeItem('operationName');
      }
      
      showStatus('‚úì Sheet configuration saved! Refresh other pages to apply.', true);
    }
    
    async function testSheetConnection() {
      const sheetId = document.getElementById('sheetId').value.trim();
      const statusEl = document.getElementById('connectionStatus');
      
      if (!sheetId) {
        statusEl.innerHTML = '<span style="color: #ef4444;">‚ö†Ô∏è Please enter a Sheet ID first</span>';
        return;
      }
      
      if (!SheetsAPI.isSignedIn) {
        statusEl.innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è Please sign in with Google first</span>';
        return;
      }
      
      statusEl.innerHTML = '<span style="color: #3b82f6;">üîÑ Testing connection...</span>';
      
      try {
        const response = await gapi.client.sheets.spreadsheets.get({
          spreadsheetId: sheetId
        });
        
        const sheets = response.result.sheets.map(s => s.properties.title);
        const requiredSheets = ['Samples', 'Fields', 'Settings'];
        const missingSheets = requiredSheets.filter(s => !sheets.includes(s));
        
        if (missingSheets.length > 0) {
          statusEl.innerHTML = `<span style="color: #f59e0b;">‚ö†Ô∏è Connected but missing tabs: ${missingSheets.join(', ')}<br><small>Please create these tabs in your Google Sheet</small></span>`;
        } else {
          statusEl.innerHTML = `<span style="color: #22c55e;">‚úì Connected successfully!<br><small>Sheet: ${response.result.properties.title}</small></span>`;
        }
      } catch (e) {
        console.error('Connection test failed:', e);
        if (e.status === 404) {
          statusEl.innerHTML = '<span style="color: #ef4444;">‚ùå Sheet not found. Check the Sheet ID.</span>';
        } else if (e.status === 403) {
          statusEl.innerHTML = '<span style="color: #ef4444;">‚ùå Access denied. Make sure you have access to this sheet.</span>';
        } else {
          statusEl.innerHTML = `<span style="color: #ef4444;">‚ùå Connection failed: ${e.message || 'Unknown error'}</span>`;
        }
      }
    }
    
    function saveSettings() { const settings = {}; Object.keys(defaults).forEach(k => { const i = document.getElementById(k); if (i) settings[k] = parseFloat(i.value) || defaults[k]; }); localStorage.setItem('soilSettings', JSON.stringify(settings)); showStatus('‚úì Settings saved', true); }
    function resetSettings() { if (!confirm('Reset all settings to defaults?')) return; Object.entries(defaults).forEach(([k, v]) => { const i = document.getElementById(k); if (i) i.value = v; }); localStorage.setItem('soilSettings', JSON.stringify(defaults)); showStatus('‚úì Settings reset', true); }
    function showStatus(msg, ok) { const el = document.getElementById('statusMessage'); el.textContent = msg; el.style.display = 'block'; el.style.background = ok ? '#dcfce7' : '#fee2e2'; el.style.color = ok ? '#166534' : '#991b1b'; setTimeout(() => el.style.display = 'none', 4000); }

    function updateBackupFooter() {
      const backupTime = localStorage.getItem('soilDataBackupTime');
      const footer = document.getElementById('backupFooter');
      const buildDate = new Date(BUILD_DATE);
      const buildStr = buildDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ', ' +
                       buildDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      const versionInfo = `App ${APP_VERSION} ‚Ä¢ Built: ${buildStr}`;

      if (backupTime) {
        const date = new Date(parseInt(backupTime));
        const backupStr = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        footer.innerHTML = `${versionInfo} <span style="margin: 0 0.5rem; color: #cbd5e1;">|</span> Data backup: ${backupStr}`;
      } else {
        footer.innerHTML = `${versionInfo} <span style="margin: 0 0.5rem; color: #cbd5e1;">|</span> No backup yet`;
      }
    }
  </script>
  <div class="backup-footer" id="backupFooter">No backup yet</div>
</body>
</html>
