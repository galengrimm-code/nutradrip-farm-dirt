<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <title>Soil Sample Analysis - Settings</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; min-height: 100vh; }
    .top-bar { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .top-bar h1 { font-size: 1.5rem; font-weight: 700; }
    .top-bar p { font-size: 0.875rem; opacity: 0.8; margin-top: 0.25rem; }
    .nav-links { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .nav-link { padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; }
    .nav-link:hover { background: rgba(255,255,255,0.2); }
    .nav-link.active { background: #3b82f6; }
    .auth-section { display: flex; align-items: center; gap: 1rem; }
    .user-info { font-size: 0.875rem; color: rgba(255,255,255,0.9); }
    .sign-in-btn { padding: 0.5rem 1rem; background: #4285f4; color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; }
    .sign-in-btn.signed-in { background: #22c55e; }
    .sign-in-btn.signed-in:hover { background: #16a34a; }
    .settings-container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }

    /* Desktop two-column layout */
    @media (min-width: 769px) {
      .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
      }
      .settings-grid .full-width {
        grid-column: 1 / -1;
      }
    }
    .settings-card { background: white; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .settings-grid .settings-card { margin-bottom: 0; } /* Grid handles spacing */
    .settings-card h3 { margin: 0 0 1rem 0; padding-bottom: 0.75rem; border-bottom: 2px solid #e2e8f0; }
    .threshold-grid { display: grid; gap: 1rem; }
    .threshold-row { display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 0.375rem; }
    .threshold-row .name { min-width: 150px; font-weight: 600; color: #374151; }
    .threshold-row .note { flex: 1; font-size: 0.75rem; color: #64748b; font-style: italic; text-align: center; }
    .threshold-row .inputs { display: flex; align-items: center; gap: 0.5rem; margin-left: auto; }
    .threshold-row input { width: 70px; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.25rem; text-align: center; }
    .threshold-row .unit { color: #64748b; font-size: 0.875rem; min-width: 30px; }
    .threshold-row .name .lower-note { display: none; } /* Hidden on desktop, shown on mobile */
    .button { padding: 0.75rem 1.5rem; border: none; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; }
    .nutrient-toggle { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f8fafc; border-radius: 0.375rem; cursor: pointer; }
    .nutrient-toggle:hover { background: #e2e8f0; }
    .nutrient-toggle input { width: 18px; height: 18px; cursor: pointer; }
    .nutrient-toggle label { cursor: pointer; font-weight: 500; }
    .nutrient-grid-vis { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; }
    .button.primary { background: #3b82f6; color: white; }
    .button.secondary { background: white; color: #374151; border: 1px solid #cbd5e1; }
    .btn-row { display: flex; gap: 1rem; flex-wrap: wrap; }
    .btn-row .button { flex: 1; }
    #statusMessage { display: none; position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 0.75rem 1rem; border-radius: 0.375rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .backup-footer { position: fixed; bottom: 0; left: 0; right: 0; background: #f8fafc; border-top: 1px solid #e2e8f0; padding: 0.25rem 1rem; font-size: 0.7rem; color: #64748b; text-align: center; z-index: 900; }

    /* Mobile responsive styles for settings */
    @media (max-width: 639px) {
      .settings-container { padding: 0.75rem; }
      .settings-card { padding: 1rem; }
      .settings-card h3 { font-size: 1rem; }

      .threshold-row {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
        padding: 0.75rem;
      }
      .threshold-row .name {
        min-width: unset;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
      }
      .threshold-row .name .lower-note {
        display: block;
        font-size: 0.65rem;
        font-weight: 400;
        color: #94a3b8;
        font-style: italic;
      }
      .threshold-row .note {
        display: none; /* Hide inline note on mobile - use .lower-note instead */
      }
      .threshold-row .inputs {
        margin-left: 0;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .threshold-row input {
        width: 65px;
        min-height: 44px;
        font-size: 16px; /* Prevent zoom on iOS */
        padding: 0.5rem;
      }
      .threshold-row .unit {
        font-size: 0.8rem;
      }
      .threshold-row .inputs > span {
        font-size: 0.8rem;
        color: #64748b;
      }

      .nutrient-grid-vis {
        grid-template-columns: repeat(2, 1fr);
      }
      .nutrient-toggle {
        padding: 0.75rem;
      }
      .nutrient-toggle input {
        width: 22px;
        height: 22px;
      }

      .btn-row {
        flex-direction: column;
      }
      .btn-row .button {
        min-height: 44px;
      }

      .nav-links {
        width: 100%;
        justify-content: center;
      }
      .auth-section {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div><h1>‚öôÔ∏è Settings</h1><p>Configure thresholds and preferences</p></div>
    <nav class="nav-links">
      <a href="index.html" class="nav-link">üìç Map</a>
      <a href="analysis.html" class="nav-link">üìä Analysis</a>
      <a href="import.html" class="nav-link">üìÅ Import</a>
      <a href="settings.html" class="nav-link active">‚öôÔ∏è Settings</a>
    </nav>
    <div class="auth-section">
      <span class="user-info" id="userInfo"></span>
      <button class="sign-in-btn" id="authBtn" onclick="handleAuth()">Sign In to Edit</button>
    </div>
  </div>

  <div class="settings-container">
    <!-- Settings Grid -->
    <div class="settings-grid">

    <div class="settings-card" style="border: 2px solid #3b82f6; background: linear-gradient(to right, #eff6ff, white);">
      <h3>‚òÅÔ∏è Google Sheets Connection</h3>
      <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.875rem;">Connect to a Google Sheet to sync your data across devices and share with your team.</p>
      
      <div class="threshold-grid">
        <div class="threshold-row" style="flex-direction: column; align-items: stretch; gap: 0.5rem;">
          <label style="font-weight: 600; color: #374151;">Google Sheet URL</label>
          <input type="text" id="sheetId" placeholder="Paste the full Google Sheet URL or just the ID" style="width: 100%; font-family: monospace;">
          <small style="color: #64748b;">Paste the full URL, e.g., https://docs.google.com/spreadsheets/d/1ABC.../edit</small>
          <p id="sheetIdDetected" style="color: #22c55e; font-size: 0.8125rem; margin: 0.25rem 0 0 0; display: none;"></p>
        </div>
        <div class="threshold-row" style="flex-direction: column; align-items: stretch; gap: 0.5rem;">
          <label style="font-weight: 600; color: #374151;">Operation Name</label>
          <input type="text" id="operationName" placeholder="e.g., Smith Family Farms" style="width: 100%;">
        </div>
      </div>
      
      <div style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
        <h4 style="margin: 0 0 0.75rem 0; font-size: 0.875rem; color: #374151;">üìã Setup Instructions for New Users:</h4>
        <ol style="margin: 0; padding-left: 1.25rem; color: #64748b; font-size: 0.8125rem; line-height: 1.6;">
          <li>Click "Create New Google Sheet" below</li>
          <li>Rename first tab to <strong>Samples</strong>, add tabs <strong>Fields</strong> and <strong>Settings</strong></li>
          <li>Copy the full URL from your browser's address bar</li>
          <li>Paste above and click "Save Sheet Configuration"</li>
        </ol>
        <div style="margin-top: 1rem;">
          <button class="button" style="background: #22c55e; color: white; width: 100%;" onclick="window.open('https://sheets.new', '_blank')">
            üìÑ Create New Google Sheet
          </button>
        </div>
      </div>
      
      <div class="btn-row" style="margin-top: 1rem;">
        <button class="button primary" onclick="saveSheetConfig()">üíæ Save Sheet Configuration</button>
        <button class="button secondary" onclick="testSheetConnection()">üîó Test Connection</button>
      </div>
      <div id="connectionStatus" style="margin-top: 0.75rem;"></div>
    </div>

    <!-- Active Operation Card -->
    <div class="settings-card" style="border: 2px solid #8b5cf6; background: linear-gradient(to right, #f5f3ff, white);">
      <h3>üè¢ Active Operation</h3>
      <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.875rem;">Select which client and farm data to view across all pages.</p>

      <div class="threshold-grid">
        <div class="threshold-row" style="flex-direction: column; align-items: stretch; gap: 0.5rem;">
          <label style="font-weight: 600; color: #374151;">Client</label>
          <select id="activeClientSelect" onchange="onActiveClientChange()" style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem;">
            <option value="all">All Clients</option>
          </select>
        </div>
        <div class="threshold-row" style="flex-direction: column; align-items: stretch; gap: 0.5rem;">
          <label style="font-weight: 600; color: #374151;">Farm</label>
          <select id="activeFarmSelect" onchange="onActiveFarmChange()" style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem;">
            <option value="all">All Farms</option>
          </select>
        </div>
      </div>

      <div id="activeOperationStats" style="margin-top: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 0.5rem; font-size: 0.8125rem; color: #64748b;"></div>
    </div>

    <!-- Manage Clients Card -->
    <div class="settings-card" style="border: 2px solid #8b5cf6; background: linear-gradient(to right, #f5f3ff, white);">
      <h3>üë• Manage Clients & Farms</h3>
      <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.875rem;">Organize your fields by client and farm for multi-operation management.</p>

      <div id="clientsTable" style="margin-bottom: 1rem;"></div>

      <button class="button primary" onclick="openClientModal()" style="width: 100%;">
        ‚ûï Add New Client
      </button>
    </div>

    <!-- Client/Farm Modal -->
    <div id="clientModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; border-radius: 0.75rem; padding: 1.5rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
        <h3 id="clientModalTitle" style="margin: 0 0 1rem 0;">Add Client</h3>

        <div style="margin-bottom: 1rem;">
          <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.5rem;">Client Name *</label>
          <input type="text" id="clientNameInput" placeholder="e.g., Smith Family Farms" style="width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem;">
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.5rem;">Farms</label>
          <div id="clientFarmsList" style="border: 1px solid #e2e8f0; border-radius: 0.375rem; max-height: 200px; overflow-y: auto;"></div>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <input type="text" id="newFarmNameInput" placeholder="New farm name" style="flex: 1; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem;">
            <button class="button secondary" onclick="addFarmToModal()">+ Add</button>
          </div>
        </div>

        <input type="hidden" id="editingClientId" value="">

        <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
          <button class="button primary" onclick="saveClientFromModal()" style="flex: 1;">üíæ Save Client</button>
          <button class="button secondary" onclick="closeClientModal()" style="flex: 1;">Cancel</button>
        </div>
      </div>
    </div>

    <div class="settings-card" style="border: 2px solid #3b82f6; background: linear-gradient(to right, #eff6ff, white);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
        <h3 style="margin: 0;">üÜï What's New</h3>
        <span id="currentVersion" style="font-size: 0.8rem; color: #3b82f6; font-weight: 600;"></span>
      </div>
      <div id="whatsNewContent" style="font-size: 0.85rem; color: #475569;"></div>
      <div style="margin-top: 0.75rem;">
        <a href="CHANGELOG.md" target="_blank" style="color: #3b82f6; font-size: 0.8rem; text-decoration: none;">View full changelog ‚Üí</a>
      </div>
    </div>

    <div class="settings-card" style="border: 2px solid #059669; background: linear-gradient(to right, #ecfdf5, white);">
      <h3>üíæ Data Backup</h3>
      <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.875rem;">Automatic backups keep your data safe. Backups are stored locally and can be downloaded as JSON files.</p>

      <div class="threshold-grid">
        <div class="threshold-row" style="flex-direction: column; align-items: stretch; gap: 0.5rem;">
          <label style="font-weight: 600; color: #374151;">Auto-backup Frequency</label>
          <select id="autoBackupFrequency" style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.375rem;">
            <option value="never">Never</option>
            <option value="weekly" selected>Weekly (recommended)</option>
            <option value="after-import">After each import</option>
          </select>
          <small style="color: #64748b;">Weekly: prompts to download backup every 7 days. After import: auto-downloads after each data import.</small>
        </div>
      </div>

      <div id="backupStatusSettings" style="margin-top: 1rem; padding: 0.75rem; border-radius: 0.375rem; font-size: 0.8125rem;"></div>

      <div class="btn-row" style="margin-top: 1rem;">
        <button class="button" style="background: #059669; color: white;" onclick="downloadBackupNow()">üíæ Download Backup Now</button>
      </div>
    </div>

    <div class="settings-card">
      <h3>üß™ pH</h3>
      <div class="threshold-grid">
        <div class="threshold-row"><span class="name">Optimal Range</span><span class="note"></span><div class="inputs"><input type="number" id="pH_min" step="0.1" value="6.3"><span>to</span><input type="number" id="pH_max" step="0.1" value="6.9"></div></div>
      </div>
    </div>
    <div class="settings-card">
      <h3>üåø Macronutrients</h3>
      <div class="threshold-grid">
        <div class="threshold-row"><span class="name">Phosphorus (P)</span><span class="note"></span><div class="inputs"><span>Min:</span><input type="number" id="P_min" value="20"><span class="unit">ppm</span></div></div>
        <div class="threshold-row"><span class="name">Potassium (K)</span><span class="note"></span><div class="inputs"><span>Min:</span><input type="number" id="K_min" value="150"><span class="unit">ppm</span></div></div>
        <div class="threshold-row"><span class="name">Organic Matter (OM)</span><span class="note"></span><div class="inputs"><span>Min:</span><input type="number" id="OM_min" step="0.1" value="3.0"><span class="unit">%</span></div></div>
      </div>
    </div>
    <div class="settings-card">
      <h3>‚öñÔ∏è Base Saturation</h3>
      <div class="threshold-grid">
        <div class="threshold-row"><span class="name">Calcium (Ca)</span><span class="note"></span><div class="inputs"><input type="number" id="Ca_sat_min" value="65"><span>to</span><input type="number" id="Ca_sat_max" value="75"><span class="unit">%</span></div></div>
        <div class="threshold-row"><span class="name">Magnesium (Mg)<span class="lower-note">‚Üì Lower is better</span></span><span class="note">* Lower is better</span><div class="inputs"><input type="number" id="Mg_sat_min" step="0.1" value="12"><span>to</span><input type="number" id="Mg_sat_max" step="0.1" value="15"><span class="unit">%</span></div></div>
        <div class="threshold-row"><span class="name">Potassium (K)</span><span class="note"></span><div class="inputs"><span>Min:</span><input type="number" id="K_sat_min" step="0.1" value="3.0"><span class="unit">%</span></div></div>
        <div class="threshold-row"><span class="name">Hydrogen (H)<span class="lower-note">‚Üì Lower is better</span></span><span class="note">* Lower is better</span><div class="inputs"><span>Max:</span><input type="number" id="H_sat_max" step="0.1" value="5.0"><span class="unit">%</span></div></div>
      </div>
    </div>
    <div class="settings-card">
      <h3>üé® Display</h3>
      <div class="threshold-grid">
        <div class="threshold-row"><span class="name">Buffer Zone</span><span class="note">Yellow warning zone width</span><div class="inputs"><input type="number" id="bufferPercent" value="25"><span class="unit">%</span></div></div>
      </div>
    </div>

    <div class="settings-card">
      <h3>üî¢ Decimal Places</h3>
      <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.875rem;">Configure decimal precision for each attribute. Changes apply to map markers, analysis tables, charts, and exports.</p>
      <div id="decimalPlacesGrid" class="nutrient-grid-vis" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));"></div>
    </div>

    <div class="settings-card">
      <h3>üìã Column Mapping</h3>
      <p style="color: #64748b; margin-bottom: 0.5rem; font-size: 0.875rem;">Map column names from your lab files to standard soil attributes. Add aliases so the app recognizes your lab's column headers.</p>
      <div style="display: flex; gap: 1rem; margin-bottom: 1rem; font-size: 0.75rem;">
        <span><span style="background: #e2e8f0; padding: 0.15rem 0.4rem; border-radius: 0.25rem; color: #475569;">gray</span> = built-in</span>
        <span><span style="background: #dbeafe; padding: 0.15rem 0.4rem; border-radius: 0.25rem; color: #1e40af;">blue</span> = custom (removable)</span>
      </div>
      <div id="columnMappingGrid" style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 500px; overflow-y: auto;"></div>
    </div>

    <div class="settings-card">
      <h3>üëÅÔ∏è Nutrient Visibility</h3>
      <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.875rem;">Choose which nutrients to show in dropdowns and analysis.</p>
      <div id="nutrientVisibility" class="nutrient-grid-vis"></div>
    </div>
    
    <div class="btn-row full-width">
      <button class="button primary" id="saveBtn">üíæ Save Settings</button>
      <button class="button secondary" id="resetBtn">üîÑ Reset to Defaults</button>
    </div>

    </div><!-- End settings-grid -->
  </div>
  <div id="statusMessage"></div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="js/core/data.js"></script>
  <script src="js/core/utils.js"></script>
  <script>
    // ========== APP VERSION ==========
    const APP_VERSION = "v1.0.108";
    const BUILD_DATE = "2026-01-22T07:19:36";

    // Reference shared data config
    const CONFIG = {
      get CLIENT_ID() { return DataCore.config.CLIENT_ID; },
      get API_KEY() { return DataCore.config.API_KEY; },
      get SHEET_ID() { return DataCore.config.SHEET_ID; }
    };
    const defaults = { pH_min: 6.3, pH_max: 6.9, P_min: 20, K_min: 150, OM_min: 3.0, Ca_sat_min: 65, Ca_sat_max: 75, Mg_sat_min: 12, Mg_sat_max: 15, K_sat_min: 3.0, H_sat_max: 5.0, bufferPercent: 25 };
    
    // All nutrients with display names and default visibility
    const ALL_NUTRIENTS = {
      sampleId: { name: 'Sample ID', defaultVisible: true },
      pH: { name: 'pH', defaultVisible: true },
      P_Zn_Ratio: { name: 'P:Zn Ratio', defaultVisible: true },
      P: { name: 'Phosphorus (P)', defaultVisible: true },
      K: { name: 'Potassium (K)', defaultVisible: true },
      OM: { name: 'Organic Matter', defaultVisible: true },
      CEC: { name: 'CEC', defaultVisible: true },
      Ca_sat: { name: 'Calcium %', defaultVisible: true },
      Mg_sat: { name: 'Magnesium %', defaultVisible: true },
      K_Sat: { name: 'K Base Sat %', defaultVisible: true },
      H_Sat: { name: 'H Base Sat %', defaultVisible: true },
      Zn: { name: 'Zinc', defaultVisible: true },
      Cu: { name: 'Copper', defaultVisible: true },
      Mn: { name: 'Manganese', defaultVisible: true },
      Fe: { name: 'Iron', defaultVisible: true },
      Boron: { name: 'Boron', defaultVisible: true },
      S: { name: 'Sulfur', defaultVisible: true },
      Buffer_pH: { name: 'Buffer pH', defaultVisible: true },
      // Hidden by default
      P2: { name: 'Phosphorus P2', defaultVisible: false },
      Na_Sat: { name: 'Na Base Sat %', defaultVisible: false },
      Na: { name: 'Sodium', defaultVisible: false },
      Ca: { name: 'Calcium (ppm)', defaultVisible: false },
      Mg: { name: 'Magnesium (ppm)', defaultVisible: false },
      NO3: { name: 'Nitrate', defaultVisible: false },
      NH4: { name: 'Ammonium', defaultVisible: false },
      Soluble_Salts: { name: 'Soluble Salts', defaultVisible: false },
      EC: { name: 'EC', defaultVisible: false }
    };

    // Default decimal places for each attribute
    const DEFAULT_DECIMAL_PLACES = {
      pH: 2,
      Buffer_pH: 2,
      OM: 2,
      P: 0,
      P2: 0,
      K: 0,
      CEC: 1,
      Ca_sat: 1,
      Mg_sat: 1,
      K_Sat: 1,
      H_Sat: 1,
      Na_Sat: 1,
      Zn: 2,
      Cu: 2,
      Mn: 1,
      Fe: 1,
      Boron: 2,
      S: 1,
      Ca: 0,
      Mg: 0,
      Na: 0,
      NO3: 1,
      NH4: 1,
      Soluble_Salts: 2,
      EC: 2,
      P_Zn_Ratio: 1
    };

    // Default column aliases (must match import.html)
    const DEFAULT_ALIASES = {
      'P': ['P', 'P (M3)', 'P_M3', 'Phosphorus', 'Bray_P1', 'Bray P1', 'Mehlich2_P', 'Mehlich P', 'M3P', 'Olsen P', 'P1', 'P ppm'],
      'P2': ['P2', 'Bray_P2', 'Bray P2', 'P2 ppm'],
      'pH': ['pH', 'pH (1_1)', 'pH_1_1', 'ph', 'Soil_pH', 'pH 1:1', 'pH_s', 'soil pH'],
      'K': ['K', 'K (M3)', 'K_M3', 'Potassium', 'ExchK', 'Exch K', 'Mehlich K', 'M3K', 'K ppm'],
      'OM': ['OM', 'OM (LOI)', 'OM_LOI', 'Organic_Matter', 'Organic Matter', 'O.M.', 'OM %', 'SOM'],
      'CEC': ['CEC', 'CEC (Calc)', 'CEC_Calc', 'CEC (Cal_1', 'CEC meq'],
      'Ca_sat': ['Ca_sat', 'BS-Ca', 'BS_Ca', 'Ca_Base_Sat', 'Ca_Sat', 'Ca %', 'Ca Sat', '% Ca'],
      'Mg_sat': ['Mg_sat', 'BS-Mg', 'BS_Mg', 'Mg_Base_Sat', 'Mg_Sat', 'Mg %', 'Mg Sat', '% Mg'],
      'K_Sat': ['K_Sat', 'BS-K', 'BS_K', 'K_Base_Sat', 'K %', 'K Sat', '% K'],
      'H_Sat': ['H_Sat', 'BS-H', 'BS_H', 'H_Base_Sat', 'H %', 'H Sat', '% H'],
      'Na_Sat': ['Na_Sat', 'BS-Na', 'BS_Na', 'Na_Base_Sat', 'Na %', 'Na Sat', '% Na'],
      'Zn': ['Zn', 'Zn (M3)', 'Zn_M3', 'Zinc', 'Mehlich Zn'],
      'Cu': ['Cu', 'Cu (M3)', 'Cu_M3', 'Copper', 'Mehlich Cu'],
      'Mn': ['Mn', 'Mn (M3)', 'Mn_M3', 'Manganese', 'Mehlich Mn'],
      'Fe': ['Fe', 'Fe (M3)', 'Fe_M3', 'Iron', 'Mehlich Fe'],
      'Boron': ['Boron', 'B (M3)', 'B_M3', 'B'],
      'S': ['S', 'S (M3)', 'S_M3', 'Sulfur', 'SO4', 'SO4-S'],
      'Buffer_pH': ['Buffer_pH', 'BpH', 'Buffer pH', 'SMP', 'SMP pH', 'Buffer'],
      'Na': ['Na', 'Sodium', 'Na (M3)', 'ExchNa', 'Exch Na'],
      'Ca': ['Ca', 'Calcium', 'Ca (M3)', 'ExchCa', 'Exch Ca'],
      'Mg': ['Mg', 'Magnesium', 'Mg (M3)', 'ExchMg', 'Exch Mg'],
      'NO3': ['NO3', 'NO3-N', 'Nitrate', 'Nitrate-N', 'N03'],
      'NH4': ['NH4', 'NH4-N', 'Ammonium', 'Ammonium-N'],
      'Soluble_Salts': ['Soluble_Salts', 'Soluble_Sal', 'Sol_Salts', 'Salts', 'SS'],
      'EC': ['EC', 'EC (1:1)', 'Electrical Conductivity']
    };

    // ========== CLIENT/FARM DATA STRUCTURES ==========
    let clientsData = [];
    let farmsData = [];
    let fieldBoundaries = {};
    let activeClientId = 'all';
    let activeFarmId = 'all';

    // Use shared functions from DataCore
    const openDB = DataCore.openDB;

    function loadClientsData() {
      clientsData = DataCore.loadClientsData();
      return clientsData;
    }

    function saveClientsData() {
      DataCore.saveClientsData(clientsData);
    }

    function loadFarmsData() {
      farmsData = DataCore.loadFarmsData();
      return farmsData;
    }

    function saveFarmsData() {
      DataCore.saveFarmsData(farmsData);
    }

    async function loadBoundariesFromIndexedDB() {
      const data = await DataCore.loadFromIndexedDB();
      return data ? data.boundaries : null;
    }

    // Load field boundaries from localStorage or IndexedDB
    async function loadFieldBoundaries() {
      try {
        // Check IndexedDB first if flagged
        if (localStorage.getItem('usingIndexedDB') === 'true') {
          const idbBoundaries = await loadBoundariesFromIndexedDB();
          if (idbBoundaries && Object.keys(idbBoundaries).length > 0) {
            fieldBoundaries = idbBoundaries;
            console.log('Loaded boundaries from IndexedDB:', Object.keys(fieldBoundaries).length, 'fields');
            return fieldBoundaries;
          }
        }
        // Fallback to localStorage
        fieldBoundaries = DataCore.loadFieldBoundaries();
      } catch (e) {
        console.error('Error loading field boundaries:', e);
        fieldBoundaries = {};
      }
      return fieldBoundaries;
    }

    // Save field boundaries to localStorage
    function saveFieldBoundaries() {
      DataCore.saveFieldBoundaries(fieldBoundaries);
    }

    // Load active selection from localStorage
    function loadActiveSelection() {
      const selection = DataCore.loadActiveSelection();
      activeClientId = selection.clientId;
      activeFarmId = selection.farmId;
    }

    // Save active selection to localStorage
    function saveActiveSelection() {
      DataCore.saveActiveSelection(activeClientId, activeFarmId);
    }

    // Migration: Convert legacy fieldBoundaries format to new format with farmId
    function migrateDataIfNeeded() {
      const dataVersion = localStorage.getItem('dataVersion');
      if (dataVersion === '2') {
        console.log('[Migration] Data already at version 2');
        return false;
      }

      console.log('[Migration] Starting migration to version 2...');

      // Load existing data
      loadFieldBoundaries();
      loadClientsData();
      loadFarmsData();

      // Clean up any auto-created default clients/farms (we no longer create defaults)
      const defaultClients = clientsData.filter(c => c.isDefault);
      const defaultFarms = farmsData.filter(f => f.isDefault);
      if (defaultClients.length > 0 || defaultFarms.length > 0) {
        // Remove default farms first
        defaultFarms.forEach(farm => {
          const idx = farmsData.findIndex(f => f.id === farm.id);
          if (idx >= 0) farmsData.splice(idx, 1);
          // Clear farmId from any fields assigned to this farm
          Object.values(fieldBoundaries).forEach(field => {
            if (field.farmId === farm.id) field.farmId = '';
          });
        });
        // Remove default clients
        defaultClients.forEach(client => {
          const idx = clientsData.findIndex(c => c.id === client.id);
          if (idx >= 0) clientsData.splice(idx, 1);
        });
        // Save cleaned data
        saveClientsData();
        saveFarmsData();
        saveFieldBoundaries();
        console.log('[Migration] Removed auto-created default clients/farms');
      }

      // Check if there's any data to migrate
      const hasLegacyBoundaries = Object.keys(fieldBoundaries).some(key => {
        const val = fieldBoundaries[key];
        // Legacy format: array of coordinates, not an object with boundary property
        return Array.isArray(val) || (val && !val.boundary);
      });

      if (!hasLegacyBoundaries) {
        console.log('[Migration] No legacy data found, setting version 2');
        localStorage.setItem('dataVersion', '2');
        return false;
      }

      // Migrate boundaries to new format WITHOUT creating default client/farm
      // Fields will have no farmId until user creates a client/farm structure
      const migratedBoundaries = {};
      let migratedCount = 0;

      Object.entries(fieldBoundaries).forEach(([fieldName, fieldData]) => {
        if (Array.isArray(fieldData)) {
          migratedBoundaries[fieldName] = {
            boundary: fieldData,
            farmId: '',
            createdAt: new Date().toISOString()
          };
          migratedCount++;
        } else if (fieldData && !fieldData.boundary) {
          migratedBoundaries[fieldName] = {
            boundary: fieldData,
            farmId: '',
            createdAt: new Date().toISOString()
          };
          migratedCount++;
        } else {
          migratedBoundaries[fieldName] = fieldData;
        }
      });

      fieldBoundaries = migratedBoundaries;

      // Set active selection to 'all'
      activeClientId = 'all';
      activeFarmId = 'all';

      // Save migrated data
      saveFieldBoundaries();
      saveActiveSelection();
      localStorage.setItem('dataVersion', '2');

      console.log(`[Migration] Complete. Migrated ${migratedCount} fields.`);
      return true;
    }

    // Get fields filtered by active client/farm selection
    // Note: fieldBoundaries must be loaded before calling this (via loadClientManagement)
    function getActiveFields() {
      const allFieldNames = Object.keys(fieldBoundaries);

      if (activeClientId === 'all' && activeFarmId === 'all') {
        return allFieldNames;
      }

      if (activeFarmId !== 'all') {
        // Filter by specific farm
        return allFieldNames.filter(fieldName => {
          const field = fieldBoundaries[fieldName];
          return field && field.farmId === activeFarmId;
        });
      }

      if (activeClientId !== 'all') {
        // Filter by client (all farms under that client)
        const clientFarmIds = farmsData
          .filter(f => f.clientId === activeClientId)
          .map(f => f.id);
        return allFieldNames.filter(fieldName => {
          const field = fieldBoundaries[fieldName];
          return field && clientFarmIds.includes(field.farmId);
        });
      }

      return allFieldNames;
    }

    // Get boundary coordinates for a field (handles both legacy and new format)
    function getFieldBoundary(fieldName) {
      const field = fieldBoundaries[fieldName];
      if (!field) return null;
      // New format has boundary property, legacy format is just the array
      return field.boundary || field;
    }

    // ========== CLIENT MANAGEMENT FUNCTIONS ==========

    // Temporary storage for farms being edited in modal
    let modalFarms = [];

    // Load and render client management UI
    async function loadClientManagement() {
      await loadFieldBoundaries();
      updateActiveClientSelector();
      updateActiveFarmSelector();
      updateActiveOperationStats();
      renderClientsTable();
    }

    // Update client dropdown in Active Operation section
    function updateActiveClientSelector() {
      const select = document.getElementById('activeClientSelect');
      if (!select) return;

      let html = '<option value="all">All Clients</option>';
      clientsData.forEach(client => {
        const selected = activeClientId === client.id ? 'selected' : '';
        html += `<option value="${client.id}" ${selected}>${client.name}</option>`;
      });
      select.innerHTML = html;
    }

    // Update farm dropdown based on selected client
    function updateActiveFarmSelector() {
      const select = document.getElementById('activeFarmSelect');
      if (!select) return;

      let farms = farmsData;
      if (activeClientId !== 'all') {
        farms = farmsData.filter(f => f.clientId === activeClientId);
      }

      let html = '<option value="all">All Farms</option>';
      farms.forEach(farm => {
        const selected = activeFarmId === farm.id ? 'selected' : '';
        const client = clientsData.find(c => c.id === farm.clientId);
        const clientPrefix = activeClientId === 'all' && client ? `${client.name} > ` : '';
        html += `<option value="${farm.id}" ${selected}>${clientPrefix}${farm.name}</option>`;
      });
      select.innerHTML = html;
    }

    // Update the stats display showing field/sample counts
    function updateActiveOperationStats() {
      const container = document.getElementById('activeOperationStats');
      if (!container) return;

      const activeFields = getActiveFields();
      const sampleData = JSON.parse(localStorage.getItem('soilSamples') || '[]');

      // Count samples in active fields
      const activeSamples = sampleData.filter(s => activeFields.includes(s.field));

      let scopeText = '';
      if (activeClientId === 'all') {
        scopeText = 'Viewing all clients';
      } else {
        const client = clientsData.find(c => c.id === activeClientId);
        if (activeFarmId === 'all') {
          scopeText = `Viewing ${client?.name || 'Unknown Client'} (all farms)`;
        } else {
          const farm = farmsData.find(f => f.id === activeFarmId);
          scopeText = `Viewing ${client?.name || 'Client'} > ${farm?.name || 'Farm'}`;
        }
      }

      container.innerHTML = `
        <strong>${scopeText}</strong><br>
        ${activeFields.length} fields, ${activeSamples.length.toLocaleString()} samples
      `;
    }

    // Handle client dropdown change
    function onActiveClientChange() {
      const select = document.getElementById('activeClientSelect');
      activeClientId = select.value;
      activeFarmId = 'all'; // Reset farm when client changes
      saveActiveSelection();
      updateActiveFarmSelector();
      updateActiveOperationStats();
      showStatus('Active client updated', true);
    }

    // Handle farm dropdown change
    function onActiveFarmChange() {
      const select = document.getElementById('activeFarmSelect');
      activeFarmId = select.value;
      saveActiveSelection();
      updateActiveOperationStats();
      showStatus('Active farm updated', true);
    }

    // Render the clients table
    function renderClientsTable() {
      const container = document.getElementById('clientsTable');
      if (!container) return;

      if (clientsData.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #64748b; background: #f8fafc; border-radius: 0.5rem;">
            <p style="margin: 0;">No clients yet. Add your first client to organize your fields.</p>
          </div>
        `;
        return;
      }

      let html = `
        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
          <thead>
            <tr style="border-bottom: 2px solid #e2e8f0;">
              <th style="text-align: left; padding: 0.5rem; color: #64748b;">Client</th>
              <th style="text-align: center; padding: 0.5rem; color: #64748b;">Farms</th>
              <th style="text-align: center; padding: 0.5rem; color: #64748b;">Fields</th>
              <th style="text-align: right; padding: 0.5rem; color: #64748b;">Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      clientsData.forEach(client => {
        const clientFarms = farmsData.filter(f => f.clientId === client.id);
        const clientFarmIds = clientFarms.map(f => f.id);
        const clientFields = Object.entries(fieldBoundaries).filter(([name, field]) =>
          field.farmId && clientFarmIds.includes(field.farmId)
        );

        html += `
          <tr style="border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 0.75rem 0.5rem;">
              <strong>${client.name}</strong>
              ${client.isDefault ? '<span style="font-size: 0.7rem; color: #8b5cf6; margin-left: 0.5rem;">(default)</span>' : ''}
            </td>
            <td style="text-align: center; padding: 0.75rem 0.5rem;">${clientFarms.length}</td>
            <td style="text-align: center; padding: 0.75rem 0.5rem;">${clientFields.length}</td>
            <td style="text-align: right; padding: 0.75rem 0.5rem;">
              <button onclick="openClientModal('${client.id}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem; margin-right: 0.25rem;">Edit</button>
              <button onclick="deleteClient('${client.id}')" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">Delete</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Open the client modal for add/edit
    function openClientModal(clientId = null) {
      const modal = document.getElementById('clientModal');
      const titleEl = document.getElementById('clientModalTitle');
      const nameInput = document.getElementById('clientNameInput');
      const editingIdInput = document.getElementById('editingClientId');

      if (clientId) {
        // Edit mode
        const client = clientsData.find(c => c.id === clientId);
        if (!client) return;

        titleEl.textContent = 'Edit Client';
        nameInput.value = client.name;
        editingIdInput.value = clientId;
        modalFarms = farmsData.filter(f => f.clientId === clientId).map(f => ({ ...f }));
      } else {
        // Add mode - start with empty farm list
        titleEl.textContent = 'Add Client';
        nameInput.value = '';
        editingIdInput.value = '';
        modalFarms = [];
      }

      renderModalFarmsList();
      modal.style.display = 'flex';
    }

    // Close the client modal
    function closeClientModal() {
      document.getElementById('clientModal').style.display = 'none';
      modalFarms = [];
    }

    // Render farms list in modal
    function renderModalFarmsList() {
      const container = document.getElementById('clientFarmsList');

      if (modalFarms.length === 0) {
        container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #64748b;">No farms yet</div>';
        return;
      }

      let html = '';
      modalFarms.forEach((farm, idx) => {
        html += `
          <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-bottom: 1px solid #e2e8f0;">
            <input type="text" value="${farm.name}" onchange="updateModalFarmName(${idx}, this.value)"
              style="flex: 1; padding: 0.35rem; border: 1px solid #cbd5e1; border-radius: 0.25rem;">
            ${farm.isDefault ? '<span style="font-size: 0.7rem; color: #8b5cf6;">(default)</span>' : ''}
            <button onclick="removeModalFarm(${idx})" style="background: #fee2e2; color: #dc2626; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;"
              ${modalFarms.length === 1 ? 'disabled title="Must have at least one farm"' : ''}>√ó</button>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    // Update farm name in modal
    function updateModalFarmName(index, newName) {
      if (modalFarms[index]) {
        modalFarms[index].name = newName;
      }
    }

    // Add farm to modal list
    function addFarmToModal() {
      const input = document.getElementById('newFarmNameInput');
      const name = input.value.trim();
      if (!name) {
        showStatus('Please enter a farm name', false);
        return;
      }

      modalFarms.push({
        id: DataCore.generateId('frm'),
        name: name,
        isNew: true
      });

      input.value = '';
      renderModalFarmsList();
    }

    // Remove farm from modal list
    function removeModalFarm(index) {
      if (modalFarms.length <= 1) {
        showStatus('Must have at least one farm', false);
        return;
      }
      modalFarms.splice(index, 1);
      renderModalFarmsList();
    }

    // Save client from modal
    function saveClientFromModal() {
      const nameInput = document.getElementById('clientNameInput');
      const editingIdInput = document.getElementById('editingClientId');

      const name = nameInput.value.trim();
      if (!name) {
        showStatus('Please enter a client name', false);
        return;
      }

      if (modalFarms.length === 0) {
        showStatus('Client must have at least one farm', false);
        return;
      }

      const editingId = editingIdInput.value;

      if (editingId) {
        // Update existing client
        const clientIndex = clientsData.findIndex(c => c.id === editingId);
        if (clientIndex !== -1) {
          clientsData[clientIndex].name = name;
          clientsData[clientIndex].updatedAt = new Date().toISOString();
        }

        // Update farms - remove old ones, add new ones
        farmsData = farmsData.filter(f => f.clientId !== editingId);
        modalFarms.forEach(farm => {
          farmsData.push({
            id: farm.id,
            clientId: editingId,
            name: farm.name,
            isDefault: farm.isDefault || false,
            createdAt: farm.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
        });

        showStatus(`Client "${name}" updated`, true);
      } else {
        // Create new client
        const newClientId = DataCore.generateId('cli');
        clientsData.push({
          id: newClientId,
          name: name,
          createdAt: new Date().toISOString()
        });

        // Add farms for new client
        modalFarms.forEach(farm => {
          farmsData.push({
            id: farm.id,
            clientId: newClientId,
            name: farm.name,
            isDefault: farm.isDefault || false,
            createdAt: new Date().toISOString()
          });
        });

        showStatus(`Client "${name}" created with ${modalFarms.length} farm(s)`, true);
      }

      saveClientsData();
      saveFarmsData();
      syncClientsAndFarmsToSheets(); // Auto-sync to Sheets
      closeClientModal();
      loadClientManagement();
    }

    // Delete a client
    function deleteClient(clientId) {
      const client = clientsData.find(c => c.id === clientId);
      if (!client) return;

      // Check for fields assigned to this client's farms
      const clientFarmIds = farmsData.filter(f => f.clientId === clientId).map(f => f.id);
      const assignedFields = Object.entries(fieldBoundaries).filter(([name, field]) =>
        field.farmId && clientFarmIds.includes(field.farmId)
      );

      let confirmMsg = `Delete client "${client.name}"?`;
      if (assignedFields.length > 0) {
        confirmMsg += `\n\nThis will also unassign ${assignedFields.length} field(s) from their farms.`;
      }

      if (!confirm(confirmMsg)) return;

      // Remove client
      clientsData = clientsData.filter(c => c.id !== clientId);

      // Remove farms
      farmsData = farmsData.filter(f => f.clientId !== clientId);

      // Unassign fields (remove farmId)
      clientFarmIds.forEach(farmId => {
        Object.entries(fieldBoundaries).forEach(([name, field]) => {
          if (field.farmId === farmId) {
            delete field.farmId;
          }
        });
      });

      // Reset active selection if needed
      if (activeClientId === clientId) {
        activeClientId = 'all';
        activeFarmId = 'all';
        saveActiveSelection();
      }

      saveClientsData();
      saveFarmsData();
      saveFieldBoundaries();
      syncClientsAndFarmsToSheets(); // Auto-sync to Sheets
      loadClientManagement();
      showStatus(`Client "${client.name}" deleted`, true);
    }

    // Use shared SheetsAPI from DataCore
    const SheetsAPI = DataCore.SheetsAPI;

    // Auto-sync clients and farms to Google Sheets
    async function syncClientsAndFarmsToSheets() {
      if (!SheetsAPI.isSignedIn || !CONFIG.SHEET_ID) return;

      try {
        // Ensure Clients tab exists
        try {
          await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: CONFIG.SHEET_ID, range: 'Clients!A1' });
        } catch (e) {
          // Create tab if it doesn't exist
          try {
            await gapi.client.sheets.spreadsheets.batchUpdate({
              spreadsheetId: CONFIG.SHEET_ID,
              resource: { requests: [{ addSheet: { properties: { title: 'Clients' } } }] }
            });
            await gapi.client.sheets.spreadsheets.values.update({
              spreadsheetId: CONFIG.SHEET_ID, range: 'Clients!A1:D1', valueInputOption: 'RAW',
              resource: { values: [['id', 'name', 'createdAt', 'updatedAt']] }
            });
          } catch (createErr) { console.warn('Could not create Clients tab'); }
        }

        // Ensure Farms tab exists
        try {
          await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: CONFIG.SHEET_ID, range: 'Farms!A1' });
        } catch (e) {
          try {
            await gapi.client.sheets.spreadsheets.batchUpdate({
              spreadsheetId: CONFIG.SHEET_ID,
              resource: { requests: [{ addSheet: { properties: { title: 'Farms' } } }] }
            });
            await gapi.client.sheets.spreadsheets.values.update({
              spreadsheetId: CONFIG.SHEET_ID, range: 'Farms!A1:E1', valueInputOption: 'RAW',
              resource: { values: [['id', 'clientId', 'name', 'createdAt', 'updatedAt']] }
            });
          } catch (createErr) { console.warn('Could not create Farms tab'); }
        }

        // Clear and write clients
        if (clientsData.length > 0) {
          // Clear existing data (rows 2+)
          try {
            const response = await gapi.client.sheets.spreadsheets.values.get({
              spreadsheetId: CONFIG.SHEET_ID, range: 'Clients!A:A'
            });
            const numRows = response.result.values ? response.result.values.length : 1;
            if (numRows > 1) {
              await gapi.client.sheets.spreadsheets.values.clear({
                spreadsheetId: CONFIG.SHEET_ID, range: `Clients!A2:D${numRows}`
              });
            }
          } catch (e) { }

          // Write clients
          const clientRows = clientsData.map(c => [c.id, c.name, c.createdAt || '', new Date().toISOString()]);
          await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: CONFIG.SHEET_ID, range: 'Clients!A:D', valueInputOption: 'RAW',
            resource: { values: clientRows }
          });
        }

        // Clear and write farms
        if (farmsData.length > 0) {
          try {
            const response = await gapi.client.sheets.spreadsheets.values.get({
              spreadsheetId: CONFIG.SHEET_ID, range: 'Farms!A:A'
            });
            const numRows = response.result.values ? response.result.values.length : 1;
            if (numRows > 1) {
              await gapi.client.sheets.spreadsheets.values.clear({
                spreadsheetId: CONFIG.SHEET_ID, range: `Farms!A2:E${numRows}`
              });
            }
          } catch (e) { }

          const farmRows = farmsData.map(f => [f.id, f.clientId, f.name, f.createdAt || '', new Date().toISOString()]);
          await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: CONFIG.SHEET_ID, range: 'Farms!A:E', valueInputOption: 'RAW',
            resource: { values: farmRows }
          });
        }

        console.log('Synced clients and farms to Sheets');
      } catch (e) {
        console.error('Error syncing clients/farms to Sheets:', e);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Run migration first to ensure data structures are up to date
      migrateDataIfNeeded();
      loadClientsData();
      loadFarmsData();
      loadActiveSelection();

      loadSettings();
      updateBackupFooter();
      initWhatsNew();
      loadClientManagement();
      try { await SheetsAPI.init(); SheetsAPI.onSignInChange = handleSignInChange; handleSignInChange(SheetsAPI.isSignedIn); } catch (e) {}
      document.getElementById('saveBtn').addEventListener('click', saveSettings);
      document.getElementById('resetBtn').addEventListener('click', resetSettings);
    });

    function initWhatsNew() {
      // Display current version
      const buildDate = new Date(BUILD_DATE);
      const buildStr = buildDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      document.getElementById('currentVersion').textContent = `${APP_VERSION} ‚Ä¢ ${buildStr}`;

      // Show recent changes
      const whatsNew = document.getElementById('whatsNewContent');
      whatsNew.innerHTML = `
        <ul style="margin: 0; padding-left: 1.25rem; line-height: 1.6;">
          <li><strong>Version tracking</strong> - See app version and build date in footer</li>
          <li><strong>Data verification</strong> - Check yield correlation calculations</li>
          <li><strong>Yield search radius</strong> - Shows import distance setting</li>
          <li><strong>Multi-year yield modes</strong> - Average, Combined, or specific year</li>
          <li><strong>Enhanced scatter plots</strong> - Trend lines, R¬≤, threshold analysis</li>
        </ul>
      `;
    }

    async function handleAuth() { if (SheetsAPI.isSignedIn) await SheetsAPI.signOut(); else await SheetsAPI.signIn(); }
    function handleSignInChange(isSignedIn) {
      const authBtn = document.getElementById('authBtn'), userInfo = document.getElementById('userInfo');
      if (isSignedIn) { userInfo.textContent = 'Connected'; authBtn.textContent = '‚úì Signed In'; authBtn.classList.add('signed-in'); }
      else { userInfo.textContent = ''; authBtn.textContent = 'Sign In to Edit'; authBtn.classList.remove('signed-in'); }
      console.log('[Sheets] Sign-in state changed:', isSignedIn);
      // Update connection status indicator when sign-in state changes
      if (typeof updateConnectionStatusIndicator === 'function') {
        updateConnectionStatusIndicator();
      }
    }
    function loadSettings() { try { const saved = localStorage.getItem('soilSettings'), settings = saved ? JSON.parse(saved) : defaults; Object.entries(settings).forEach(([k, v]) => { const i = document.getElementById(k); if (i) i.value = v; }); loadColumnMapping(); loadNutrientVisibility(); loadDecimalPlaces(); loadSheetConfig(); loadBackupSettings(); } catch (e) {} }

    // ========== BACKUP SETTINGS ==========
    function loadBackupSettings() {
      const frequency = localStorage.getItem('autoBackupFrequency') || 'weekly';
      document.getElementById('autoBackupFrequency').value = frequency;
      document.getElementById('autoBackupFrequency').addEventListener('change', saveBackupFrequency);
      updateBackupStatusDisplay();
    }

    function saveBackupFrequency() {
      const frequency = document.getElementById('autoBackupFrequency').value;
      localStorage.setItem('autoBackupFrequency', frequency);
      showStatus('Backup frequency saved', true);
    }

    function updateBackupStatusDisplay() {
      const container = document.getElementById('backupStatusSettings');
      const lastDownload = localStorage.getItem('lastBackupDownload');
      const sampleData = JSON.parse(localStorage.getItem('soilSamples') || '[]');

      if (sampleData.length === 0) {
        container.style.background = '#f8fafc';
        container.style.border = '1px solid #e2e8f0';
        container.innerHTML = '<span style="color: #64748b;">No data to backup yet</span>';
        return;
      }

      const now = Date.now();
      const daysSince = lastDownload ? Math.floor((now - parseInt(lastDownload)) / (1000 * 60 * 60 * 24)) : null;

      let statusBg, statusBorder, statusColor, statusIcon, statusText;

      if (!lastDownload) {
        statusIcon = '‚ö†Ô∏è';
        statusText = `No backup file downloaded yet (${sampleData.length} samples at risk)`;
        statusBg = '#fef2f2';
        statusBorder = '#fca5a5';
        statusColor = '#991b1b';
      } else if (daysSince > 30) {
        statusIcon = '‚ö†Ô∏è';
        statusText = `Last backup: ${formatDate(parseInt(lastDownload))} (${daysSince} days ago)`;
        statusBg = '#fffbeb';
        statusBorder = '#fcd34d';
        statusColor = '#92400e';
      } else {
        statusIcon = '‚úì';
        statusText = `Last backup: ${formatDate(parseInt(lastDownload))} (${sampleData.length} samples)`;
        statusBg = '#f0fdf4';
        statusBorder = '#86efac';
        statusColor = '#166534';
      }

      container.style.background = statusBg;
      container.style.border = `1px solid ${statusBorder}`;
      container.innerHTML = `<span style="color: ${statusColor};">${statusIcon} ${statusText}</span>`;
    }

    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function downloadBackupNow() {
      const sampleData = JSON.parse(localStorage.getItem('soilSamples') || '[]');
      const fieldBoundaries = JSON.parse(localStorage.getItem('fieldBoundaries') || '{}');

      if (sampleData.length === 0 && Object.keys(fieldBoundaries).length === 0) {
        showStatus('No data to backup', false);
        return;
      }

      const backup = {
        version: 1,
        exportDate: new Date().toISOString(),
        operationName: localStorage.getItem('operationName') || 'SoilData',
        sampleData: sampleData,
        fieldBoundaries: fieldBoundaries,
        settings: JSON.parse(localStorage.getItem('soilSettings') || '{}'),
        columnAliases: JSON.parse(localStorage.getItem('columnAliases') || '{}'),
        nutrientVisibility: JSON.parse(localStorage.getItem('nutrientVisibility') || '{}'),
        decimalPlaces: JSON.parse(localStorage.getItem('decimalPlaces') || '{}')
      };

      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      const opName = (backup.operationName || 'SoilData').replace(/[^a-zA-Z0-9]/g, '_');
      link.download = `${opName}_backup_${new Date().toISOString().split('T')[0]}.json`;
      link.click();

      localStorage.setItem('lastBackupDownload', Date.now().toString());
      updateBackupStatusDisplay();
      showStatus(`‚úì Backup downloaded (${sampleData.length} samples, ${Object.keys(fieldBoundaries).length} fields)`, true);
    }

    // Column Mapping - editable aliases for all soil attributes
    function loadColumnMapping() {
      const customAliases = JSON.parse(localStorage.getItem('columnAliases') || '{}');
      const hiddenAliases = JSON.parse(localStorage.getItem('hiddenBuiltInAliases') || '{}');
      const container = document.getElementById('columnMappingGrid');

      let html = '';
      for (const [key, info] of Object.entries(ALL_NUTRIENTS)) {
        const defaultAliases = DEFAULT_ALIASES[key] || [];
        const hiddenForKey = hiddenAliases[key] || [];
        const visibleDefaultAliases = defaultAliases.filter(a => !hiddenForKey.includes(a));
        const userAliases = customAliases[key] || [];

        html += `
          <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.75rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.375rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <div style="min-width: 140px;">
                <div style="font-weight: 600; color: #1e293b;">${info.name}</div>
                <div style="font-size: 0.7rem; color: #64748b; font-family: monospace;">${key}</div>
              </div>
              <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 0.25rem; align-items: center;">
                <input type="text" id="alias_input_${key}" placeholder="+ add alias"
                  style="width: 100px; padding: 0.2rem 0.5rem; border: 1px dashed #cbd5e1; border-radius: 0.25rem; font-size: 0.8rem; background: white;"
                  onkeypress="if(event.key==='Enter'){addAlias('${key}');event.preventDefault();}">
                <button onclick="addAlias('${key}')" style="background: #3b82f6; color: white; border: none; padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">Add</button>
              </div>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; padding-left: 0.5rem;">
              ${visibleDefaultAliases.map(a => {
                const escapedAlias = a.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                return `
                <span style="background: #e2e8f0; padding: 0.15rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-flex; align-items: center; color: #475569;" title="Built-in alias - click √ó to hide">
                  ${a}<button onclick="hideBuiltInAlias('${key}', '${escapedAlias}')" style="background: #cbd5e1; border: none; cursor: pointer; color: #64748b; font-weight: bold; padding: 0 4px; line-height: 1; font-size: 1rem; border-radius: 3px; margin-left: 3px;" title="Hide this alias" onmouseover="this.style.background='#94a3b8';this.style.color='#dc2626'" onmouseout="this.style.background='#cbd5e1';this.style.color='#64748b'">√ó</button>
                </span>`;
              }).join('')}
              ${userAliases.map(a => {
                const escapedAlias = a.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                return `
                <span style="background: #dbeafe; padding: 0.15rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.25rem; color: #1e40af;" title="Custom alias - click √ó to remove">
                  ${a}<button onclick="removeAlias('${key}', '${escapedAlias}')" style="background: #bfdbfe; border: none; cursor: pointer; color: #dc2626; font-weight: bold; padding: 0 4px; line-height: 1; font-size: 1rem; border-radius: 3px; margin-left: 3px;" title="Remove this alias" onmouseover="this.style.background='#fecaca'" onmouseout="this.style.background='#bfdbfe'">√ó</button>
                </span>`;
              }).join('')}
              ${hiddenForKey.length > 0 ? `<button onclick="restoreHiddenAliases('${key}')" style="background: #fef3c7; border: 1px solid #fcd34d; color: #92400e; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem; cursor: pointer; margin-left: 0.25rem;" title="Restore ${hiddenForKey.length} hidden alias(es)">+${hiddenForKey.length} hidden</button>` : ''}
            </div>
          </div>
        `;
      }
      container.innerHTML = html;
    }

    function addAlias(standardField) {
      const input = document.getElementById('alias_input_' + standardField);
      const newAlias = input.value.trim();
      if (!newAlias) return;

      const customAliases = JSON.parse(localStorage.getItem('columnAliases') || '{}');
      if (!customAliases[standardField]) customAliases[standardField] = [];

      // Check if alias already exists in custom aliases
      if (customAliases[standardField].map(a => a.toLowerCase()).includes(newAlias.toLowerCase())) {
        showStatus('Custom alias already exists', false);
        return;
      }

      // Check if alias already exists in default aliases
      const defaultAliases = DEFAULT_ALIASES[standardField] || [];
      if (defaultAliases.map(a => a.toLowerCase()).includes(newAlias.toLowerCase())) {
        showStatus('This is already a built-in alias', false);
        return;
      }

      customAliases[standardField].push(newAlias);
      localStorage.setItem('columnAliases', JSON.stringify(customAliases));
      input.value = '';
      loadColumnMapping();
      showStatus('Alias added: ' + newAlias + ' ‚Üí ' + standardField, true);
    }

    // Nutrient Visibility - simple checkbox grid
    function loadNutrientVisibility() {
      const saved = JSON.parse(localStorage.getItem('nutrientVisibility') || '{}');
      const container = document.getElementById('nutrientVisibility');

      let html = '';
      for (const [key, info] of Object.entries(ALL_NUTRIENTS)) {
        const isVisible = saved[key] !== undefined ? saved[key] : info.defaultVisible;
        html += `
          <div class="nutrient-toggle">
            <input type="checkbox" id="vis_${key}" ${isVisible ? 'checked' : ''} onchange="saveNutrientVisibility()">
            <label for="vis_${key}">${info.name}</label>
          </div>
        `;
      }
      container.innerHTML = html;
    }

    function saveNutrientVisibility() {
      const visibility = {};
      for (const key of Object.keys(ALL_NUTRIENTS)) {
        const checkbox = document.getElementById('vis_' + key);
        if (checkbox) visibility[key] = checkbox.checked;
      }
      localStorage.setItem('nutrientVisibility', JSON.stringify(visibility));
    }

    // Decimal Places - number input grid
    function loadDecimalPlaces() {
      const saved = JSON.parse(localStorage.getItem('decimalPlaces') || '{}');
      const container = document.getElementById('decimalPlacesGrid');

      // Order: most commonly used attributes first
      const orderedKeys = ['pH', 'Buffer_pH', 'P', 'K', 'OM', 'CEC', 'Ca_sat', 'Mg_sat', 'K_Sat', 'H_Sat', 'Zn', 'Cu', 'Mn', 'Fe', 'Boron', 'S', 'P2', 'Na_Sat', 'Na', 'Ca', 'Mg', 'NO3', 'NH4', 'Soluble_Salts', 'EC'];

      let html = '';
      for (const key of orderedKeys) {
        const info = ALL_NUTRIENTS[key];
        if (!info) continue;
        const decimals = saved[key] !== undefined ? saved[key] : (DEFAULT_DECIMAL_PLACES[key] ?? 1);
        html += `
          <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f8fafc; border-radius: 0.375rem;">
            <label for="dec_${key}" style="flex: 1; font-weight: 500; font-size: 0.875rem;">${info.name}</label>
            <select id="dec_${key}" onchange="saveDecimalPlaces()" style="padding: 0.35rem 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.25rem; font-size: 0.875rem;">
              <option value="0" ${decimals === 0 ? 'selected' : ''}>0</option>
              <option value="1" ${decimals === 1 ? 'selected' : ''}>1</option>
              <option value="2" ${decimals === 2 ? 'selected' : ''}>2</option>
              <option value="3" ${decimals === 3 ? 'selected' : ''}>3</option>
            </select>
          </div>
        `;
      }
      container.innerHTML = html;
    }

    function saveDecimalPlaces() {
      const decimals = {};
      const orderedKeys = ['pH', 'Buffer_pH', 'P', 'K', 'OM', 'CEC', 'Ca_sat', 'Mg_sat', 'K_Sat', 'H_Sat', 'Zn', 'Cu', 'Mn', 'Fe', 'Boron', 'S', 'P2', 'Na_Sat', 'Na', 'Ca', 'Mg', 'NO3', 'NH4', 'Soluble_Salts', 'EC'];
      for (const key of orderedKeys) {
        const select = document.getElementById('dec_' + key);
        if (select) decimals[key] = parseInt(select.value, 10);
      }
      localStorage.setItem('decimalPlaces', JSON.stringify(decimals));
    }

    function removeAlias(standard, alias) {
      // Unescape the alias (in case it was escaped for the onclick handler)
      const unescapedAlias = alias.replace(/\\'/g, "'");
      const nutrientName = ALL_NUTRIENTS[standard]?.name || standard;
      if (!confirm(`Remove alias '${unescapedAlias}' from ${nutrientName}?`)) {
        return;
      }

      const aliases = JSON.parse(localStorage.getItem('columnAliases') || '{}');
      if (aliases[standard]) {
        aliases[standard] = aliases[standard].filter(a => a !== unescapedAlias);
        if (aliases[standard].length === 0) delete aliases[standard];
        localStorage.setItem('columnAliases', JSON.stringify(aliases));
        loadColumnMapping();
        showStatus(`Alias '${unescapedAlias}' removed from ${nutrientName}`, true);
      }
    }

    function hideBuiltInAlias(standard, alias) {
      const unescapedAlias = alias.replace(/\\'/g, "'");
      const nutrientName = ALL_NUTRIENTS[standard]?.name || standard;
      if (!confirm(`Hide built-in alias '${unescapedAlias}' from ${nutrientName}?\n\nYou can restore it later.`)) {
        return;
      }

      const hidden = JSON.parse(localStorage.getItem('hiddenBuiltInAliases') || '{}');
      if (!hidden[standard]) hidden[standard] = [];
      if (!hidden[standard].includes(unescapedAlias)) {
        hidden[standard].push(unescapedAlias);
        localStorage.setItem('hiddenBuiltInAliases', JSON.stringify(hidden));
        loadColumnMapping();
        showStatus(`Alias '${unescapedAlias}' hidden (click +hidden to restore)`, true);
      }
    }

    function restoreHiddenAliases(standard) {
      const nutrientName = ALL_NUTRIENTS[standard]?.name || standard;
      const hidden = JSON.parse(localStorage.getItem('hiddenBuiltInAliases') || '{}');
      const count = hidden[standard]?.length || 0;

      if (!confirm(`Restore ${count} hidden built-in alias(es) for ${nutrientName}?`)) {
        return;
      }

      delete hidden[standard];
      localStorage.setItem('hiddenBuiltInAliases', JSON.stringify(hidden));
      loadColumnMapping();
      showStatus(`${count} hidden alias(es) restored for ${nutrientName}`, true);
    }

    // Sheet Configuration Functions
    function extractSheetId(input) {
      // If input contains a Google Sheets URL, extract the ID
      if (input.includes('docs.google.com') || input.includes('/d/')) {
        const match = input.match(/\/d\/([a-zA-Z0-9-_]+)/);
        if (match) return match[1];
      }
      // Otherwise assume it's already just the ID
      return input;
    }

    function loadSheetConfig() {
      const sheetId = localStorage.getItem('googleSheetId') || '';
      const operationName = localStorage.getItem('operationName') || '';
      document.getElementById('sheetId').value = sheetId;
      document.getElementById('operationName').value = operationName;

      console.log('[Sheets] Loaded sheet config:', { sheetId: sheetId ? sheetId.substring(0, 10) + '...' : '(none)', operationName });

      // Update app title if operation name is set
      if (operationName) {
        const subtitle = document.querySelector('.top-bar p');
        if (subtitle) subtitle.textContent = operationName;
      }

      // Show initial connection status
      updateConnectionStatusIndicator();
    }
    
    function saveSheetConfig() {
      const input = document.getElementById('sheetId').value.trim();
      const operationName = document.getElementById('operationName').value.trim();

      // Extract Sheet ID from URL if needed
      const sheetId = input ? extractSheetId(input) : '';

      console.log('[Sheets] Saving sheet config:', { sheetId: sheetId ? sheetId.substring(0, 10) + '...' : '(none)', operationName });

      const detectedEl = document.getElementById('sheetIdDetected');

      if (sheetId) {
        if (sheetId.length < 20) {
          showStatus('Could not find a valid Sheet ID - check the URL', false);
          detectedEl.style.display = 'none';
          return;
        }
        localStorage.setItem('googleSheetId', sheetId);
        // Show what was detected
        detectedEl.textContent = `‚úì Sheet ID detected: ${sheetId.substring(0, 25)}...`;
        detectedEl.style.display = 'block';
        // Update the input to show just the ID for clarity
        document.getElementById('sheetId').value = sheetId;
      } else {
        localStorage.removeItem('googleSheetId');
        detectedEl.style.display = 'none';
      }

      if (operationName) {
        localStorage.setItem('operationName', operationName);
      } else {
        localStorage.removeItem('operationName');
      }

      console.log('[Sheets] Sheet config saved successfully');
      showStatus('‚úì Sheet configuration saved! Refresh other pages to apply.', true);
      updateConnectionStatusIndicator();
    }

    function updateConnectionStatusIndicator() {
      const sheetId = localStorage.getItem('googleSheetId');
      const statusEl = document.getElementById('connectionStatus');

      if (!sheetId) {
        statusEl.innerHTML = '<span style="color: #64748b;">üìã No sheet configured - enter a Google Sheet URL above</span>';
      } else if (!SheetsAPI.isSignedIn) {
        statusEl.innerHTML = '<span style="color: #f59e0b;">üîë Sheet connected - sign in to test connection</span>';
      } else {
        statusEl.innerHTML = '<span style="color: #64748b;">üìã Sheet connected - click "Test Connection" to verify</span>';
      }
    }

    async function testSheetConnection() {
      const input = document.getElementById('sheetId').value.trim();
      const sheetId = input ? extractSheetId(input) : '';
      const statusEl = document.getElementById('connectionStatus');

      console.log('[Sheets] Testing connection to sheet:', sheetId);

      if (!sheetId) {
        statusEl.innerHTML = '<span style="color: #ef4444;">‚ö†Ô∏è Please enter a Sheet ID first</span>';
        return;
      }

      if (!SheetsAPI.isSignedIn) {
        statusEl.innerHTML = '<span style="color: #f59e0b;">‚ö†Ô∏è Please sign in with Google first</span>';
        return;
      }

      statusEl.innerHTML = '<span style="color: #3b82f6;">üîÑ Testing connection...</span>';

      try {
        // First get sheet metadata
        console.log('[Sheets] Fetching sheet metadata...');
        const response = await gapi.client.sheets.spreadsheets.get({
          spreadsheetId: sheetId
        });

        const sheetTitle = response.result.properties.title;
        const sheets = response.result.sheets.map(s => s.properties.title);
        console.log('[Sheets] Found sheets:', sheets);

        const requiredSheets = ['Samples', 'Fields', 'Settings'];
        const missingSheets = requiredSheets.filter(s => !sheets.includes(s));

        if (missingSheets.length > 0) {
          console.log('[Sheets] Missing required tabs:', missingSheets);
          statusEl.innerHTML = `<span style="color: #f59e0b;">‚ö†Ô∏è Connected but missing tabs: ${missingSheets.join(', ')}<br><small>Please create these tabs in your Google Sheet</small></span>`;
        } else {
          // Try to read samples to get count
          console.log('[Sheets] Reading samples tab...');
          let sampleCount = 0;
          try {
            const samplesResponse = await gapi.client.sheets.spreadsheets.values.get({
              spreadsheetId: sheetId,
              range: 'Samples!A:A'
            });
            const rows = samplesResponse.result.values || [];
            sampleCount = Math.max(0, rows.length - 1); // Subtract header row
            console.log('[Sheets] Found', sampleCount, 'samples');
          } catch (sampleErr) {
            console.log('[Sheets] Could not read samples (tab may be empty):', sampleErr.message);
          }

          const sampleText = sampleCount > 0 ? `Found ${sampleCount} samples` : 'No samples yet';
          statusEl.innerHTML = `<span style="color: #22c55e;">‚úÖ Connected successfully - ${sampleText}<br><small>Sheet: ${sheetTitle}</small></span>`;
        }
      } catch (e) {
        console.error('[Sheets] Connection test failed:', e);
        if (e.status === 404) {
          statusEl.innerHTML = '<span style="color: #ef4444;">‚ùå Sheet not found. Check the Sheet ID.</span>';
        } else if (e.status === 403) {
          statusEl.innerHTML = '<span style="color: #ef4444;">‚ùå Access denied. Make sure you have access to this sheet.</span>';
        } else {
          statusEl.innerHTML = `<span style="color: #ef4444;">‚ùå Connection failed: ${e.message || 'Unknown error'}</span>`;
        }
      }
    }
    
    function saveSettings() { const settings = {}; Object.keys(defaults).forEach(k => { const i = document.getElementById(k); if (i) settings[k] = parseFloat(i.value) || defaults[k]; }); localStorage.setItem('soilSettings', JSON.stringify(settings)); showStatus('‚úì Settings saved', true); }
    function resetSettings() { if (!confirm('Reset all settings to defaults?')) return; Object.entries(defaults).forEach(([k, v]) => { const i = document.getElementById(k); if (i) i.value = v; }); localStorage.setItem('soilSettings', JSON.stringify(defaults)); showStatus('‚úì Settings reset', true); }
    // Use shared showStatus from Utils
    const showStatus = window.Utils.showStatus;

    function updateBackupFooter() {
      const backupTime = localStorage.getItem('soilDataBackupTime');
      const footer = document.getElementById('backupFooter');
      const buildDate = new Date(BUILD_DATE);
      const buildStr = buildDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ', ' +
                       buildDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      const versionInfo = `App ${APP_VERSION} ‚Ä¢ Built: ${buildStr}`;
      const legalLinks = `<span style="margin: 0 0.5rem; color: #cbd5e1;">|</span> <a href="privacy-policy.html" style="color: #94a3b8; text-decoration: none;">Privacy</a> <span style="color: #cbd5e1;">¬∑</span> <a href="terms-of-service.html" style="color: #94a3b8; text-decoration: none;">Terms</a>`;

      const sampleData = JSON.parse(localStorage.getItem('soilSamples') || '[]');

      if (backupTime) {
        const date = new Date(parseInt(backupTime));
        const backupStr = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        footer.innerHTML = `${versionInfo} <span style="margin: 0 0.5rem; color: #cbd5e1;">|</span> <span style="color: #22c55e;">Data backup: ${backupStr}</span>${legalLinks}`;
      } else if (sampleData.length === 0) {
        // No data yet - don't show backup warning
        footer.innerHTML = versionInfo + legalLinks;
      } else {
        // Has data but no backup - show warning
        footer.innerHTML = `${versionInfo} <span style="margin: 0 0.5rem; color: #cbd5e1;">|</span> <span style="color: #f59e0b;">No backup yet</span>${legalLinks}`;
      }
    }
  </script>
  <div class="backup-footer" id="backupFooter"></div>
</body>
</html>
