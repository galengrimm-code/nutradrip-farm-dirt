<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soil Sample Analysis - Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; color: #1e293b; }
    .app-container { display: flex; flex-direction: column; height: 100vh; }
    .top-bar { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .top-bar h1 { font-size: 1.5rem; font-weight: 700; }
    .top-bar p { font-size: 0.875rem; opacity: 0.8; margin-top: 0.25rem; }
    .nav-links { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .nav-link { padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); color: white; text-decoration: none; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; transition: background 0.2s; }
    .nav-link:hover { background: rgba(255,255,255,0.2); }
    .nav-link.active { background: #3b82f6; }
    .auth-section { display: flex; align-items: center; gap: 1rem; }
    .user-info { font-size: 0.875rem; color: rgba(255,255,255,0.9); }
    .sign-in-btn { padding: 0.5rem 1rem; background: #4285f4; color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; }
    .sign-in-btn:hover { background: #3367d6; }
    .sign-in-btn.signed-in { background: #22c55e; }
    .sign-in-btn.signed-in:hover { background: #16a34a; }
    .controls-bar { background: white; border-bottom: 1px solid #e2e8f0; padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .controls-left, .controls-right { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .control-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .control-group label { font-size: 0.6875rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
    select, input[type="text"], input[type="number"] { padding: 0.5rem 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-size: 0.875rem; background: white; min-width: 120px; }
    select:focus, input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .button { padding: 0.5rem 1rem; border: 1px solid #cbd5e1; border-radius: 0.375rem; background: white; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
    .button:hover { background: #f1f5f9; border-color: #94a3b8; }
    .button.active { background: #3b82f6; color: white; border-color: #3b82f6; }
    .toggle-group { display: flex; border: 1px solid #cbd5e1; border-radius: 0.375rem; overflow: hidden; }
    .toggle-btn { padding: 0.5rem 1rem; background: white; border: none; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
    .toggle-btn:not(:last-child) { border-right: 1px solid #cbd5e1; }
    .toggle-btn:hover { background: #f1f5f9; }
    .toggle-btn.active { background: #3b82f6; color: white; }
    .legend { background: white; border-bottom: 1px solid #e2e8f0; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; }
    .legend-label { font-weight: 600; color: #64748b; }
    .main-content { display: flex; flex-direction: column; flex: 1; }
    #map { flex: 1; min-height: 500px; }
    .sample-marker { border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    #statusMessage { display: none; position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 9999; max-width: 90%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 0.75rem 1rem; border-radius: 0.375rem; }
    .field-mode .sample-marker { min-width: 44px !important; min-height: 44px !important; font-size: 14px !important; }
    .field-mode .controls-left { display: none; }
    .field-mode .legend { display: none; }
    @media (max-width: 639px) {
      .top-bar { padding: 0.75rem 1rem; }
      .top-bar h1 { font-size: 1.125rem; }
      .top-bar p { display: none; }
      .controls-bar { flex-direction: column; gap: 0.5rem; padding: 0.5rem; }
      .controls-left, .controls-right { width: 100%; justify-content: space-between; }
      .nav-links { width: 100%; justify-content: center; }
      select, input { font-size: 16px !important; }
      .legend { padding: 0.25rem 0.5rem; font-size: 0.625rem; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="top-bar">
      <div>
        <h1>üå± Soil Sample Analysis</h1>
        <p>Precision Farms Field Management</p>
      </div>
      <nav class="nav-links">
        <a href="index.html" class="nav-link active">üìç Map</a>
        <a href="analysis.html" class="nav-link">üìä Analysis</a>
        <a href="import.html" class="nav-link">üìÅ Import</a>
        <a href="settings.html" class="nav-link">‚öôÔ∏è Settings</a>
      </nav>
      <div class="auth-section">
        <span class="user-info" id="userInfo"></span>
        <button class="sign-in-btn" id="authBtn" onclick="handleAuth()">Sign In with Google</button>
      </div>
    </div>
    
    <div class="controls-bar">
      <div class="controls-left">
        <div class="control-group">
          <label>FIELD</label>
          <select id="fieldSelect"><option value="all">All Fields</option></select>
        </div>
        <div class="control-group">
          <label>ATTRIBUTE</label>
          <select id="attributeSelect">
            <option value="P">Phosphorus (P)</option>
            <option value="pH">pH</option>
            <option value="K">Potassium (K)</option>
            <option value="OM">Organic Matter</option>
            <option value="Ca_sat">Calcium %</option>
            <option value="Mg_sat">Magnesium %</option>
            <option value="K_Sat">K Base Sat %</option>
            <option value="H_Sat">H Base Sat %</option>
            <option value="Zn">Zinc</option>
            <option value="Cu">Copper</option>
            <option value="Mn">Manganese</option>
            <option value="Fe">Iron</option>
            <option value="Boron">Boron</option>
            <option value="S">Sulfur</option>
          </select>
        </div>
        <div class="control-group">
          <label>YEAR</label>
          <select id="yearSelect"><option value="all">All Years</option></select>
        </div>
        <div class="control-group">
          <label>VIEW MODE</label>
          <div class="toggle-group">
            <button class="toggle-btn active" id="pointViewBtn">Point Detail</button>
            <button class="toggle-btn" id="fieldViewBtn">Field Average</button>
          </div>
        </div>
      </div>
      <div class="controls-right">
        <button class="button" id="fieldModeBtn">üì± Field Mode</button>
        <button class="button" id="refreshBtn">üîÑ Refresh</button>
      </div>
    </div>
    
    <div class="legend">
      <span class="legend-label">Legend:</span>
      <div style="width: 100px; height: 16px; background: linear-gradient(to right, #ef4444, #eab308, #22c55e); border-radius: 8px; border: 1px solid #cbd5e1;"></div>
      <span>Low ‚Üí High</span>
    </div>
    
    <div class="main-content">
      <div id="map"></div>
    </div>
    
    <div id="statusMessage"></div>
  </div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    // ========== CONFIG ==========
    const CONFIG = {
      CLIENT_ID: '714780458094-9rde31taeottmavhl5t0uo8b9kfpergc.apps.googleusercontent.com',
      API_KEY: 'AIzaSyCOSDbrAlc3ct2-lRvJv1y7V0nV7haWc9E',
      SHEET_ID: '1buu-8KXoM1kRJSOAWtHaAk40seQT5kqGFY9RICYwdRY',
      DEFAULT_LAT: 39.8528,
      DEFAULT_LON: -95.5347,
      DEFAULT_ZOOM: 13,
      NUTRIENT_NAMES: {
        pH: 'pH', OM: 'Organic Matter', P: 'Phosphorus (P)', K: 'Potassium (K)',
        Ca_sat: 'Calcium Base Sat', Mg_sat: 'Magnesium Base Sat', K_Sat: 'Potassium Base Sat', H_Sat: 'Hydrogen Base Sat',
        Zn: 'Zinc', Cu: 'Copper', Mn: 'Manganese', Fe: 'Iron', Boron: 'Boron', S: 'Sulfur'
      },
      NUTRIENT_UNITS: {
        pH: '', OM: '%', P: 'ppm', K: 'ppm', Ca_sat: '%', Mg_sat: '%', K_Sat: '%', H_Sat: '%',
        Zn: 'ppm', Cu: 'ppm', Mn: 'ppm', Fe: 'ppm', Boron: 'ppm', S: 'ppm'
      },
      LOWER_IS_BETTER: ['Mg_sat', 'H_Sat']
    };

    // ========== SHEETS API ==========
    let tokenClient;
    let accessToken = null;
    
    const SheetsAPI = {
      isInitialized: false,
      isSignedIn: false,
      SHEETS: { FIELDS: 'Fields', SAMPLES: 'Samples', SETTINGS: 'Settings' },
      
      async init() {
        return new Promise((resolve, reject) => {
          // Load the Google API client library
          gapi.load('client', async () => {
            try {
              await gapi.client.init({
                apiKey: CONFIG.API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
              });
              this.isInitialized = true;
              
              // Initialize the token client for Google Identity Services
              tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (response) => {
                  if (response.error) {
                    console.error('Token error:', response);
                    return;
                  }
                  accessToken = response.access_token;
                  this.isSignedIn = true;
                  this.onSignInChange(true);
                },
              });
              
              resolve(true);
            } catch (error) {
              console.error('Error initializing Google API:', error);
              reject(error);
            }
          });
        });
      },
      
      async signIn() { 
        tokenClient.requestAccessToken({ prompt: 'consent' }); 
      },
      async signOut() { 
        if (accessToken) {
          google.accounts.oauth2.revoke(accessToken);
          accessToken = null;
        }
        this.isSignedIn = false;
        this.onSignInChange(false);
      },
      onSignInChange(isSignedIn) { console.log('Sign-in state:', isSignedIn); },
      
      async getFields() {
        try {
          const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SHEET_ID,
            range: `${this.SHEETS.FIELDS}!A2:E1000`
          });
          const rows = response.result.values || [];
          return rows.map(row => ({
            id: row[0], name: row[1],
            boundary: row[2] ? JSON.parse(row[2]) : null,
            acres: parseFloat(row[3]) || 0
          }));
        } catch (e) { console.error(e); return []; }
      },
      
      async getSamples() {
        try {
          const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SHEET_ID,
            range: `${this.SHEETS.SAMPLES}!A1:ZZ10000`
          });
          const rows = response.result.values || [];
          if (rows.length < 2) return [];
          const headers = rows[0];
          const samples = [];
          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const sample = {};
            headers.forEach((header, idx) => {
              const value = row[idx];
              if (header !== 'sampleId' && header !== 'field' && value) {
                const num = parseFloat(value);
                sample[header] = isNaN(num) ? value : num;
              } else {
                sample[header] = value || '';
              }
            });
            samples.push(sample);
          }
          return samples;
        } catch (e) { console.error(e); return []; }
      },
      
      async getSettings() {
        try {
          const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: CONFIG.SHEET_ID,
            range: `${this.SHEETS.SETTINGS}!A2:D100`
          });
          const rows = response.result.values || [];
          const settings = {};
          rows.forEach(row => {
            settings[row[0]] = { min: parseFloat(row[1]) || null, target: parseFloat(row[2]) || null, max: parseFloat(row[3]) || null };
          });
          return settings;
        } catch (e) { console.error(e); return {}; }
      }
    };

    // ========== UTILS ==========
    const Utils = {
      showStatus(message, isSuccess = true) {
        const el = document.getElementById('statusMessage');
        if (!el) return;
        el.textContent = message;
        el.style.display = 'block';
        el.style.background = isSuccess ? '#dcfce7' : '#fee2e2';
        el.style.color = isSuccess ? '#166534' : '#991b1b';
        setTimeout(() => el.style.display = 'none', 4000);
      },
      
      getColor(value, attribute, settings = {}, bufferPercent = 25) {
        // Default thresholds if none provided
        const defaultThresholds = {
          pH: { min: 6.3, max: 6.9 },
          P: { min: 20, max: null },
          K: { min: 150, max: null },
          OM: { min: 3.0, max: null },
          Ca_sat: { min: 65, max: 75 },
          Mg_sat: { min: null, max: 15 },
          K_Sat: { min: 3.0, max: null },
          H_Sat: { min: null, max: 5.0 }
        };
        
        const threshold = settings[attribute] || defaultThresholds[attribute];
        const red = '#ef4444', yellow = '#eab308', green = '#22c55e';
        
        if (!threshold) {
          // Gradient for nutrients without thresholds (Zn, Cu, Mn, Fe, Boron, S)
          const ranges = {
            Zn: [1, 3], Cu: [0.5, 2], Mn: [10, 30], Fe: [20, 60], Boron: [0.5, 1.5], S: [8, 15]
          };
          const range = ranges[attribute];
          if (range) {
            if (value >= range[1]) return green;
            if (value >= range[0]) return yellow;
            return red;
          }
          return '#94a3b8';
        }
        if (threshold.min !== null && threshold.max !== null) {
          if (value >= threshold.min && value <= threshold.max) return green;
          const buffer = (threshold.max - threshold.min) * (bufferPercent / 100);
          if (value < threshold.min) return (threshold.min - value) > buffer ? red : yellow;
          return (value - threshold.max) > buffer ? red : yellow;
        } else if (threshold.min !== null) {
          const buffer = threshold.min * (bufferPercent / 100);
          if (value >= threshold.min) return green;
          return value >= threshold.min - buffer ? yellow : red;
        } else if (threshold.max !== null) {
          const buffer = threshold.max * (bufferPercent / 100);
          if (value <= threshold.max) return green;
          return value <= threshold.max + buffer ? yellow : red;
        }
        return '#94a3b8';
      },
      
      formatNumber(value, decimals = 1) {
        if (value === null || value === undefined || isNaN(value)) return '-';
        return Number(value).toFixed(decimals);
      },
      
      getUniqueYears(samples) {
        return [...new Set(samples.map(s => s.year).filter(y => y))].sort();
      },
      
      getUniqueFields(samples) {
        return [...new Set(samples.map(s => s.field).filter(f => f))].sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
      },
      
      groupByField(samples) {
        const groups = {};
        samples.forEach(s => {
          const f = s.field || 'Unknown';
          if (!groups[f]) groups[f] = [];
          groups[f].push(s);
        });
        return groups;
      },
      
      calculateFieldAverage(samples, nutrient) {
        const values = samples.map(s => s[nutrient]).filter(v => v !== undefined && v !== null && !isNaN(v));
        if (values.length === 0) return null;
        return values.reduce((a, b) => a + b, 0) / values.length;
      }
    };

    // ========== APP STATE ==========
    let map;
    let sampleData = [];
    let fieldBoundaries = {};
    let settings = {};
    let currentLayers = [];
    let selectedField = 'all';
    let selectedAttribute = 'P';
    let selectedYear = 'all';
    let viewMode = 'point';
    let fieldModeActive = false;
    let gpsMarker = null, gpsCircle = null, gpsWatchId = null;

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', async () => {
      initMap();
      try {
        await SheetsAPI.init();
        SheetsAPI.onSignInChange = handleSignInChange;
        handleSignInChange(SheetsAPI.isSignedIn);
      } catch (e) {
        console.warn('Google API init error:', e);
        Utils.showStatus('Configure Google API to enable cloud sync', false);
      }
      setupEventListeners();
      loadLocalData();
    });

    function initMap() {
      map = L.map('map').setView([CONFIG.DEFAULT_LAT, CONFIG.DEFAULT_LON], CONFIG.DEFAULT_ZOOM);
      const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap', maxZoom: 19 });
      const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '¬© Esri', maxZoom: 19 });
      street.addTo(map);
      L.control.layers({ "Street": street, "Satellite": satellite }).addTo(map);
    }

    function setupEventListeners() {
      document.getElementById('fieldSelect').addEventListener('change', (e) => { selectedField = e.target.value; updateMap(); zoomToField(selectedField); });
      document.getElementById('attributeSelect').addEventListener('change', (e) => { selectedAttribute = e.target.value; updateMap(); });
      document.getElementById('yearSelect').addEventListener('change', (e) => { selectedYear = e.target.value; updateMap(); });
      document.getElementById('pointViewBtn').addEventListener('click', () => { viewMode = 'point'; document.getElementById('pointViewBtn').classList.add('active'); document.getElementById('fieldViewBtn').classList.remove('active'); updateMap(); });
      document.getElementById('fieldViewBtn').addEventListener('click', () => { viewMode = 'field'; document.getElementById('fieldViewBtn').classList.add('active'); document.getElementById('pointViewBtn').classList.remove('active'); updateMap(); });
      document.getElementById('fieldModeBtn').addEventListener('click', toggleFieldMode);
      document.getElementById('refreshBtn').addEventListener('click', loadData);
    }

    async function handleAuth() {
      if (SheetsAPI.isSignedIn) await SheetsAPI.signOut();
      else await SheetsAPI.signIn();
    }

    function handleSignInChange(isSignedIn) {
      const authBtn = document.getElementById('authBtn');
      const userInfo = document.getElementById('userInfo');
      if (isSignedIn) {
        userInfo.textContent = 'Connected';
        authBtn.textContent = '‚úì Signed In';
        authBtn.classList.add('signed-in');
        loadData();
      } else {
        userInfo.textContent = '';
        authBtn.textContent = 'Sign In with Google';
        authBtn.classList.remove('signed-in');
      }
    }

    async function loadData() {
      if (!SheetsAPI.isSignedIn) { loadLocalData(); return; }
      Utils.showStatus('Loading from Google Sheets...', true);
      try {
        const fields = await SheetsAPI.getFields();
        fieldBoundaries = {};
        fields.forEach(f => { if (f.boundary) fieldBoundaries[f.name] = f.boundary; });
        sampleData = await SheetsAPI.getSamples();
        settings = await SheetsAPI.getSettings();
        updateFieldSelector();
        updateYearSelector();
        updateMap();
        saveLocalData();
        Utils.showStatus(`‚úì Loaded ${sampleData.length} samples, ${Object.keys(fieldBoundaries).length} fields`, true);
      } catch (e) {
        console.error(e);
        Utils.showStatus('Error loading from Sheets', false);
        loadLocalData();
      }
    }

    function loadLocalData() {
      try {
        const s = localStorage.getItem('soilSamples');
        const b = localStorage.getItem('fieldBoundaries');
        const st = localStorage.getItem('soilSettings');
        if (s) sampleData = JSON.parse(s);
        if (b) fieldBoundaries = JSON.parse(b);
        if (st) {
          const rawSettings = JSON.parse(st);
          // Convert flat settings (pH_min, pH_max) to nested format ({pH: {min, max}})
          settings = {
            pH: { min: rawSettings.pH_min || 6.3, max: rawSettings.pH_max || 6.9 },
            P: { min: rawSettings.P_min || 20, max: null },
            K: { min: rawSettings.K_min || 150, max: null },
            OM: { min: rawSettings.OM_min || 3.0, max: null },
            Ca_sat: { min: rawSettings.Ca_sat_min || 65, max: rawSettings.Ca_sat_max || 75 },
            Mg_sat: { min: rawSettings.Mg_sat_min || null, max: rawSettings.Mg_sat_max || 15 },
            K_Sat: { min: rawSettings.K_sat_min || 3.0, max: null },
            H_Sat: { min: null, max: rawSettings.H_sat_max || 5.0 },
            bufferPercent: rawSettings.bufferPercent || 25
          };
        }
        updateFieldSelector();
        updateYearSelector();
        updateMap();
        if (sampleData.length > 0) Utils.showStatus(`Loaded ${sampleData.length} samples from local storage`, true);
      } catch (e) { console.error(e); }
    }

    function saveLocalData() {
      try {
        localStorage.setItem('soilSamples', JSON.stringify(sampleData));
        localStorage.setItem('fieldBoundaries', JSON.stringify(fieldBoundaries));
        localStorage.setItem('soilSettings', JSON.stringify(settings));
      } catch (e) { console.error(e); }
    }

    function updateFieldSelector() {
      const sel = document.getElementById('fieldSelect');
      const val = sel.value;
      sel.innerHTML = '<option value="all">All Fields</option>';
      const fields = [...new Set([...Utils.getUniqueFields(sampleData), ...Object.keys(fieldBoundaries)])].sort((a,b) => a.localeCompare(b, undefined, {numeric:true}));
      fields.forEach(f => { const o = document.createElement('option'); o.value = f; o.textContent = f; sel.appendChild(o); });
      if (fields.includes(val)) sel.value = val;
    }

    function updateYearSelector() {
      const sel = document.getElementById('yearSelect');
      const val = sel.value;
      sel.innerHTML = '<option value="all">All Years</option>';
      Utils.getUniqueYears(sampleData).forEach(y => { const o = document.createElement('option'); o.value = y; o.textContent = y; sel.appendChild(o); });
      if (Utils.getUniqueYears(sampleData).includes(parseInt(val))) sel.value = val;
    }

    function updateMap() {
      currentLayers.forEach(l => map.removeLayer(l));
      currentLayers = [];
      
      // Draw boundaries
      Object.entries(fieldBoundaries).forEach(([name, polys]) => {
        if (selectedField !== 'all' && selectedField !== name) return;
        const arr = Array.isArray(polys[0]?.[0]) ? polys : [polys];
        arr.forEach(coords => {
          const poly = L.polygon(coords, { color: '#22c55e', weight: 3, fillOpacity: 0.1, fillColor: '#22c55e' }).addTo(map);
          poly.bindTooltip(name, { permanent: false, direction: 'center' });
          currentLayers.push(poly);
        });
      });
      
      // Filter samples
      let filtered = sampleData.filter(s => {
        if (selectedField !== 'all' && s.field !== selectedField) return false;
        if (selectedYear !== 'all' && String(s.year) !== String(selectedYear)) return false;
        return true;
      });
      
      if (viewMode === 'point') {
        filtered.forEach(sample => {
          const value = sample[selectedAttribute];
          if (value === undefined || value === null) return;
          const bufferPct = settings.bufferPercent || 25;
          const color = Utils.getColor(value, selectedAttribute, settings, bufferPct);
          const size = fieldModeActive ? 44 : 32;
          const fontSize = fieldModeActive ? 14 : 11;
          const displayVal = Utils.formatNumber(value, selectedAttribute === 'pH' ? 1 : 0);
          const icon = L.divIcon({
            html: `<div class="sample-marker" style="width:${size}px;height:${size}px;background:${color};font-size:${fontSize}px;line-height:${size}px;">${displayVal}</div>`,
            className: '', iconSize: [size, size], iconAnchor: [size/2, size/2]
          });
          const marker = L.marker([sample.lat, sample.lon], { icon }).addTo(map);
          marker.bindPopup(`<strong>Sample ${sample.sampleId || ''}</strong><br>Field: ${sample.field || 'Unknown'}<br>Year: ${sample.year || ''}<br>${CONFIG.NUTRIENT_NAMES[selectedAttribute]}: ${displayVal} ${CONFIG.NUTRIENT_UNITS[selectedAttribute]}`);
          currentLayers.push(marker);
        });
      } else {
        const groups = Utils.groupByField(filtered);
        Object.entries(groups).forEach(([fieldName, samples]) => {
          const avg = Utils.calculateFieldAverage(samples, selectedAttribute);
          if (avg === null) return;
          const bufferPct = settings.bufferPercent || 25;
          const color = Utils.getColor(avg, selectedAttribute, settings, bufferPct);
          let center;
          if (fieldBoundaries[fieldName]) {
            const polys = fieldBoundaries[fieldName];
            const allPts = Array.isArray(polys[0]?.[0]) ? polys.flat() : polys;
            const lats = allPts.map(p => p[0]), lons = allPts.map(p => p[1]);
            center = [(Math.min(...lats)+Math.max(...lats))/2, (Math.min(...lons)+Math.max(...lons))/2];
          } else {
            const lats = samples.map(s => s.lat), lons = samples.map(s => s.lon);
            center = [(Math.min(...lats)+Math.max(...lats))/2, (Math.min(...lons)+Math.max(...lons))/2];
          }
          const displayVal = Utils.formatNumber(avg, 1);
          const icon = L.divIcon({
            html: `<div class="sample-marker" style="width:60px;height:60px;background:${color};font-size:16px;line-height:60px;">${displayVal}</div>`,
            className: '', iconSize: [60,60], iconAnchor: [30,30]
          });
          const marker = L.marker(center, { icon }).addTo(map);
          marker.bindPopup(`<strong>${fieldName}</strong><br>Avg ${CONFIG.NUTRIENT_NAMES[selectedAttribute]}: ${displayVal}`);
          currentLayers.push(marker);
        });
      }
    }

    function zoomToField(fieldName) {
      if (fieldName === 'all') {
        const allCoords = [];
        Object.values(fieldBoundaries).forEach(p => { const a = Array.isArray(p[0]?.[0]) ? p.flat() : p; allCoords.push(...a); });
        sampleData.forEach(s => allCoords.push([s.lat, s.lon]));
        if (allCoords.length > 0) map.fitBounds(allCoords, { padding: [50,50] });
      } else if (fieldBoundaries[fieldName]) {
        const p = fieldBoundaries[fieldName];
        const a = Array.isArray(p[0]?.[0]) ? p.flat() : p;
        map.fitBounds(a, { padding: [50,50] });
      }
    }

    function toggleFieldMode() {
      fieldModeActive = !fieldModeActive;
      const btn = document.getElementById('fieldModeBtn');
      if (fieldModeActive) {
        btn.classList.add('active');
        btn.textContent = 'üì± Field Mode ON';
        document.body.classList.add('field-mode');
        startGPS();
      } else {
        btn.classList.remove('active');
        btn.textContent = 'üì± Field Mode';
        document.body.classList.remove('field-mode');
        stopGPS();
      }
      updateMap();
    }

    function startGPS() {
      if (!navigator.geolocation) { Utils.showStatus('GPS not supported', false); return; }
      gpsWatchId = navigator.geolocation.watchPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          if (gpsMarker) { gpsMarker.setLatLng([latitude, longitude]); gpsCircle.setLatLng([latitude, longitude]); gpsCircle.setRadius(accuracy); }
          else {
            gpsMarker = L.marker([latitude, longitude], { icon: L.divIcon({ html: '<div style="width:20px;height:20px;background:#3b82f6;border:3px solid white;border-radius:50%;box-shadow:0 0 10px rgba(59,130,246,0.5);"></div>', className: '', iconSize: [20,20], iconAnchor: [10,10] }) }).addTo(map);
            gpsCircle = L.circle([latitude, longitude], { radius: accuracy, color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.15, weight: 2 }).addTo(map);
          }
          map.setView([latitude, longitude], map.getZoom());
        },
        (e) => Utils.showStatus('GPS error: ' + e.message, false),
        { enableHighAccuracy: true, maximumAge: 5000 }
      );
    }

    function stopGPS() {
      if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; }
      if (gpsMarker) { map.removeLayer(gpsMarker); map.removeLayer(gpsCircle); gpsMarker = null; gpsCircle = null; }
    }
  </script>
</body>
</html>
